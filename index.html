<!DOCTYPE html>
<html lang="nl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gesprekstafel Boekingssysteem</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>📅</text></svg>" />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        background: #f8f9fa;
        min-height: 100vh;
        padding: 20px;
        color: #333;
        line-height: 1.5;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        border-radius: 8px;
        padding: 40px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      h1 {
        text-align: center;
        margin-bottom: 20px;
        color: #2c3e50;
        font-size: 1.8rem;
        font-weight: 500;
      }

      h2 {
        text-align: center;
        margin-bottom: 30px;
        color: #34495e;
        font-size: 1.3rem;
        font-weight: 500;
        border-bottom: 1px solid #ecf0f1;
        padding-bottom: 30px;
      }

      h3 {
        margin-bottom: 15px;
        color: #2c3e50;
        font-size: 1.1rem;
        font-weight: 500;
      }

      .section {
        margin-bottom: 30px;
        padding: 20px;
        background: #fafbfc;
        border-radius: 6px;
        border: 1px solid #e1e8ed;
      }

      .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
      }

      .form-group {
        display: flex;
        flex-direction: column;
      }

      label {
        margin-bottom: 5px;
        font-weight: 500;
        color: #555;
        font-size: 0.9rem;
      }

      input, select, button {
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 0.9rem;
        transition: border-color 0.2s ease;
      }

      input:focus, select:focus {
        outline: none;
        border-color: #3498db;
      }

      button {
        background: #3498db;
        color: white;
        border: none;
        cursor: pointer;
        font-weight: 500;
        transition: background-color 0.2s ease;
      }

      button:hover {
        background: #2980b9;
      }

      button:disabled {
        background: #bdc3c7;
        cursor: not-allowed;
      }

      .btn-secondary {
        background: #95a5a6;
      }

      .btn-secondary:hover {
        background: #7f8c8d;
      }

      .btn-danger {
        background: #e74c3c;
      }

      .btn-danger:hover {
        background: #c0392b;
      }

      .btn-success {
        background: #27ae60;
      }

      .btn-success:hover {
        background: #229954;
      }

      .admin-access-btn {
        position: fixed;
        bottom: 20px;
        right: 20px;
        width: 40px;
        height: 40px;
        background: #95a5a6;
        border: none;
        border-radius: 50%;
        cursor: pointer;
        font-size: 14px;
        color: white;
        transition: background-color 0.2s ease;
        z-index: 100;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
      }

      .admin-access-btn:hover {
        background: #7f8c8d;
      }

      .client-booking-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
        gap: 20px;
        margin-top: 20px;
      }

      .client-table-card {
        background: white;
        border-radius: 6px;
        padding: 20px;
        border: 1px solid #e1e8ed;
        transition: box-shadow 0.2s ease;
      }

      .client-table-card:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }

      .table-header {
        text-align: center;
        margin-bottom: 15px;
        padding-bottom: 15px;
        border-bottom: 1px solid #ecf0f1;
      }

      .table-title {
        font-size: 1.1rem;
        font-weight: 500;
        color: #2c3e50;
        margin-bottom: 5px;
      }

      .speakers {
        font-size: 0.9rem;
        color: #7f8c8d;
      }

      .time-slots-container {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .time-slot-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 10px 12px;
        border-radius: 4px;
        border: 1px solid #ddd;
        transition: all 0.2s ease;
      }

      .time-slot-item.available {
        background: #f8fff9;
        border-color: #27ae60;
      }

      .time-slot-item.available:hover {
        background: #e8f5e8;
      }

      .time-slot-item.booked {
        background: #fdf2f2;
        border-color: #e74c3c;
      }

      .time-info {
        font-weight: 500;
        color: #2c3e50;
        font-size: 0.9rem;
      }

      .slot-btn {
        padding: 6px 12px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-weight: 500;
        font-size: 0.8rem;
        transition: background-color 0.2s ease;
      }

      .slot-btn.available {
        background: #27ae60;
        color: white;
      }

      .slot-btn.available:hover {
        background: #229954;
      }

      .slot-btn.booked {
        background: #bdc3c7;
        color: #7f8c8d;
        cursor: not-allowed;
      }

      .modal {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        padding: 25px;
        border-radius: 6px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        z-index: 1000;
        min-width: 350px;
        max-width: 500px;
      }

      .overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 999;
      }

      .close-btn {
        position: absolute;
        top: 10px;
        right: 10px;
        background: none;
        border: none;
        font-size: 18px;
        cursor: pointer;
        color: #7f8c8d;
      }

      .status-message {
        padding: 10px;
        border-radius: 4px;
        margin-top: 10px;
        text-align: center;
        font-size: 0.9rem;
      }

      .success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }

      .error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }

      .warning {
        background: #fff3cd;
        color: #856404;
        border: 1px solid #ffeaa7;
      }

      .nav-tabs {
        display: flex;
        margin-bottom: 20px;
        border-bottom: 1px solid #dee2e6;
      }

      .nav-tab {
        padding: 10px 20px;
        background: none;
        border: none;
        border-bottom: 2px solid transparent;
        cursor: pointer;
        font-weight: 500;
        color: #6c757d;
        transition: all 0.2s ease;
      }

      .nav-tab.active {
        color: #3498db;
        border-bottom-color: #3498db;
      }

      .nav-tab:hover {
        color: #3498db;
      }

      .tab-content {
        display: none;
      }

      .tab-content.active {
        display: block;
      }

      .admin-interface {
        display: none;
      }

      .client-interface {
        display: block;
      }

      .tables-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 15px;
        margin-top: 20px;
      }

      .table-card {
        padding: 15px;
        border: 1px solid #e1e8ed;
        border-radius: 6px;
        background: white;
      }

      .bookings-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
        font-size: 0.9rem;
      }

      .bookings-table th,
      .bookings-table td {
        padding: 10px;
        border: 1px solid #dee2e6;
        text-align: left;
      }

      .bookings-table th {
        background: #f8f9fa;
        font-weight: 500;
      }

      .bookings-table tr:nth-child(even) {
        background: #f8f9fa;
      }

      .event-info {
        text-align: center;
        margin-bottom: 20px;
        color: #6c757d;
        font-size: 0.95rem;
      }

      .booking-actions {
        display: flex;
        gap: 10px;
        margin-top: 15px;
      }

      .confirmation-details {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 4px;
        margin: 15px 0;
        border: 1px solid #e9ecef;
      }

      .email-preview {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 4px;
        margin-top: 15px;
        border: 1px solid #e9ecef;
      }

      .hidden {
        display: none;
      }

      .admin-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }

      .admin-user-info {
        display: flex;
        align-items: center;
        gap: 15px;
        color: #666;
        font-size: 0.9rem;
      }

      .connection-status {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.7rem;
        font-weight: 400;
        z-index: 200;
        transition: all 0.3s ease;
        opacity: 0.7;
      }

      .connection-status.connected {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }

      .connection-status.disconnected {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }

      .sync-indicator {
        display: inline-block;
        width: 6px;
        height: 6px;
        border-radius: 50%;
        margin-right: 6px;
        animation: pulse 2s infinite;
      }

      .sync-indicator.syncing {
        background: #ffc107;
      }

      .sync-indicator.synced {
        background: #28a745;
      }

      @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.5; }
        100% { opacity: 1; }
      }

      .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.9);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 2000;
        font-size: 1.2rem;
        color: #666;
      }

      .firebase-config-section {
        background: #e8f5e8;
        border: 1px solid #b3d4fc;
        padding: 15px;
        border-radius: 4px;
        margin-bottom: 20px;
      }

      .firebase-config-section h3 {
        color: #155724;
        margin-bottom: 10px;
      }

      .config-actions {
        display: flex;
        gap: 10px;
      }

      .user-management {
        background: #fff3cd;
        border: 1px solid #ffeaa7;
        padding: 15px;
        border-radius: 4px;
        margin-bottom: 20px;
      }

      .user-management h3 {
        color: #856404;
        margin-bottom: 10px;
      }

      .auth-form {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        margin-bottom: 15px;
      }

      .auth-actions {
        display: flex;
        gap: 10px;
        align-items: center;
      }
    </style>
  </head>
  <body>
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
      <div>
        <div class="sync-indicator syncing"></div>
        Laden...
      </div>
    </div>

    <!-- Connection Status -->
    <div id="connectionStatus" class="connection-status disconnected">
      <span class="sync-indicator syncing"></span>○
    </div>

    <div class="container">
      <!-- CLIENT INTERFACE -->
      <div id="client-interface" class="client-interface">
        <h1>Ostend Is Music Sectordag 2025</h1>
        <h2>Expertenhub: boek je gesprekstafel(s)!</h2>
        <div class="event-info" id="eventInfo">Evenement informatie wordt geladen...</div>
        <div class="client-booking-grid" id="clientBookingGrid">
          Beschikbare tijdslots worden geladen...
        </div>
      </div>

      <!-- ADMIN ACCESS BUTTON -->
      <button class="admin-access-btn" onclick="showLoginModal()" title="Admin Toegang">⚙</button>

      <!-- ADMIN INTERFACE -->
      <div id="admin-interface" class="admin-interface">
        <div class="admin-header">
          <h1>Admin Dashboard</h1>
          <div class="admin-user-info">
            <span id="adminUserEmail"></span>
            <button onclick="logout()" class="btn-secondary">Uitloggen</button>
            <button onclick="switchToClient()" class="btn-secondary">Terug naar Boekingen</button>
          </div>
        </div>

        <!-- LIVE DISPLAY SECTION -->
        <div class="firebase-config-section">
          <h3>📺 Live 4K Display</h3>
          <p style="margin-bottom: 15px; font-size: 0.9rem; color: #155724;">
            Open een real-time 4K display scherm voor TV monitors of grote schermen. Het scherm werkt automatisch bij wanneer boekingen wijzigen.
          </p>
          <div class="config-actions">
            <button onclick="open4KDisplay()" class="btn-success" style="padding: 12px 20px; font-size: 1rem;">🖥️ Open 4K Live Display</button>
            <button onclick="close4KDisplay()" class="btn-secondary" style="margin-left: 10px;">Sluit Display</button>
          </div>
          <div id="displayStatus" class="status-message" style="display: none"></div>
        </div>

        <!-- USER MANAGEMENT SECTION -->
        <div class="user-management">
          <h3>Admin Gebruikersbeheer</h3>
          <p style="margin-bottom: 15px; font-size: 0.9rem;">
            Maak admin gebruikers aan die toegang hebben tot dit dashboard.
          </p>
          <div class="auth-form">
            <input type="email" id="newUserEmail" placeholder="Admin E-mail" />
            <input type="password" id="newUserPassword" placeholder="Tijdelijk Wachtwoord (min 6 tekens)" />
          </div>
          <div class="auth-actions">
            <button onclick="createAdminUser()" class="btn-success">Admin Gebruiker Aanmaken</button>
            <button onclick="changePassword()" class="btn-secondary">Mijn Wachtwoord Wijzigen</button>
          </div>
          <div id="userManagementStatus" class="status-message" style="display: none"></div>
        </div>

        <div class="nav-tabs">
          <button class="nav-tab active" onclick="switchTab('setup')">Evenement Instellen</button>
          <button class="nav-tab" onclick="switchTab('bookings')">Boekingen Beheren</button>
          <button class="nav-tab" onclick="switchTab('export')">Exporteren & Rapporten</button>
        </div>

        <div id="setup-tab" class="tab-content active">
          <div class="section">
            <h2>Evenement Configuratie</h2>
            <div class="form-grid">
              <div class="form-group">
                <label for="eventDate">Evenement Datum:</label>
                <input type="date" id="eventDate" />
              </div>
              <div class="form-group">
                <label for="startTime">Starttijd:</label>
                <input type="time" id="startTime" value="09:00" />
              </div>
              <div class="form-group">
                <label for="endTime">Eindtijd:</label>
                <input type="time" id="endTime" value="17:00" />
              </div>
              <div class="form-group">
                <label for="slotDuration">Tijdslot Duur (minuten):</label>
                <input type="number" id="slotDuration" value="10" min="5" max="30" />
              </div>
            </div>
            <button onclick="generateTimeSlots()">Tijdslots Genereren</button>
            <div id="eventStatus" class="status-message" style="display: none"></div>
          </div>

          <div class="section">
            <h2>Tafel Configuratie</h2>
            <div class="form-grid">
              <div class="form-group">
                <label for="tableName">Tafel Naam:</label>
                <input type="text" id="tableName" placeholder="bijv. AI & Technologie" />
              </div>
              <div class="form-group">
                <label for="speaker1">Spreker 1:</label>
                <input type="text" id="speaker1" placeholder="Spreker naam" />
              </div>
              <div class="form-group">
                <label for="speaker2">Spreker 2:</label>
                <input type="text" id="speaker2" placeholder="Spreker naam" />
              </div>
            </div>
            <button onclick="addTable()">Tafel Toevoegen</button>
            <div class="tables-grid" id="tablesGrid"></div>
          </div>
        </div>

        <div id="bookings-tab" class="tab-content">
          <div class="section">
            <h2>Huidige Boekingen</h2>
            <div id="bookingsOverview">Boekingen worden geladen...</div>
          </div>
        </div>

        <div id="export-tab" class="tab-content">
          <div class="section">
            <h2>Exporteren & Rapporten</h2>
            <button class="btn-success" onclick="exportToCSV()">Exporteren naar CSV</button>
            <button class="btn-success" onclick="exportToExcel()" style="margin-left: 10px">Exporteren naar Excel</button>
            <button class="btn-success" onclick="exportToJPG()" style="margin-left: 10px">Exporteren naar JPG (Printbaar)</button>
            <button class="btn-success" onclick="exportTo4KSignage()" style="margin-left: 10px">Exporteren naar 4K Signage (TV)</button>
            <div id="exportStatus" class="status-message" style="display: none"></div>
          </div>
        </div>
      </div>

      <!-- MODALS -->
      <div class="overlay" id="overlay"></div>

      <!-- LOGIN MODAL -->
      <div class="modal" id="loginModal">
        <h3>Admin Inloggen</h3>
        <div class="form-group">
          <label for="adminEmail">E-mail:</label>
          <input type="email" id="adminEmail" placeholder="Voer admin e-mail in" style="width: 100%; margin-bottom: 15px" required />
        </div>
        <div class="form-group">
          <label for="adminPassword">Wachtwoord:</label>
          <input type="password" id="adminPassword" placeholder="Voer wachtwoord in" onkeypress="if(event.key==='Enter') loginAdmin()" style="width: 100%; margin-bottom: 15px" required />
        </div>
        <div style="text-align: center">
          <button onclick="loginAdmin()" style="margin-right: 10px">Inloggen</button>
          <button onclick="closeLoginModal()" class="btn-secondary">Annuleren</button>
        </div>
        <div id="loginError" class="status-message error" style="display: none"></div>
      </div>

      <!-- PASSWORD CHANGE MODAL -->
      <div class="modal" id="passwordChangeModal">
        <h3>Wachtwoord Wijzigen</h3>
        <div class="form-group">
          <label for="currentPassword">Huidige Wachtwoord:</label>
          <input type="password" id="currentPassword" placeholder="Voer huidige wachtwoord in" style="width: 100%; margin-bottom: 15px" required />
        </div>
        <div class="form-group">
          <label for="newPassword">Nieuwe Wachtwoord:</label>
          <input type="password" id="newPassword" placeholder="Voer nieuw wachtwoord in (min 6 tekens)" style="width: 100%; margin-bottom: 15px" minlength="6" required />
        </div>
        <div class="form-group">
          <label for="confirmPassword">Bevestig Wachtwoord:</label>
          <input type="password" id="confirmPassword" placeholder="Bevestig nieuw wachtwoord" style="width: 100%; margin-bottom: 15px" minlength="6" required />
        </div>
        <div style="text-align: center">
          <button onclick="updatePassword()" style="margin-right: 10px">Wachtwoord Bijwerken</button>
          <button onclick="closePasswordChangeModal()" class="btn-secondary">Annuleren</button>
        </div>
        <div id="passwordChangeStatus" class="status-message" style="display: none"></div>
      </div>

      <!-- BOOKING FORM -->
      <div class="modal" id="bookingForm">
        <button class="close-btn" onclick="closeBookingForm()">&times;</button>
        <h3>Boek Uw Gesprek</h3>
        <div class="form-group">
          <label for="userName">Uw Naam: *</label>
          <input type="text" id="userName" required />
        </div>
        <div class="form-group">
          <label for="userEmail">E-mail: *</label>
          <input type="email" id="userEmail" required onblur="checkEmailBookingLimit()" />
          <div id="emailBookingStatus" class="status-message" style="display: none; margin-top: 5px; text-align: left; padding: 5px;"></div>
        </div>
        <div class="form-group">
          <label for="userArtistName">Artiest Naam/Band: *</label>
          <input type="text" id="userArtistName" required />
        </div>
        <div class="form-group">
          <label>Geselecteerd Tijdslot:</label>
          <div id="selectedSlotInfo" class="confirmation-details"></div>
        </div>
        <div class="booking-actions">
          <button onclick="confirmBooking()" id="confirmBookingBtn">Boeking Bevestigen</button>
        </div>
        <div id="bookingStatus" class="status-message" style="display: none"></div>
      </div>

      <!-- CONFIRMATION MODAL -->
      <div class="modal" id="confirmationModal">
        <button class="close-btn" onclick="closeConfirmationModal()">&times;</button>
        <h3>Boeking Bevestigd</h3>
        <div id="confirmationDetails"></div>
        <div class="booking-actions">
          <button onclick="addToCalendar()">Toevoegen aan Kalender</button>
        </div>
        <div id="emailPreview" class="email-preview hidden"></div>
      </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    
    <!-- EmailJS SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    
    <!-- html2canvas SDK -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <script>
      // Global variables
      var db = null;
      var auth = null;
      var isFirebaseInitialized = false;
      var isOnline = false;
      var unsubscribeListeners = [];
      var currentUser = null;
      var display4KWindow = null;
      var currentBookingConfirmation = null;
      var currentBookingSelection = null;
      var isAdminMode = false;

      // Configuration
      var DEFAULT_FIREBASE_CONFIG = {
        apiKey: "AIzaSyDTG9ciegpaJBvy4LZt9s9TdemnNAyz1EQ",
        authDomain: "ostend-is-music.firebaseapp.com",
        projectId: "ostend-is-music",
        storageBucket: "ostend-is-music.firebasestorage.app",
        messagingSenderId: "481655541764",
        appId: "1:481655541764:web:60b142aafa966c24466551",
        measurementId: "G-PH6EPPW3BY"
      };

      var EMAILJS_CONFIG = {
        serviceId: "service_0m2owju", 
        templateId: "template_7xq3pho", 
        publicKey: "VehBeO9qQGs5TbvvnY", 
        fromName: "Event Team"
      };

      var localData = {
        eventConfig: {
          date: "",
          startTime: "09:00",
          endTime: "17:00",
          slotDuration: 10,
          timeSlots: []
        },
        tables: [],
        bookings: {}
      };

      var MAX_BOOKINGS_PER_EMAIL = 3;

      // Helper functions
      function countBookingsByEmail(email) {
        var normalizedEmail = email.toLowerCase().trim();
        return Object.values(localData.bookings).filter(function(booking) {
          return booking.email.toLowerCase().trim() === normalizedEmail;
        }).length;
      }

      function getBookingsByEmail(email) {
        var normalizedEmail = email.toLowerCase().trim();
        return Object.values(localData.bookings).filter(function(booking) {
          return booking.email.toLowerCase().trim() === normalizedEmail;
        });
      }

      function checkEmailBookingLimit() {
        var email = document.getElementById("userEmail").value.trim();
        var statusElement = document.getElementById("emailBookingStatus");
        
        if (!email) {
          statusElement.style.display = "none";
          return;
        }

        var emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(email)) {
          statusElement.textContent = "Voer een geldig e-mailadres in";
          statusElement.className = "status-message error";
          statusElement.style.display = "block";
          return;
        }

        var currentBookingCount = countBookingsByEmail(email);
        var remainingBookings = MAX_BOOKINGS_PER_EMAIL - currentBookingCount;

        if (remainingBookings <= 0) {
          var existingBookings = getBookingsByEmail(email);
          var bookingDetails = existingBookings.map(function(booking) {
            return booking.tableName + " (" + booking.timeSlot + ")";
          }).join(', ');
          
          statusElement.textContent = "Maximum boekingen bereikt (" + MAX_BOOKINGS_PER_EMAIL + "/" + MAX_BOOKINGS_PER_EMAIL + "). Huidige: " + bookingDetails;
          statusElement.className = "status-message error";
          statusElement.style.display = "block";
          
          var confirmBtn = document.getElementById('confirmBookingBtn');
          if (confirmBtn) {
            confirmBtn.disabled = true;
            confirmBtn.textContent = 'Maximum Boekingen Bereikt';
          }
        } else if (currentBookingCount > 0) {
          var existingBookings = getBookingsByEmail(email);
          var bookingDetails = existingBookings.map(function(booking) {
            return booking.tableName + " (" + booking.timeSlot + ")";
          }).join(', ');
          
          statusElement.textContent = currentBookingCount + "/" + MAX_BOOKINGS_PER_EMAIL + " boekingen gebruikt. " + remainingBookings + " resterend. Huidige: " + bookingDetails;
          statusElement.className = "status-message warning";
          statusElement.style.display = "block";
          
          var confirmBtn = document.getElementById('confirmBookingBtn');
          if (confirmBtn) {
            confirmBtn.disabled = false;
            confirmBtn.textContent = 'Boeking Bevestigen';
          }
        } else {
          statusElement.textContent = remainingBookings + "/" + MAX_BOOKINGS_PER_EMAIL + " boekingen beschikbaar";
          statusElement.className = "status-message success";
          statusElement.style.display = "block";
          
          var confirmBtn = document.getElementById('confirmBookingBtn');
          if (confirmBtn) {
            confirmBtn.disabled = false;
            confirmBtn.textContent = 'Boeking Bevestigen';
          }
        }
      }

      // 4K Display Functions
      function open4KDisplay() {
        if (display4KWindow && !display4KWindow.closed) {
          display4KWindow.focus();
          showDisplayStatus("4K Display is al geopend", "warning");
          return;
        }

        try {
          display4KWindow = window.open(
            '', 
            '4KDisplay',
            'width=1920,height=1080,scrollbars=no,resizable=yes,status=no,toolbar=no,menubar=no'
          );

          if (!display4KWindow) {
            throw new Error('Popup werd geblokkeerd door browser');
          }

          var displayContent = create4KDisplayContent();
          
          display4KWindow.document.open();
          display4KWindow.document.write(displayContent);
          display4KWindow.document.close();
          
          setup4KDisplayListeners();
          
          showDisplayStatus("4K Display succesvol geopend", "success");
          
        } catch (error) {
          console.error('4K Display openen mislukt:', error);
          showDisplayStatus("Fout bij openen 4K Display: " + error.message, "error");
        }
      }

      function close4KDisplay() {
        if (display4KWindow && !display4KWindow.closed) {
          display4KWindow.close();
          display4KWindow = null;
          showDisplayStatus("4K Display gesloten", "success");
        } else {
          showDisplayStatus("Geen 4K Display om te sluiten", "warning");
        }
      }

      function create4KDisplayContent() {
        var eventDate = "Niet geconfigureerd";
        if (localData.eventConfig.date) {
          eventDate = new Date(localData.eventConfig.date).toLocaleDateString("nl-NL", {
            weekday: "long",
            year: "numeric",
            month: "long",
            day: "numeric"
          });
        }

        var bookingsList = Object.values(localData.bookings);
        var totalSlots = localData.tables.length * localData.eventConfig.timeSlots.length;
        var bookedSlots = bookingsList.length;
        var availableSlots = totalSlots - bookedSlots;
        var occupancyRate = totalSlots > 0 ? Math.round((bookedSlots / totalSlots) * 100) : 0;

        // Build HTML as array to avoid quote issues
        var htmlParts = [];
        
        htmlParts.push('<!DOCTYPE html><html lang="nl"><head>');
        htmlParts.push('<meta charset="UTF-8">');
        htmlParts.push('<meta name="viewport" content="width=device-width, initial-scale=1.0">');
        htmlParts.push('<title>4K Live Display</title>');
        htmlParts.push('<style>');
        htmlParts.push('* { margin: 0; padding: 0; box-sizing: border-box; }');
        htmlParts.push('body { width: 100vw; height: 100vh; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); font-family: Arial, sans-serif; color: white; overflow: hidden; display: flex; flex-direction: column; }');
        htmlParts.push('.display-header { text-align: center; padding: 20px; border-bottom: 3px solid rgba(255, 255, 255, 0.3); }');
        htmlParts.push('.display-title { font-size: 3rem; font-weight: bold; margin-bottom: 10px; }');
        htmlParts.push('.display-subtitle { font-size: 1.5rem; margin-bottom: 5px; opacity: 0.9; }');
        htmlParts.push('.display-tables-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; padding: 20px; flex: 1; overflow-y: auto; }');
        htmlParts.push('.display-table { background: rgba(255, 255, 255, 0.95); border-radius: 12px; overflow: hidden; color: #333; }');
        htmlParts.push('.display-table-header { background: #2c3e50; padding: 15px; color: white; text-align: center; }');
        htmlParts.push('.display-table-name { font-size: 1.2rem; font-weight: bold; margin-bottom: 5px; }');
        htmlParts.push('.display-table-speakers { font-size: 1rem; }');
        htmlParts.push('.display-slots { padding: 10px; }');
        htmlParts.push('.display-slot { display: flex; justify-content: space-between; padding: 8px; margin-bottom: 5px; border-radius: 4px; }');
        htmlParts.push('.display-slot.available { background: #d4edda; border-left: 4px solid #28a745; }');
        htmlParts.push('.display-slot.booked { background: #fff3cd; border-left: 4px solid #ffc107; }');
        htmlParts.push('.display-time { font-weight: bold; }');
        htmlParts.push('.display-booking-info { flex: 1; text-align: center; font-weight: bold; }');
        htmlParts.push('.display-booking-info.booked { color: #856404; }');
        htmlParts.push('.display-booking-info.available { color: #155724; }');
        htmlParts.push('.display-footer { display: flex; justify-content: space-between; background: rgba(255, 255, 255, 0.1); padding: 15px; }');
        htmlParts.push('.display-stats { display: flex; gap: 30px; }');
        htmlParts.push('.display-stat { text-align: center; }');
        htmlParts.push('.display-stat-number { font-size: 1.5rem; font-weight: bold; display: block; }');
        htmlParts.push('</style></head><body>');
        
        htmlParts.push('<div class="display-header">');
        htmlParts.push('<div class="display-title">Gesprekstafel Schema</div>');
        htmlParts.push('<div class="display-subtitle">' + eventDate + '</div>');
        htmlParts.push('<div class="display-subtitle">' + localData.eventConfig.startTime + ' - ' + localData.eventConfig.endTime + '</div>');
        htmlParts.push('</div>');
        
        htmlParts.push('<div class="display-tables-grid">');
        
        for (var i = 0; i < localData.tables.length; i++) {
          var table = localData.tables[i];
          htmlParts.push('<div class="display-table">');
          htmlParts.push('<div class="display-table-header">');
          htmlParts.push('<div class="display-table-name">Tafel ' + (i + 1) + ': ' + table.name + '</div>');
          htmlParts.push('<div class="display-table-speakers">met ' + table.speaker1 + ' & ' + table.speaker2 + '</div>');
          htmlParts.push('</div>');
          htmlParts.push('<div class="display-slots">');
          
          for (var j = 0; j < localData.eventConfig.timeSlots.length; j++) {
            var slot = localData.eventConfig.timeSlots[j];
            var bookingKey = table.id + '-' + slot.index;
            var booking = localData.bookings[bookingKey];
            
            if (booking) {
              htmlParts.push('<div class="display-slot booked">');
              htmlParts.push('<div class="display-time">' + slot.start + ' - ' + slot.end + '</div>');
              htmlParts.push('<div class="display-booking-info booked">' + booking.name + '</div>');
              htmlParts.push('</div>');
            } else {
              htmlParts.push('<div class="display-slot available">');
              htmlParts.push('<div class="display-time">' + slot.start + ' - ' + slot.end + '</div>');
              htmlParts.push('<div class="display-booking-info available">Beschikbaar</div>');
              htmlParts.push('</div>');
            }
          }
          
          htmlParts.push('</div></div>');
        }
        
        htmlParts.push('</div>');
        
        htmlParts.push('<div class="display-footer">');
        htmlParts.push('<div class="display-stats">');
        htmlParts.push('<div class="display-stat"><span class="display-stat-number">' + localData.tables.length + '</span><span>Tafels</span></div>');
        htmlParts.push('<div class="display-stat"><span class="display-stat-number">' + bookedSlots + '</span><span>Geboekt</span></div>');
        htmlParts.push('<div class="display-stat"><span class="display-stat-number">' + availableSlots + '</span><span>Beschikbaar</span></div>');
        htmlParts.push('<div class="display-stat"><span class="display-stat-number">' + occupancyRate + '%</span><span>Bezetting</span></div>');
        htmlParts.push('</div>');
        htmlParts.push('<div>Laatst bijgewerkt: ' + new Date().toLocaleString() + '</div>');
        htmlParts.push('</div>');
        
        htmlParts.push('<script>');
        htmlParts.push('setInterval(function() {');
        htmlParts.push('  if (window.opener && !window.opener.closed) {');
        htmlParts.push('    location.reload();');
        htmlParts.push('  } else {');
        htmlParts.push('    window.close();');
        htmlParts.push('  }');
        htmlParts.push('}, 5000);');
        htmlParts.push('</script></body></html>');

        return htmlParts.join('');
      }

      function setup4KDisplayListeners() {
        if (!display4KWindow || display4KWindow.closed) return;
        
        var displayUpdateInterval = setInterval(function() {
          if (display4KWindow && !display4KWindow.closed) {
            try {
              var newContent = create4KDisplayContent();
              display4KWindow.document.open();
              display4KWindow.document.write(newContent);
              display4KWindow.document.close();
            } catch (error) {
              console.error('Error updating 4K display:', error);
            }
          } else {
            clearInterval(displayUpdateInterval);
            display4KWindow = null;
          }
        }, 3000);
      }

      function showDisplayStatus(message, type) {
        var element = document.getElementById('displayStatus');
        element.textContent = message;
        element.className = 'status-message ' + type;
        element.style.display = 'block';

        setTimeout(function() {
          element.style.display = 'none';
        }, 5000);
      }

      // Firebase initialization
      function initializeFirebase() {
        try {
          updateConnectionStatus('connecting');
          
          if (!firebase.apps.length) {
            firebase.initializeApp(DEFAULT_FIREBASE_CONFIG);
          }
          
          db = firebase.firestore();
          auth = firebase.auth();
          
          auth.onAuthStateChanged(function(user) {
            currentUser = user;
            if (user && isAdminMode) {
              document.getElementById('adminUserEmail').textContent = user.email;
            }
          });
          
          db.collection('system').doc('test').get().then(function() {
            isFirebaseInitialized = true;
            isOnline = true;
            updateConnectionStatus('connected');
            
            setupRealtimeListeners();
            loadDataFromFirestore();
          }).catch(function(error) {
            console.error('Firebase verbinding mislukt:', error);
            isFirebaseInitialized = false;
            isOnline = false;
            updateConnectionStatus('disconnected');
            loadDataFromLocalStorage();
          });
          
        } catch (error) {
          console.error('Firebase initialisatie mislukt:', error);
          isFirebaseInitialized = false;
          isOnline = false;
          updateConnectionStatus('disconnected');
          loadDataFromLocalStorage();
        }
      }

      function updateConnectionStatus(status) {
        var statusElement = document.getElementById('connectionStatus');
        
        switch (status) {
          case 'connected':
            statusElement.className = 'connection-status connected';
            statusElement.innerHTML = '<span class="sync-indicator synced"></span>●';
            break;
          case 'connecting':
            statusElement.className = 'connection-status disconnected';
            statusElement.innerHTML = '<span class="sync-indicator syncing"></span>●';
            break;
          case 'disconnected':
            statusElement.className = 'connection-status disconnected';
            statusElement.innerHTML = '<span class="sync-indicator"></span>○';
            break;
        }
      }

      function setupRealtimeListeners() {
        if (!db) return;

        var eventConfigRef = db.collection('system').doc('eventConfig');
        var unsubscribeEventConfig = eventConfigRef.onSnapshot(function(doc) {
          if (doc.exists) {
            localData.eventConfig = doc.data();
            updateEventUI();
            renderClientInterface();
          }
        });

        var tablesRef = db.collection('tables');
        var unsubscribeTables = tablesRef.onSnapshot(function(snapshot) {
          snapshot.docChanges().forEach(function(change) {
            var tableData = Object.assign({ id: change.doc.id }, change.doc.data());
            
            if (change.type === 'added') {
              var existingIndex = localData.tables.findIndex(function(t) { return t.id === tableData.id; });
              if (existingIndex === -1) {
                localData.tables.push(tableData);
              }
            } else if (change.type === 'removed') {
              localData.tables = localData.tables.filter(function(t) { return t.id !== tableData.id; });
            } else if (change.type === 'modified') {
              var index = localData.tables.findIndex(function(t) { return t.id === tableData.id; });
              if (index !== -1) {
                localData.tables[index] = tableData;
              }
            }
          });
          
          localData.tables.sort(function(a, b) { return (a.order || 0) - (b.order || 0); });
          renderTables();
          renderClientInterface();
        });

        var bookingsRef = db.collection('bookings');
        var unsubscribeBookings = bookingsRef.onSnapshot(function(snapshot) {
          localData.bookings = {};
          snapshot.forEach(function(doc) {
            localData.bookings[doc.id] = doc.data();
          });
          renderBookingsOverview();
          renderClientInterface();
        });

        unsubscribeListeners = [unsubscribeEventConfig, unsubscribeTables, unsubscribeBookings];
      }

      // Authentication functions
      function showLoginModal() {
        document.getElementById("overlay").style.display = "block";
        document.getElementById("loginModal").style.display = "block";
        document.getElementById("adminEmail").value = "";
        document.getElementById("adminPassword").value = "";
        document.getElementById("loginError").style.display = "none";
      }

      function closeLoginModal() {
        document.getElementById("overlay").style.display = "none";
        document.getElementById("loginModal").style.display = "none";
      }

      function loginAdmin() {
        var email = document.getElementById("adminEmail").value.trim();
        var password = document.getElementById("adminPassword").value;

        if (!email || !password) {
          showLoginError("Voer e-mail en wachtwoord in");
          return;
        }

        if (!auth) {
          showLoginError("Authenticatie niet beschikbaar");
          return;
        }

        auth.signInWithEmailAndPassword(email, password).then(function(userCredential) {
          currentUser = userCredential.user;
          isAdminMode = true;
          closeLoginModal();
          switchToAdmin();
        }).catch(function(error) {
          console.error('Inloggen mislukt:', error);
          var errorMessage = "Inloggen mislukt";
          switch (error.code) {
            case 'auth/user-not-found':
              errorMessage = "Geen admin account gevonden";
              break;
            case 'auth/wrong-password':
              errorMessage = "Onjuist wachtwoord";
              break;
            case 'auth/invalid-email':
              errorMessage = "Ongeldig e-mailadres";
              break;
            default:
              errorMessage = error.message;
          }
          showLoginError(errorMessage);
        });
      }

      function showLoginError(message) {
        var element = document.getElementById("loginError");
        element.textContent = message;
        element.style.display = "block";
      }

      function logout() {
        if (auth && currentUser) {
          auth.signOut().then(function() {
            currentUser = null;
            isAdminMode = false;
            switchToClient();
          }).catch(function(error) {
            console.error('Uitloggen mislukt:', error);
            currentUser = null;
            isAdminMode = false;
            switchToClient();
          });
        } else {
          currentUser = null;
          isAdminMode = false;
          switchToClient();
        }
      }

      function createAdminUser() {
        var email = document.getElementById("newUserEmail").value.trim();
        var password = document.getElementById("newUserPassword").value;

        if (!email || !password) {
          showUserManagementStatus("Voer e-mail en wachtwoord in", "error");
          return;
        }

        if (password.length < 6) {
          showUserManagementStatus("Wachtwoord moet minimaal 6 tekens bevatten", "error");
          return;
        }

        if (!auth) {
          showUserManagementStatus("Authenticatie niet beschikbaar", "error");
          return;
        }

        auth.createUserWithEmailAndPassword(email, password).then(function(userCredential) {
          return userCredential.user.sendEmailVerification();
        }).then(function() {
          showUserManagementStatus("Admin gebruiker succesvol aangemaakt", "success");
          document.getElementById("newUserEmail").value = "";
          document.getElementById("newUserPassword").value = "";
        }).catch(function(error) {
          console.error('Gebruiker aanmaken mislukt:', error);
          var errorMessage = "Gebruiker aanmaken mislukt";
          switch (error.code) {
            case 'auth/email-already-in-use':
              errorMessage = "Account bestaat al";
              break;
            case 'auth/invalid-email':
              errorMessage = "Ongeldig e-mailadres";
              break;
            case 'auth/weak-password':
              errorMessage = "Wachtwoord is te zwak";
              break;
            default:
              errorMessage = error.message;
          }
          showUserManagementStatus(errorMessage, "error");
        });
      }

      function changePassword() {
        document.getElementById("overlay").style.display = "block";
        document.getElementById("passwordChangeModal").style.display = "block";
        document.getElementById("currentPassword").value = "";
        document.getElementById("newPassword").value = "";
        document.getElementById("confirmPassword").value = "";
        document.getElementById("passwordChangeStatus").style.display = "none";
      }

      function closePasswordChangeModal() {
        document.getElementById("overlay").style.display = "none";
        document.getElementById("passwordChangeModal").style.display = "none";
      }

      function updatePassword() {
        var currentPassword = document.getElementById("currentPassword").value;
        var newPassword = document.getElementById("newPassword").value;
        var confirmPassword = document.getElementById("confirmPassword").value;

        if (!currentPassword || !newPassword || !confirmPassword) {
          showPasswordChangeStatus("Vul alle velden in", "error");
          return;
        }

        if (newPassword !== confirmPassword) {
          showPasswordChangeStatus("Nieuwe wachtwoorden komen niet overeen", "error");
          return;
        }

        if (newPassword.length < 6) {
          showPasswordChangeStatus("Wachtwoord moet minimaal 6 tekens bevatten", "error");
          return;
        }

        if (!auth || !currentUser) {
          showPasswordChangeStatus("Niet geauthenticeerd", "error");
          return;
        }

        var credential = firebase.auth.EmailAuthProvider.credential(currentUser.email, currentPassword);
        currentUser.reauthenticateWithCredential(credential).then(function() {
          return currentUser.updatePassword(newPassword);
        }).then(function() {
          showPasswordChangeStatus("Wachtwoord succesvol bijgewerkt", "success");
          document.getElementById("currentPassword").value = "";
          document.getElementById("newPassword").value = "";
          document.getElementById("confirmPassword").value = "";
          
          setTimeout(function() {
            closePasswordChangeModal();
          }, 2000);
        }).catch(function(error) {
          console.error('Wachtwoord wijzigen mislukt:', error);
          var errorMessage = "Wachtwoord wijzigen mislukt";
          switch (error.code) {
            case 'auth/wrong-password':
              errorMessage = "Huidig wachtwoord is onjuist";
              break;
            case 'auth/weak-password':
              errorMessage = "Nieuw wachtwoord is te zwak";
              break;
            default:
              errorMessage = error.message;
          }
          showPasswordChangeStatus(errorMessage, "error");
        });
      }

      function showUserManagementStatus(message, type) {
        var element = document.getElementById("userManagementStatus");
        element.textContent = message;
        element.className = "status-message " + type;
        element.style.display = "block";

        setTimeout(function() {
          element.style.display = "none";
        }, 5000);
      }

      function showPasswordChangeStatus(message, type) {
        var element = document.getElementById("passwordChangeStatus");
        element.textContent = message;
        element.className = "status-message " + type;
        element.style.display = "block";

        setTimeout(function() {
          element.style.display = "none";
        }, 5000);
      }

      // Data operations
      function saveEventConfigToFirestore() {
        if (!db) {
          saveDataToLocalStorage();
          return Promise.resolve();
        }

        return db.collection('system').doc('eventConfig').set(localData.eventConfig).catch(function(error) {
          console.error('Fout bij opslaan event config:', error);
          saveDataToLocalStorage();
        });
      }

      function saveTableToFirestore(table) {
        if (!db) {
          saveDataToLocalStorage();
          return Promise.resolve(table.id);
        }

        return db.collection('tables').add(Object.assign({}, table, {
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        })).then(function(docRef) {
          return docRef.id;
        }).catch(function(error) {
          console.error('Fout bij opslaan tafel:', error);
          saveDataToLocalStorage();
          return table.id;
        });
      }

      function removeTableFromFirestore(tableId) {
        if (!db) {
          saveDataToLocalStorage();
          return Promise.resolve();
        }

        return db.collection('tables').doc(tableId).delete().then(function() {
          return db.collection('bookings').where('tableId', '==', tableId).get();
        }).then(function(bookingsSnapshot) {
          var batch = db.batch();
          bookingsSnapshot.forEach(function(doc) {
            batch.delete(doc.ref);
          });
          return batch.commit();
        }).catch(function(error) {
          console.error('Fout bij verwijderen tafel:', error);
          saveDataToLocalStorage();
        });
      }

      function saveBookingToFirestore(bookingKey, booking) {
        if (!db) {
          saveDataToLocalStorage();
          return Promise.resolve();
        }

        return db.collection('bookings').doc(bookingKey).set(Object.assign({}, booking, {
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        })).catch(function(error) {
          console.error('Fout bij opslaan boeking:', error);
          saveDataToLocalStorage();
          throw error;
        });
      }

      function removeBookingFromFirestore(bookingKey) {
        if (!db) {
          saveDataToLocalStorage();
          return Promise.resolve();
        }

        return db.collection('bookings').doc(bookingKey).delete().catch(function(error) {
          console.error('Fout bij verwijderen boeking:', error);
          saveDataToLocalStorage();
        });
      }

      function loadDataFromFirestore() {
        if (!db) return Promise.resolve();

        return Promise.all([
          db.collection('system').doc('eventConfig').get(),
          db.collection('tables').get(),
          db.collection('bookings').get()
        ]).then(function(results) {
          var eventConfigDoc = results[0];
          var tablesSnapshot = results[1];
          var bookingsSnapshot = results[2];

          if (eventConfigDoc.exists) {
            localData.eventConfig = eventConfigDoc.data();
          }

          localData.tables = [];
          tablesSnapshot.forEach(function(doc) {
            var tableData = Object.assign({ id: doc.id }, doc.data());
            if (typeof tableData.order === 'undefined') {
              tableData.order = localData.tables.length;
            }
            localData.tables.push(tableData);
          });
          localData.tables.sort(function(a, b) { return (a.order || 0) - (b.order || 0); });

          localData.bookings = {};
          bookingsSnapshot.forEach(function(doc) {
            localData.bookings[doc.id] = doc.data();
          });

          updateUI();
        }).catch(function(error) {
          console.error('Fout bij laden data:', error);
          loadDataFromLocalStorage();
        });
      }

      function saveDataToLocalStorage() {
        localStorage.setItem('bookingSystemData', JSON.stringify(localData));
      }

      function loadDataFromLocalStorage() {
        var stored = localStorage.getItem('bookingSystemData');
        if (stored) {
          localData = Object.assign({}, localData, JSON.parse(stored));
        }
        updateUI();
      }

      function updateUI() {
        updateEventUI();
        renderTables();
        renderBookingsOverview();
        renderClientInterface();
      }

      function updateEventUI() {
        if (localData.eventConfig.date) {
          document.getElementById('eventDate').value = localData.eventConfig.date;
        }
        document.getElementById('startTime').value = localData.eventConfig.startTime;
        document.getElementById('endTime').value = localData.eventConfig.endTime;
        document.getElementById('slotDuration').value = localData.eventConfig.slotDuration;
      }

      function switchToAdmin() {
        document.getElementById("client-interface").style.display = "none";
        document.getElementById("admin-interface").style.display = "block";
        
        if (currentUser) {
          document.getElementById('adminUserEmail').textContent = currentUser.email;
        }
        
        renderBookingsOverview();
      }

      function switchToClient() {
        isAdminMode = false;
        document.getElementById("client-interface").style.display = "block";
        document.getElementById("admin-interface").style.display = "none";
        renderClientInterface();
      }

      function switchTab(tabName) {
        var tabs = document.querySelectorAll(".nav-tab");
        for (var i = 0; i < tabs.length; i++) {
          tabs[i].classList.remove("active");
        }
        document.querySelector('[onclick="switchTab(\'' + tabName + '\')"]').classList.add("active");

        var contents = document.querySelectorAll(".tab-content");
        for (var i = 0; i < contents.length; i++) {
          contents[i].classList.remove("active");
        }
        document.getElementById(tabName + "-tab").classList.add("active");

        if (tabName === "bookings") {
          renderBookingsOverview();
        }
      }

      function generateTimeSlots() {
        var date = document.getElementById("eventDate").value;
        var startTime = document.getElementById("startTime").value;
        var endTime = document.getElementById("endTime").value;
        var duration = parseInt(document.getElementById("slotDuration").value);

        if (!date || !startTime || !endTime) {
          showStatus("eventStatus", "Vul alle velden in", "error");
          return;
        }

        if (startTime >= endTime) {
          showStatus("eventStatus", "Eindtijd moet na starttijd zijn", "error");
          return;
        }

        localData.eventConfig.date = date;
        localData.eventConfig.startTime = startTime;
        localData.eventConfig.endTime = endTime;
        localData.eventConfig.slotDuration = duration;

        var slots = [];
        var start = new Date(date + "T" + startTime);
        var end = new Date(date + "T" + endTime);

        var current = new Date(start);
        var slotIndex = 0;

        while (current < end) {
          var slotEnd = new Date(current.getTime() + duration * 60000);
          if (slotEnd <= end) {
            slots.push({
              index: slotIndex++,
              start: current.toTimeString().slice(0, 5),
              end: slotEnd.toTimeString().slice(0, 5),
              startTime: current.toISOString(),
              endTime: slotEnd.toISOString()
            });
          }
          current = new Date(slotEnd);
        }

        localData.eventConfig.timeSlots = slots;
        saveEventConfigToFirestore().then(function() {
          showStatus("eventStatus", slots.length + " tijdslots gegenereerd", "success");
        });
      }

      function addTable() {
        var name = document.getElementById("tableName").value.trim();
        var speaker1 = document.getElementById("speaker1").value.trim();
        var speaker2 = document.getElementById("speaker2").value.trim();

        if (!name || !speaker1 || !speaker2) {
          alert("Vul alle tafel velden in");
          return;
        }

        if (localData.tables.length >= 20) {
          alert("Maximaal 20 tafels toegestaan");
          return;
        }

        var table = {
          name: name,
          speaker1: speaker1,
          speaker2: speaker2,
          order: localData.tables.length
        };

        if (db) {
          saveTableToFirestore(table).then(function(tableId) {
            table.id = tableId;
            document.getElementById("tableName").value = "";
            document.getElementById("speaker1").value = "";
            document.getElementById("speaker2").value = "";
          }).catch(function(error) {
            console.error('Tafel toevoegen mislukt:', error);
            alert('Tafel toevoegen mislukt. Probeer opnieuw.');
          });
        } else {
          table.id = "table_" + Date.now();
          localData.tables.push(table);
          renderTables();
          saveDataToLocalStorage();
          
          document.getElementById("tableName").value = "";
          document.getElementById("speaker1").value = "";
          document.getElementById("speaker2").value = "";
        }
      }

      function renderTables() {
        var grid = document.getElementById("tablesGrid");
        
        if (localData.tables.length === 0) {
          grid.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">Nog geen tafels geconfigureerd.</p>';
          return;
        }
        
        grid.innerHTML = localData.tables.map(function(table, index) {
          return '<div class="table-card"><h4>Tafel ' + (index + 1) + ': ' + table.name + '</h4><p><strong>Sprekers:</strong> ' + table.speaker1 + ' & ' + table.speaker2 + '</p><button onclick="removeTable(\'' + table.id + '\')" class="btn-danger" style="margin-top: 10px;">Verwijderen</button></div>';
        }).join("");
      }

      function removeTable(tableId) {
        if (confirm("Weet u zeker dat u deze tafel wilt verwijderen?")) {
          var tableIndex = localData.tables.findIndex(function(t) { return t.id === tableId; });
          if (tableIndex !== -1) {
            localData.tables.splice(tableIndex, 1);
            renderTables();
          }
          
          Object.keys(localData.bookings).forEach(function(key) {
            if (localData.bookings[key].tableId === tableId) {
              delete localData.bookings[key];
            }
          });
          
          if (db) {
            removeTableFromFirestore(tableId).catch(function(error) {
              console.error('Tafel verwijderen mislukt:', error);
              alert('Tafel verwijderen mislukt.');
            });
          } else {
            saveDataToLocalStorage();
          }
        }
      }

      function renderClientInterface() {
        var eventInfo = document.getElementById("eventInfo");
        if (localData.eventConfig.date && localData.eventConfig.timeSlots.length > 0) {
          var eventDate = new Date(localData.eventConfig.date).toLocaleDateString("nl-NL", {
            weekday: "long",
            year: "numeric",
            month: "long",
            day: "numeric"
          });
          eventInfo.innerHTML = "<strong>" + eventDate + "</strong><br>" + localData.eventConfig.startTime + " - " + localData.eventConfig.endTime + " | " + localData.eventConfig.slotDuration + " minuten per sessie<br><small style=\"color: #856404; font-weight: 500;\">📝 Maximaal " + MAX_BOOKINGS_PER_EMAIL + " boekingen per e-mailadres</small>";
        } else {
          eventInfo.innerHTML = "Evenement nog niet geconfigureerd";
        }

        var container = document.getElementById("clientBookingGrid");

        if (localData.tables.length === 0 || localData.eventConfig.timeSlots.length === 0) {
          container.innerHTML = "<p>Geen tafels beschikbaar voor boeking op dit moment.</p>";
          return;
        }

        container.innerHTML = localData.tables.map(function(table, tableIndex) {
          var slotsHtml = localData.eventConfig.timeSlots.map(function(slot) {
            var bookingKey = table.id + "-" + slot.index;
            var isBooked = localData.bookings[bookingKey];
            return '<div class="time-slot-item ' + (isBooked ? "booked" : "available") + '"><div class="time-info">' + slot.start + ' - ' + slot.end + '</div><button class="slot-btn ' + (isBooked ? "booked" : "available") + '" ' + (!isBooked ? 'onclick="openBookingForm(\'' + table.id + '\', ' + slot.index + ')"' : "") + ' ' + (isBooked ? "disabled" : "") + '>' + (isBooked ? "Geboekt" : "Boeken") + '</button></div>';
          }).join("");
          
          return '<div class="client-table-card"><div class="table-header"><div class="table-title">Tafel ' + (tableIndex + 1) + ': ' + table.name + '</div><div class="speakers">met ' + table.speaker1 + ' & ' + table.speaker2 + '</div></div><div class="time-slots-container">' + slotsHtml + '</div></div>';
        }).join("");
      }

      function openBookingForm(tableId, slotIndex) {
        var table = localData.tables.find(function(t) { return t.id === tableId; });
        var slot = localData.eventConfig.timeSlots.find(function(s) { return s.index === slotIndex; });

        if (!table || !slot) {
          alert("Fout: Tafel of tijdslot niet gevonden");
          return;
        }

        currentBookingSelection = { tableId: tableId, slotIndex: slotIndex };

        var eventDate = new Date(localData.eventConfig.date).toLocaleDateString("nl-NL", {
          weekday: "long",
          year: "numeric",
          month: "long",
          day: "numeric"
        });

        document.getElementById("selectedSlotInfo").innerHTML = "<strong>" + table.name + "</strong><br>" + eventDate + "<br>" + slot.start + " - " + slot.end + "<br>Sprekers: " + table.speaker1 + " & " + table.speaker2;

        document.getElementById("overlay").style.display = "block";
        document.getElementById("bookingForm").style.display = "block";
        document.getElementById("userName").value = "";
        document.getElementById("userEmail").value = "";
        document.getElementById("userArtistName").value = "";
        document.getElementById("bookingStatus").style.display = "none";
        document.getElementById("emailBookingStatus").style.display = "none";
        
        var confirmBtn = document.getElementById('confirmBookingBtn');
        confirmBtn.disabled = false;
        confirmBtn.textContent = 'Boeking Bevestigen';
      }

      function closeBookingForm() {
        document.getElementById("overlay").style.display = "none";
        document.getElementById("bookingForm").style.display = "none";
        currentBookingSelection = null;
      }

      function confirmBooking() {
        var name = document.getElementById("userName").value.trim();
        var email = document.getElementById("userEmail").value.trim();
        var artistName = document.getElementById("userArtistName").value.trim();

        if (!name || !email || !artistName) {
          showStatus("bookingStatus", "Vul alle verplichte velden in", "error");
          return;
        }

        var emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(email)) {
          showStatus("bookingStatus", "Voer een geldig e-mailadres in", "error");
          return;
        }

        var currentBookingCount = countBookingsByEmail(email);
        if (currentBookingCount >= MAX_BOOKINGS_PER_EMAIL) {
          showStatus("bookingStatus", "Maximum aantal boekingen bereikt", "error");
          return;
        }

        if (!currentBookingSelection) {
          showStatus("bookingStatus", "Geen tijdslot geselecteerd", "error");
          return;
        }

        var tableId = currentBookingSelection.tableId;
        var slotIndex = currentBookingSelection.slotIndex;
        var bookingKey = tableId + "-" + slotIndex;

        if (localData.bookings[bookingKey]) {
          showStatus("bookingStatus", "Dit tijdslot is al geboekt", "error");
          return;
        }

        var table = localData.tables.find(function(t) { return t.id === tableId; });
        var slot = localData.eventConfig.timeSlots.find(function(s) { return s.index === slotIndex; });

        var booking = {
          name: name,
          email: email,
          artistName: artistName,
          tableId: tableId,
          slotIndex: slotIndex,
          tableName: table.name,
          speaker1: table.speaker1,
          speaker2: table.speaker2,
          timeSlot: slot.start + " - " + slot.end,
          date: localData.eventConfig.date,
          timestamp: new Date().toISOString()
        };

        var confirmBtn = document.getElementById('confirmBookingBtn');
        confirmBtn.disabled = true;
        confirmBtn.textContent = 'Verwerken...';

        showStatus("bookingStatus", "Boeking wordt verwerkt...", "success");

        saveBookingToFirestore(bookingKey, booking).then(function() {
          localData.bookings[bookingKey] = booking;
          currentBookingConfirmation = booking;

          var eventDate = new Date(booking.date).toLocaleDateString("nl-NL", {
            weekday: "long",
            year: "numeric",
            month: "long",
            day: "numeric"
          });

          var emailParams = {
            user_name: booking.name,
            user_email: booking.email,
            artist_name: booking.artistName,
            table_name: booking.tableName,
            speakers: booking.speaker1 + " & " + booking.speaker2,
            event_date: eventDate,
            time_slot: booking.timeSlot,
            to_email: booking.email,
            from_name: EMAILJS_CONFIG.fromName
          };

          if (typeof emailjs !== 'undefined') {
            emailjs.send(EMAILJS_CONFIG.serviceId, EMAILJS_CONFIG.templateId, emailParams, EMAILJS_CONFIG.publicKey).catch(function(emailError) {
              console.log("E-mail verzenden mislukt:", emailError);
            });
          }

          closeBookingForm();
          showConfirmationModal();
        }).catch(function(error) {
          console.error('Boeking mislukt:', error);
          showStatus("bookingStatus", "Boeking mislukt. Probeer opnieuw.", "error");
        }).finally(function() {
          confirmBtn.disabled = false;
          confirmBtn.textContent = 'Boeking Bevestigen';
        });
      }

      function showConfirmationModal() {
        var booking = currentBookingConfirmation;
        var eventDate = new Date(booking.date).toLocaleDateString("nl-NL", {
          weekday: "long",
          year: "numeric",
          month: "long",
          day: "numeric"
        });

        document.getElementById("confirmationDetails").innerHTML = '<div class="confirmation-details"><strong>Boekingsdetails:</strong><br><strong>Naam:</strong> ' + booking.name + '<br><strong>E-mail:</strong> ' + booking.email + '<br><strong>Artiest/Band:</strong> ' + booking.artistName + '<br><strong>Tafel:</strong> ' + booking.tableName + '<br><strong>Sprekers:</strong> ' + booking.speaker1 + ' & ' + booking.speaker2 + '<br><strong>Datum:</strong> ' + eventDate + '<br><strong>Tijd:</strong> ' + booking.timeSlot + '</div>';

        document.getElementById("overlay").style.display = "block";
        document.getElementById("confirmationModal").style.display = "block";
      }

      function closeConfirmationModal() {
        document.getElementById("overlay").style.display = "none";
        document.getElementById("confirmationModal").style.display = "none";
        document.getElementById("emailPreview").classList.add("hidden");
      }

      function addToCalendar() {
        var booking = currentBookingConfirmation;
        var eventDate = new Date(booking.date);
        var startParts = booking.timeSlot.split(" - ")[0].split(":");
        var endParts = booking.timeSlot.split(" - ")[1].split(":");

        var startTime = new Date(eventDate);
        startTime.setHours(parseInt(startParts[0]), parseInt(startParts[1]));

        var endTime = new Date(eventDate);
        endTime.setHours(parseInt(endParts[0]), parseInt(endParts[1]));

        var icsContent = "BEGIN:VCALENDAR\nVERSION:2.0\nPRODID:-//Event//Gesprekstafel//EN\nBEGIN:VEVENT\nUID:" + Date.now() + "@event.com\nDTSTAMP:" + new Date().toISOString().replace(/[-:]/g, "").split(".")[0] + "Z\nDTSTART:" + startTime.toISOString().replace(/[-:]/g, "").split(".")[0] + "Z\nDTEND:" + endTime.toISOString().replace(/[-:]/g, "").split(".")[0] + "Z\nSUMMARY:Gesprekstafel: " + booking.tableName + "\nDESCRIPTION:Gesprek met " + booking.speaker1 + " & " + booking.speaker2 + "\nLOCATION:Event Locatie\nEND:VEVENT\nEND:VCALENDAR";

        var blob = new Blob([icsContent], { type: "text/calendar" });
        var url = URL.createObjectURL(blob);
        var a = document.createElement("a");
        a.href = url;
        a.download = "gesprekstafel-boeking.ics";
        a.click();
        URL.revokeObjectURL(url);
      }

      function renderBookingsOverview() {
        var container = document.getElementById("bookingsOverview");
        var bookingsList = Object.values(localData.bookings);

        if (bookingsList.length === 0) {
          container.innerHTML = "<p>Nog geen boekingen.</p>";
          return;
        }

        var emailStats = {};
        bookingsList.forEach(function(booking) {
          var email = booking.email.toLowerCase();
          if (!emailStats[email]) {
            emailStats[email] = { count: 0, bookings: [] };
          }
          emailStats[email].count++;
          emailStats[email].bookings.push(booking);
        });

        var totalEmails = Object.keys(emailStats).length;
        var maxBookingsEmails = Object.values(emailStats).filter(function(stat) { return stat.count >= MAX_BOOKINGS_PER_EMAIL; }).length;
        
        var summaryHTML = '<div style="background: #f8f9fa; padding: 15px; border-radius: 4px; margin-bottom: 20px; border: 1px solid #e9ecef;"><h4 style="margin-bottom: 10px; color: #2c3e50;">Boekingsoverzicht</h4><div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;"><div><strong>Totale Boekingen:</strong> ' + bookingsList.length + '</div><div><strong>Unieke E-mails:</strong> ' + totalEmails + '</div><div><strong>Bij Max Limiet:</strong> ' + maxBookingsEmails + '</div><div><strong>Gemiddeld per E-mail:</strong> ' + (bookingsList.length / totalEmails).toFixed(1) + '</div></div></div>';

        var tableHTML = '<table class="bookings-table"><thead><tr><th>Naam</th><th>E-mail</th><th>Artiest/Band</th><th>Tafel</th><th>Datum</th><th>Tijd</th><th>Sprekers</th><th>E-mail Aantal</th><th>Acties</th></tr></thead><tbody>' + bookingsList.map(function(booking) {
          var bookingKey = booking.tableId + "-" + booking.slotIndex;
          var emailCount = emailStats[booking.email.toLowerCase()].count;
          var isAtLimit = emailCount >= MAX_BOOKINGS_PER_EMAIL;
          
          return '<tr style="' + (isAtLimit ? 'background-color: #fff3cd;' : '') + '"><td>' + booking.name + '</td><td>' + booking.email + '</td><td>' + (booking.artistName || "N/A") + '</td><td>' + booking.tableName + '</td><td>' + new Date(booking.date).toLocaleDateString() + '</td><td>' + booking.timeSlot + '</td><td>' + booking.speaker1 + ' & ' + booking.speaker2 + '</td><td style="text-align: center; ' + (isAtLimit ? 'font-weight: bold; color: #856404;' : '') + '">' + emailCount + '/' + MAX_BOOKINGS_PER_EMAIL + '</td><td><button onclick="cancelBooking(\'' + bookingKey + '\')" class="btn-danger" style="padding: 5px 10px; font-size: 12px;">Annuleren</button></td></tr>';
        }).join("") + '</tbody></table>';

        container.innerHTML = summaryHTML + tableHTML;
      }

      function cancelBooking(bookingKey) {
        if (confirm("Weet u zeker dat u deze boeking wilt annuleren?")) {
          removeBookingFromFirestore(bookingKey).then(function() {
            if (!db) {
              delete localData.bookings[bookingKey];
              renderBookingsOverview();
              renderClientInterface();
              saveDataToLocalStorage();
            }
          });
        }
      }

      function exportToCSV() {
        var bookingsList = Object.values(localData.bookings);
        if (bookingsList.length === 0) {
          showStatus("exportStatus", "Geen boekingen om te exporteren", "error");
          return;
        }

        var headers = ["Naam", "E-mail", "Artiest/Band", "Tafel", "Datum", "Tijd", "Spreker 1", "Spreker 2", "Boekingstijd"];
        
        var csvContent = [headers.join(",")].concat(bookingsList.map(function(booking) {
          return [
            booking.name,
            booking.email,
            booking.artistName || "",
            booking.tableName,
            booking.date,
            booking.timeSlot,
            booking.speaker1,
            booking.speaker2,
            new Date(booking.timestamp).toLocaleString()
          ].map(function(field) { return '"' + field + '"'; }).join(",");
        })).join("\n");

        downloadFile(csvContent, "gesprekstafel-boekingen.csv", "text/csv");
        showStatus("exportStatus", "CSV succesvol geëxporteerd", "success");
      }

      function exportToExcel() {
        var bookingsList = Object.values(localData.bookings);
        if (bookingsList.length === 0) {
          showStatus("exportStatus", "Geen boekingen om te exporteren", "error");
          return;
        }

        var excelContent = ["Gesprekstafel Boekingsrapport", "Gegenereerd op: " + new Date().toLocaleString(), "Totale Boekingen: " + bookingsList.length, "", "Naam,E-mail,Artiest/Band,Tafel,Datum,Tijd,Spreker 1,Spreker 2,Boekingstijd"].concat(bookingsList.map(function(booking) {
          return [
            booking.name,
            booking.email,
            booking.artistName || "",
            booking.tableName,
            booking.date,
            booking.timeSlot,
            booking.speaker1,
            booking.speaker2,
            new Date(booking.timestamp).toLocaleString()
          ].map(function(field) { return '"' + field + '"'; }).join(",");
        })).join("\n");

        downloadFile(excelContent, "gesprekstafel-boekingsrapport.csv", "text/csv");
        showStatus("exportStatus", "Excel rapport succesvol geëxporteerd", "success");
      }

      function exportToJPG() {
        showStatus("exportStatus", "JPG export functie vereist html2canvas bibliotheek", "warning");
      }

      function exportTo4KSignage() {
        showStatus("exportStatus", "4K Signage export functie vereist html2canvas bibliotheek", "warning");
      }

      function downloadFile(content, filename, mimeType) {
        var blob = new Blob([content], { type: mimeType });
        var url = URL.createObjectURL(blob);
        var a = document.createElement("a");
        a.href = url;
        a.download = filename;
        a.click();
        URL.revokeObjectURL(url);
      }

      function showStatus(elementId, message, type) {
        var element = document.getElementById(elementId);
        element.textContent = message;
        element.className = "status-message " + type;
        element.style.display = "block";

        setTimeout(function() {
          element.style.display = "none";
        }, 5000);
      }

      // Initialize EmailJS
      if (typeof emailjs !== 'undefined' && EMAILJS_CONFIG.publicKey) {
        emailjs.init(EMAILJS_CONFIG.publicKey);
      }

      // Initialize application
      window.addEventListener("load", function() {
        document.getElementById("eventDate").value = new Date().toISOString().split("T")[0];

        initializeFirebase();
        
        document.getElementById('loadingOverlay').style.display = 'none';

        if (localData.eventConfig.timeSlots.length === 0) {
          generateTimeSlots();
        }

        document.getElementById("overlay").addEventListener("click", function(e) {
          if (e.target === this) {
            closeBookingForm();
            closeLoginModal();
            closeConfirmationModal();
            closePasswordChangeModal();
          }
        });
      });

      window.addEventListener('beforeunload', function() {
        unsubscribeListeners.forEach(function(unsubscribe) {
          unsubscribe();
        });
        
        if (display4KWindow && !display4KWindow.closed) {
          display4KWindow.close();
        }
      });
    </script>
  </body>
</html>
