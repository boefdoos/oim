<!DOCTYPE html>
<html lang="nl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gesprekstafel Boekingssysteem</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìÖ</text></svg>" />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        background: #f8f9fa;
        min-height: 100vh;
        padding: 20px;
        color: #333;
        line-height: 1.5;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        border-radius: 8px;
        padding: 40px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      h1 {
        text-align: center;
        margin-bottom: 20px;
        color: #2c3e50;
        font-size: 1.8rem;
        font-weight: 500;
      }

      h2 {
        text-align: center;
        margin-bottom: 30px;
        color: #34495e;
        font-size: 1.3rem;
        font-weight: 500;
        border-bottom: 1px solid #ecf0f1;
        padding-bottom: 30px;
      }

      h3 {
        margin-bottom: 15px;
        color: #2c3e50;
        font-size: 1.1rem;
        font-weight: 500;
      }

      .section {
        margin-bottom: 30px;
        padding: 20px;
        background: #fafbfc;
        border-radius: 6px;
        border: 1px solid #e1e8ed;
      }

      .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
      }

      .form-group {
        display: flex;
        flex-direction: column;
      }

      label {
        margin-bottom: 5px;
        font-weight: 500;
        color: #555;
        font-size: 0.9rem;
      }

      input, select, button {
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 0.9rem;
        transition: border-color 0.2s ease;
      }

      input:focus, select:focus {
        outline: none;
        border-color: #3498db;
      }

      button {
        background: #3498db;
        color: white;
        border: none;
        cursor: pointer;
        font-weight: 500;
        transition: background-color 0.2s ease;
      }

      button:hover {
        background: #2980b9;
      }

      button:disabled {
        background: #bdc3c7;
        cursor: not-allowed;
      }

      .btn-secondary {
        background: #95a5a6;
      }

      .btn-secondary:hover {
        background: #7f8c8d;
      }

      .btn-danger {
        background: #e74c3c;
      }

      .btn-danger:hover {
        background: #c0392b;
      }

      .btn-success {
        background: #27ae60;
      }

      .btn-success:hover {
        background: #229954;
      }

      .admin-access-btn {
        position: fixed;
        bottom: 20px;
        right: 20px;
        width: 40px;
        height: 40px;
        background: #95a5a6;
        border: none;
        border-radius: 50%;
        cursor: pointer;
        font-size: 14px;
        color: white;
        transition: background-color 0.2s ease;
        z-index: 100;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
      }

      .admin-access-btn:hover {
        background: #7f8c8d;
      }

      .client-booking-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
        gap: 20px;
        margin-top: 20px;
      }

      .client-table-card {
        background: white;
        border-radius: 6px;
        padding: 20px;
        border: 1px solid #e1e8ed;
        transition: box-shadow 0.2s ease;
      }

      .client-table-card:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }

      .table-header {
        text-align: center;
        margin-bottom: 15px;
        padding-bottom: 15px;
        border-bottom: 1px solid #ecf0f1;
      }

      .table-title {
        font-size: 1.1rem;
        font-weight: 500;
        color: #2c3e50;
        margin-bottom: 5px;
      }

      .speakers {
        font-size: 0.9rem;
        color: #7f8c8d;
      }

      .time-slots-container {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .time-slot-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 10px 12px;
        border-radius: 4px;
        border: 1px solid #ddd;
        transition: all 0.2s ease;
      }

      .time-slot-item.available {
        background: #f8fff9;
        border-color: #27ae60;
      }

      .time-slot-item.available:hover {
        background: #e8f5e8;
      }

      .time-slot-item.booked {
        background: #fdf2f2;
        border-color: #e74c3c;
      }

      .time-info {
        font-weight: 500;
        color: #2c3e50;
        font-size: 0.9rem;
      }

      .slot-btn {
        padding: 6px 12px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-weight: 500;
        font-size: 0.8rem;
        transition: background-color 0.2s ease;
      }

      .slot-btn.available {
        background: #27ae60;
        color: white;
      }

      .slot-btn.available:hover {
        background: #229954;
      }

      .slot-btn.booked {
        background: #bdc3c7;
        color: #7f8c8d;
        cursor: not-allowed;
      }

      .modal {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        padding: 25px;
        border-radius: 6px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        z-index: 1000;
        min-width: 350px;
        max-width: 500px;
      }

      .overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 999;
      }

      .close-btn {
        position: absolute;
        top: 10px;
        right: 10px;
        background: none;
        border: none;
        font-size: 18px;
        cursor: pointer;
        color: #7f8c8d;
      }

      .status-message {
        padding: 10px;
        border-radius: 4px;
        margin-top: 10px;
        text-align: center;
        font-size: 0.9rem;
      }

      .success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }

      .error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }

      .warning {
        background: #fff3cd;
        color: #856404;
        border: 1px solid #ffeaa7;
      }

      .nav-tabs {
        display: flex;
        margin-bottom: 20px;
        border-bottom: 1px solid #dee2e6;
      }

      .nav-tab {
        padding: 10px 20px;
        background: none;
        border: none;
        border-bottom: 2px solid transparent;
        cursor: pointer;
        font-weight: 500;
        color: #6c757d;
        transition: all 0.2s ease;
      }

      .nav-tab.active {
        color: #3498db;
        border-bottom-color: #3498db;
      }

      .nav-tab:hover {
        color: #3498db;
      }

      .tab-content {
        display: none;
      }

      .tab-content.active {
        display: block;
      }

      .admin-interface {
        display: none;
      }

      .client-interface {
        display: block;
      }

      .tables-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 15px;
        margin-top: 20px;
      }

      .table-card {
        padding: 15px;
        border: 1px solid #e1e8ed;
        border-radius: 6px;
        background: white;
      }

      .bookings-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
        font-size: 0.9rem;
      }

      .bookings-table th,
      .bookings-table td {
        padding: 10px;
        border: 1px solid #dee2e6;
        text-align: left;
      }

      .bookings-table th {
        background: #f8f9fa;
        font-weight: 500;
      }

      .bookings-table tr:nth-child(even) {
        background: #f8f9fa;
      }

      .event-info {
        text-align: center;
        margin-bottom: 20px;
        color: #6c757d;
        font-size: 0.95rem;
      }

      .booking-actions {
        display: flex;
        gap: 10px;
        margin-top: 15px;
      }

      .confirmation-details {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 4px;
        margin: 15px 0;
        border: 1px solid #e9ecef;
      }

      .email-preview {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 4px;
        margin-top: 15px;
        border: 1px solid #e9ecef;
      }

      .hidden {
        display: none;
      }

      .admin-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }

      .admin-user-info {
        display: flex;
        align-items: center;
        gap: 15px;
        color: #666;
        font-size: 0.9rem;
      }

      .connection-status {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.7rem;
        font-weight: 400;
        z-index: 200;
        transition: all 0.3s ease;
        opacity: 0.7;
      }

      .connection-status.connected {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }

      .connection-status.disconnected {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }

      .sync-indicator {
        display: inline-block;
        width: 6px;
        height: 6px;
        border-radius: 50%;
        margin-right: 6px;
        animation: pulse 2s infinite;
      }

      .sync-indicator.syncing {
        background: #ffc107;
      }

      .sync-indicator.synced {
        background: #28a745;
      }

      @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.5; }
        100% { opacity: 1; }
      }

      .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.9);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 2000;
        font-size: 1.2rem;
        color: #666;
      }

      .firebase-config-section {
        background: #e8f5e8;
        border: 1px solid #b3d4fc;
        padding: 15px;
        border-radius: 4px;
        margin-bottom: 20px;
      }

      .firebase-config-section h3 {
        color: #155724;
        margin-bottom: 10px;
      }

      .config-actions {
        display: flex;
        gap: 10px;
      }

      .user-management {
        background: #fff3cd;
        border: 1px solid #ffeaa7;
        padding: 15px;
        border-radius: 4px;
        margin-bottom: 20px;
      }

      .user-management h3 {
        color: #856404;
        margin-bottom: 10px;
      }

      .auth-form {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        margin-bottom: 15px;
      }

      .auth-actions {
        display: flex;
        gap: 10px;
        align-items: center;
      }
    </style>
  </head>
  <body>
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
      <div>
        <div class="sync-indicator syncing"></div>
        Laden...
      </div>
    </div>

    <!-- Connection Status -->
    <div id="connectionStatus" class="connection-status disconnected">
      <span class="sync-indicator syncing"></span>‚óã
    </div>

    <div class="container">
      <!-- CLIENT INTERFACE -->
      <div id="client-interface" class="client-interface">
        <h1>Ostend Is Music Sectordag 2025</h1>
        <h2>Expertenhub: boek je gesprekstafel(s)!</h2>
        <div class="event-info" id="eventInfo">Evenement informatie wordt geladen...</div>
        <div class="client-booking-grid" id="clientBookingGrid">
          Beschikbare tijdslots worden geladen...
        </div>
      </div>

      <!-- ADMIN ACCESS BUTTON -->
      <button class="admin-access-btn" onclick="showLoginModal()" title="Admin Toegang">‚öô</button>

      <!-- ADMIN INTERFACE -->
      <div id="admin-interface" class="admin-interface">
        <div class="admin-header">
          <h1>Admin Dashboard</h1>
          <div class="admin-user-info">
            <span id="adminUserEmail"></span>
            <button onclick="logout()" class="btn-secondary">Uitloggen</button>
            <button onclick="switchToClient()" class="btn-secondary">Terug naar Boekingen</button>
          </div>
        </div>

        <!-- LIVE DISPLAY SECTION -->
        <div class="firebase-config-section">
          <h3>üì∫ Live 4K Display</h3>
          <p style="margin-bottom: 15px; font-size: 0.9rem; color: #155724;">
            Open een real-time 4K display scherm voor TV monitors of grote schermen.
          </p>
          <div class="config-actions">
            <button onclick="open4KDisplay()" class="btn-success" style="padding: 12px 20px; font-size: 1rem;">üñ•Ô∏è Open 4K Live Display</button>
            <button onclick="close4KDisplay()" class="btn-secondary" style="margin-left: 10px;">Sluit Display</button>
          </div>
          <div id="displayStatus" class="status-message" style="display: none"></div>
        </div>

        <!-- USER MANAGEMENT SECTION -->
        <div class="user-management">
          <h3>Admin Gebruikersbeheer</h3>
          <p style="margin-bottom: 15px; font-size: 0.9rem;">
            Maak admin gebruikers aan die toegang hebben tot dit dashboard.
          </p>
          <div class="auth-form">
            <input type="email" id="newUserEmail" placeholder="Admin E-mail" />
            <input type="password" id="newUserPassword" placeholder="Tijdelijk Wachtwoord (min 6 tekens)" />
          </div>
          <div class="auth-actions">
            <button onclick="createAdminUser()" class="btn-success">Admin Gebruiker Aanmaken</button>
            <button onclick="changePassword()" class="btn-secondary">Mijn Wachtwoord Wijzigen</button>
          </div>
          <div id="userManagementStatus" class="status-message" style="display: none"></div>
        </div>

        <div class="nav-tabs">
          <button class="nav-tab active" onclick="switchTab('setup')">Evenement Instellen</button>
          <button class="nav-tab" onclick="switchTab('bookings')">Boekingen Beheren</button>
          <button class="nav-tab" onclick="switchTab('export')">Exporteren & Rapporten</button>
        </div>

        <div id="setup-tab" class="tab-content active">
          <div class="section">
            <h2>Evenement Configuratie</h2>
            <div class="form-grid">
              <div class="form-group">
                <label for="eventDate">Evenement Datum:</label>
                <input type="date" id="eventDate" />
              </div>
              <div class="form-group">
                <label for="startTime">Starttijd:</label>
                <input type="time" id="startTime" value="09:00" />
              </div>
              <div class="form-group">
                <label for="endTime">Eindtijd:</label>
                <input type="time" id="endTime" value="17:00" />
              </div>
              <div class="form-group">
                <label for="slotDuration">Tijdslot Duur (minuten):</label>
                <input type="number" id="slotDuration" value="10" min="5" max="30" />
              </div>
            </div>
            <button onclick="generateTimeSlots()">Tijdslots Genereren</button>
            <div id="eventStatus" class="status-message" style="display: none"></div>
          </div>

          <div class="section">
            <h2>Tafel Configuratie</h2>
            <div class="form-grid">
              <div class="form-group">
                <label for="tableName">Tafel Naam:</label>
                <input type="text" id="tableName" placeholder="bijv. AI & Technologie" />
              </div>
              <div class="form-group">
                <label for="speaker1">Spreker 1:</label>
                <input type="text" id="speaker1" placeholder="Spreker naam" />
              </div>
              <div class="form-group">
                <label for="speaker2">Spreker 2:</label>
                <input type="text" id="speaker2" placeholder="Spreker naam" />
              </div>
            </div>
            <button onclick="addTable()">Tafel Toevoegen</button>
            <div class="tables-grid" id="tablesGrid"></div>
          </div>
        </div>

        <div id="bookings-tab" class="tab-content">
          <div class="section">
            <h2>Huidige Boekingen</h2>
            <div id="bookingsOverview">Boekingen worden geladen...</div>
          </div>
        </div>

        <div id="export-tab" class="tab-content">
          <div class="section">
            <h2>Exporteren & Rapporten</h2>
            <button class="btn-success" onclick="exportToCSV()">Exporteren naar CSV</button>
            <button class="btn-success" onclick="exportToExcel()" style="margin-left: 10px">Exporteren naar Excel</button>
            <div id="exportStatus" class="status-message" style="display: none"></div>
          </div>
        </div>
      </div>

      <!-- MODALS -->
      <div class="overlay" id="overlay"></div>

      <!-- LOGIN MODAL -->
      <div class="modal" id="loginModal">
        <h3>Admin Inloggen</h3>
        <div class="form-group">
          <label for="adminEmail">E-mail:</label>
          <input type="email" id="adminEmail" placeholder="Voer admin e-mail in" style="width: 100%; margin-bottom: 15px" required />
        </div>
        <div class="form-group">
          <label for="adminPassword">Wachtwoord:</label>
          <input type="password" id="adminPassword" placeholder="Voer wachtwoord in" onkeypress="if(event.key==='Enter') loginAdmin()" style="width: 100%; margin-bottom: 15px" required />
        </div>
        <div style="text-align: center">
          <button onclick="loginAdmin()" style="margin-right: 10px">Inloggen</button>
          <button onclick="closeLoginModal()" class="btn-secondary">Annuleren</button>
        </div>
        <div id="loginError" class="status-message error" style="display: none"></div>
      </div>

      <!-- BOOKING FORM -->
      <div class="modal" id="bookingForm">
        <button class="close-btn" onclick="closeBookingForm()">&times;</button>
        <h3>Boek Uw Gesprek</h3>
        <div class="form-group">
          <label for="userName">Uw Naam: *</label>
          <input type="text" id="userName" required />
        </div>
        <div class="form-group">
          <label for="userEmail">E-mail: *</label>
          <input type="email" id="userEmail" required onblur="checkEmailBookingLimit()" />
          <div id="emailBookingStatus" class="status-message" style="display: none; margin-top: 5px; text-align: left; padding: 5px;"></div>
        </div>
        <div class="form-group">
          <label for="userArtistName">Artiest Naam/Band: *</label>
          <input type="text" id="userArtistName" required />
        </div>
        <div class="form-group">
          <label>Geselecteerd Tijdslot:</label>
          <div id="selectedSlotInfo" class="confirmation-details"></div>
        </div>
        <div class="booking-actions">
          <button onclick="confirmBooking()" id="confirmBookingBtn">Boeking Bevestigen</button>
        </div>
        <div id="bookingStatus" class="status-message" style="display: none"></div>
      </div>

      <!-- CONFIRMATION MODAL -->
      <div class="modal" id="confirmationModal">
        <button class="close-btn" onclick="closeConfirmationModal()">&times;</button>
        <h3>Boeking Bevestigd</h3>
        <div id="confirmationDetails"></div>
        <div class="booking-actions">
          <button onclick="addToCalendar()">Toevoegen aan Kalender</button>
        </div>
      </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    
    <!-- EmailJS SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>

    <script>
      var db = null;
      var auth = null;
      var isFirebaseInitialized = false;
      var isOnline = false;
      var unsubscribeListeners = [];
      var currentUser = null;
      var display4KWindow = null;
      var currentBookingConfirmation = null;
      var currentBookingSelection = null;
      var isAdminMode = false;

      var DEFAULT_FIREBASE_CONFIG = {
        apiKey: "AIzaSyDTG9ciegpaJBvy4LZt9s9TdemnNAyz1EQ",
        authDomain: "ostend-is-music.firebaseapp.com",
        projectId: "ostend-is-music",
        storageBucket: "ostend-is-music.firebasestorage.app",
        messagingSenderId: "481655541764",
        appId: "1:481655541764:web:60b142aafa966c24466551"
      };

      var EMAILJS_CONFIG = {
        serviceId: "service_0m2owju", 
        templateId: "template_7xq3pho", 
        publicKey: "VehBeO9qQGs5TbvvnY", 
        fromName: "Event Team"
      };

      var localData = {
        eventConfig: {
          date: "",
          startTime: "09:00",
          endTime: "17:00",
          slotDuration: 10,
          timeSlots: []
        },
        tables: [],
        bookings: {}
      };

      var MAX_BOOKINGS_PER_EMAIL = 3;

      function countBookingsByEmail(email) {
        var normalizedEmail = email.toLowerCase().trim();
        return Object.values(localData.bookings).filter(function(booking) {
          return booking.email.toLowerCase().trim() === normalizedEmail;
        }).length;
      }

      function getBookingsByEmail(email) {
        var normalizedEmail = email.toLowerCase().trim();
        return Object.values(localData.bookings).filter(function(booking) {
          return booking.email.toLowerCase().trim() === normalizedEmail;
        });
      }

      function checkEmailBookingLimit() {
        var email = document.getElementById("userEmail").value.trim();
        var statusElement = document.getElementById("emailBookingStatus");
        
        if (!email) {
          statusElement.style.display = "none";
          return;
        }

        var emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(email)) {
          statusElement.textContent = "Voer een geldig e-mailadres in";
          statusElement.className = "status-message error";
          statusElement.style.display = "block";
          return;
        }

        var currentBookingCount = countBookingsByEmail(email);
        var remainingBookings = MAX_BOOKINGS_PER_EMAIL - currentBookingCount;

        var confirmBtn = document.getElementById('confirmBookingBtn');
        
        if (remainingBookings <= 0) {
          statusElement.textContent = "Maximum boekingen bereikt";
          statusElement.className = "status-message error";
          statusElement.style.display = "block";
          if (confirmBtn) {
            confirmBtn.disabled = true;
            confirmBtn.textContent = 'Maximum Boekingen Bereikt';
          }
        } else if (currentBookingCount > 0) {
          statusElement.textContent = currentBookingCount + "/" + MAX_BOOKINGS_PER_EMAIL + " boekingen gebruikt";
          statusElement.className = "status-message warning";
          statusElement.style.display = "block";
          if (confirmBtn) {
            confirmBtn.disabled = false;
            confirmBtn.textContent = 'Boeking Bevestigen';
          }
        } else {
          statusElement.textContent = remainingBookings + "/" + MAX_BOOKINGS_PER_EMAIL + " boekingen beschikbaar";
          statusElement.className = "status-message success";
          statusElement.style.display = "block";
          if (confirmBtn) {
            confirmBtn.disabled = false;
            confirmBtn.textContent = 'Boeking Bevestigen';
          }
        }
      }

      function open4KDisplay() {
        if (display4KWindow && !display4KWindow.closed) {
          display4KWindow.focus();
          showDisplayStatus("4K Display is al geopend", "warning");
          return;
        }

        try {
          display4KWindow = window.open('', '4KDisplay', 'width=1920,height=1080,scrollbars=no,resizable=yes');
          
          if (!display4KWindow) {
            throw new Error('Popup werd geblokkeerd');
          }

          var html = buildDisplayHTML();
          display4KWindow.document.open();
          display4KWindow.document.write(html);
          display4KWindow.document.close();
          
          setupDisplayRefresh();
          showDisplayStatus("4K Display geopend", "success");
          
        } catch (error) {
          showDisplayStatus("Fout: " + error.message, "error");
        }
      }

      function buildDisplayHTML() {
        var parts = [];
        parts.push('<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Live Display</title>');
        parts.push('<style>');
        parts.push('body{margin:0;padding:20px;background:linear-gradient(45deg,#667eea,#764ba2);color:white;font-family:Arial,sans-serif;}');
        parts.push('.header{text-align:center;margin-bottom:30px;}');
        parts.push('.title{font-size:2.5rem;margin-bottom:10px;}');
        parts.push('.subtitle{font-size:1.2rem;margin-bottom:5px;}');
        parts.push('.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px;}');
        parts.push('.table{background:rgba(255,255,255,0.9);color:#333;border-radius:10px;padding:15px;}');
        parts.push('.table-header{background:#2c3e50;color:white;padding:10px;border-radius:5px;text-align:center;margin-bottom:10px;}');
        parts.push('.table-name{font-weight:bold;font-size:1.1rem;}');
        parts.push('.slot{display:flex;justify-content:space-between;padding:8px;margin:5px 0;border-radius:5px;}');
        parts.push('.slot.available{background:#d4edda;border-left:4px solid #28a745;}');
        parts.push('.slot.booked{background:#fff3cd;border-left:4px solid #ffc107;}');
        parts.push('.time{font-weight:bold;}');
        parts.push('.info{font-weight:bold;}');
        parts.push('.footer{text-align:center;margin-top:30px;font-size:0.9rem;}');
        parts.push('</style></head><body>');
        
        parts.push('<div class="header">');
        parts.push('<div class="title">Gesprekstafel Schema</div>');
        
        if (localData.eventConfig.date) {
          var eventDate = new Date(localData.eventConfig.date).toLocaleDateString("nl-NL");
          parts.push('<div class="subtitle">' + eventDate + '</div>');
          parts.push('<div class="subtitle">' + localData.eventConfig.startTime + ' - ' + localData.eventConfig.endTime + '</div>');
        }
        
        parts.push('</div>');
        parts.push('<div class="grid">');
        
        for (var i = 0; i < localData.tables.length; i++) {
          var table = localData.tables[i];
          parts.push('<div class="table">');
          parts.push('<div class="table-header">');
          parts.push('<div class="table-name">Tafel ' + (i + 1) + ': ' + table.name + '</div>');
          parts.push('<div>met ' + table.speaker1 + ' & ' + table.speaker2 + '</div>');
          parts.push('</div>');
          
          for (var j = 0; j < localData.eventConfig.timeSlots.length; j++) {
            var slot = localData.eventConfig.timeSlots[j];
            var bookingKey = table.id + '-' + slot.index;
            var booking = localData.bookings[bookingKey];
            
            if (booking) {
              parts.push('<div class="slot booked">');
              parts.push('<div class="time">' + slot.start + ' - ' + slot.end + '</div>');
              parts.push('<div class="info">' + booking.name + '</div>');
              parts.push('</div>');
            } else {
              parts.push('<div class="slot available">');
              parts.push('<div class="time">' + slot.start + ' - ' + slot.end + '</div>');
              parts.push('<div class="info">Beschikbaar</div>');
              parts.push('</div>');
            }
          }
          
          parts.push('</div>');
        }
        
        parts.push('</div>');
        parts.push('<div class="footer">Laatst bijgewerkt: ' + new Date().toLocaleString() + '</div>');
        parts.push('<script>setInterval(function(){if(window.opener && !window.opener.closed){location.reload();}else{window.close();}},5000);</script>');
        parts.push('</body></html>');
        
        return parts.join('');
      }

      function setupDisplayRefresh() {
        if (!display4KWindow) return;
        
        setInterval(function() {
          if (display4KWindow && !display4KWindow.closed) {
            try {
              var newHtml = buildDisplayHTML();
              display4KWindow.document.open();
              display4KWindow.document.write(newHtml);
              display4KWindow.document.close();
            } catch (error) {
              console.log('Display update error:', error);
            }
          } else {
            display4KWindow = null;
          }
        }, 3000);
      }

      function close4KDisplay() {
        if (display4KWindow) {
          display4KWindow.close();
          display4KWindow = null;
          showDisplayStatus("Display gesloten", "success");
        }
      }

      function showDisplayStatus(message, type) {
        var element = document.getElementById('displayStatus');
        element.textContent = message;
        element.className = 'status-message ' + type;
        element.style.display = 'block';
        setTimeout(function() {
          element.style.display = 'none';
        }, 3000);
      }

      function initializeFirebase() {
        try {
          updateConnectionStatus('connecting');
          
          if (!firebase.apps.length) {
            firebase.initializeApp(DEFAULT_FIREBASE_CONFIG);
          }
          
          db = firebase.firestore();
          auth = firebase.auth();
          
          auth.onAuthStateChanged(function(user) {
            currentUser = user;
            if (user && isAdminMode) {
              document.getElementById('adminUserEmail').textContent = user.email;
            }
          });
          
          db.collection('system').doc('test').get().then(function() {
            isFirebaseInitialized = true;
            isOnline = true;
            updateConnectionStatus('connected');
            setupRealtimeListeners();
            loadDataFromFirestore();
          }).catch(function() {
            isOnline = false;
            updateConnectionStatus('disconnected');
            loadDataFromLocalStorage();
          });
          
        } catch (error) {
          isOnline = false;
          updateConnectionStatus('disconnected');
          loadDataFromLocalStorage();
        }
      }

      function updateConnectionStatus(status) {
        var statusElement = document.getElementById('connectionStatus');
        switch (status) {
          case 'connected':
            statusElement.className = 'connection-status connected';
            statusElement.innerHTML = '<span class="sync-indicator synced"></span>‚óè';
            break;
          case 'connecting':
            statusElement.className = 'connection-status disconnected';  
            statusElement.innerHTML = '<span class="sync-indicator syncing"></span>‚óè';
            break;
          default:
            statusElement.className = 'connection-status disconnected';
            statusElement.innerHTML = '<span class="sync-indicator"></span>‚óã';
        }
      }

      function setupRealtimeListeners() {
        if (!db) return;

        var eventConfigRef = db.collection('system').doc('eventConfig');
        var unsubEventConfig = eventConfigRef.onSnapshot(function(doc) {
          if (doc.exists) {
            localData.eventConfig = doc.data();
            updateEventUI();
            renderClientInterface();
          }
        });

        var tablesRef = db.collection('tables');
        var unsubTables = tablesRef.onSnapshot(function(snapshot) {
          localData.tables = [];
          snapshot.forEach(function(doc) {
            localData.tables.push(Object.assign({id: doc.id}, doc.data()));
          });
          localData.tables.sort(function(a, b) { return (a.order || 0) - (b.order || 0); });
          renderTables();
          renderClientInterface();
        });

        var bookingsRef = db.collection('bookings');
        var unsubBookings = bookingsRef.onSnapshot(function(snapshot) {
          localData.bookings = {};
          snapshot.forEach(function(doc) {
            localData.bookings[doc.id] = doc.data();
          });
          renderBookingsOverview();
          renderClientInterface();
        });

        unsubscribeListeners = [unsubEventConfig, unsubTables, unsubBookings];
      }

      function showLoginModal() {
        document.getElementById("overlay").style.display = "block";
        document.getElementById("loginModal").style.display = "block";
        document.getElementById("adminEmail").value = "";
        document.getElementById("adminPassword").value = "";
        document.getElementById("loginError").style.display = "none";
      }

      function closeLoginModal() {
        document.getElementById("overlay").style.display = "none";
        document.getElementById("loginModal").style.display = "none";
      }

      function loginAdmin() {
        var email = document.getElementById("adminEmail").value.trim();
        var password = document.getElementById("adminPassword").value;

        if (!email || !password) {
          showLoginError("Voer e-mail en wachtwoord in");
          return;
        }

        if (!auth) {
          showLoginError("Authenticatie niet beschikbaar");
          return;
        }

        auth.signInWithEmailAndPassword(email, password).then(function(userCredential) {
          currentUser = userCredential.user;
          isAdminMode = true;
          closeLoginModal();
          switchToAdmin();
        }).catch(function(error) {
          var errorMessage = "Inloggen mislukt";
          switch (error.code) {
            case 'auth/user-not-found':
              errorMessage = "Geen admin account gevonden";
              break;
            case 'auth/wrong-password':
              errorMessage = "Onjuist wachtwoord";
              break;
            default:
              errorMessage = error.message;
          }
          showLoginError(errorMessage);
        });
      }

      function showLoginError(message) {
        var element = document.getElementById("loginError");
        element.textContent = message;
        element.style.display = "block";
      }

      function logout() {
        if (auth && currentUser) {
          auth.signOut();
        }
        currentUser = null;
        isAdminMode = false;
        switchToClient();
      }

      function createAdminUser() {
        var email = document.getElementById("newUserEmail").value.trim();
        var password = document.getElementById("newUserPassword").value;

        if (!email || !password) {
          showUserManagementStatus("Voer e-mail en wachtwoord in", "error");
          return;
        }

        if (!auth) {
          showUserManagementStatus("Authenticatie niet beschikbaar", "error");
          return;
        }

        auth.createUserWithEmailAndPassword(email, password).then(function() {
          showUserManagementStatus("Admin gebruiker aangemaakt", "success");
          document.getElementById("newUserEmail").value = "";
          document.getElementById("newUserPassword").value = "";
        }).catch(function(error) {
          showUserManagementStatus("Fout: " + error.message, "error");
        });
      }

      function showUserManagementStatus(message, type) {
        var element = document.getElementById("userManagementStatus");
        element.textContent = message;
        element.className = "status-message " + type;
        element.style.display = "block";
        setTimeout(function() { element.style.display = "none"; }, 3000);
      }

      function saveEventConfigToFirestore() {
        if (db) {
          return db.collection('system').doc('eventConfig').set(localData.eventConfig);
        }
        return Promise.resolve();
      }

      function saveTableToFirestore(table) {
        if (db) {
          return db.collection('tables').add(table).then(function(docRef) {
            return docRef.id;
          });
        }
        return Promise.resolve(table.id);
      }

      function removeTableFromFirestore(tableId) {
        if (db) {
          return db.collection('tables').doc(tableId).delete();
        }
        return Promise.resolve();
      }

      function saveBookingToFirestore(bookingKey, booking) {
        if (db) {
          return db.collection('bookings').doc(bookingKey).set(booking);
        }
        return Promise.resolve();
      }

      function removeBookingFromFirestore(bookingKey) {
        if (db) {
          return db.collection('bookings').doc(bookingKey).delete();
        }
        return Promise.resolve();
      }

      function loadDataFromFirestore() {
        if (!db) return Promise.resolve();

        return Promise.all([
          db.collection('system').doc('eventConfig').get(),
          db.collection('tables').get(),
          db.collection('bookings').get()
        ]).then(function(results) {
          var eventDoc = results[0];
          var tablesSnap = results[1];
          var bookingsSnap = results[2];

          if (eventDoc.exists) {
            localData.eventConfig = eventDoc.data();
          }

          localData.tables = [];
          tablesSnap.forEach(function(doc) {
            localData.tables.push(Object.assign({id: doc.id}, doc.data()));
          });
          localData.tables.sort(function(a, b) { return (a.order || 0) - (b.order || 0); });

          localData.bookings = {};
          bookingsSnap.forEach(function(doc) {
            localData.bookings[doc.id] = doc.data();
          });

          updateUI();
        });
      }

      function saveDataToLocalStorage() {
        localStorage.setItem('bookingSystemData', JSON.stringify(localData));
      }

      function loadDataFromLocalStorage() {
        var stored = localStorage.getItem('bookingSystemData');
        if (stored) {
          localData = Object.assign({}, localData, JSON.parse(stored));
        }
        updateUI();
      }

      function updateUI() {
        updateEventUI();
        renderTables();
        renderBookingsOverview();
        renderClientInterface();
      }

      function updateEventUI() {
        if (localData.eventConfig.date) {
          document.getElementById('eventDate').value = localData.eventConfig.date;
        }
        document.getElementById('startTime').value = localData.eventConfig.startTime;
        document.getElementById('endTime').value = localData.eventConfig.endTime;
        document.getElementById('slotDuration').value = localData.eventConfig.slotDuration;
      }

      function switchToAdmin() {
        document.getElementById("client-interface").style.display = "none";
        document.getElementById("admin-interface").style.display = "block";
        if (currentUser) {
          document.getElementById('adminUserEmail').textContent = currentUser.email;
        }
        renderBookingsOverview();
      }

      function switchToClient() {
        isAdminMode = false;
        document.getElementById("client-interface").style.display = "block";
        document.getElementById("admin-interface").style.display = "none";
        renderClientInterface();
      }

      function switchTab(tabName) {
        var tabs = document.querySelectorAll(".nav-tab");
        for (var i = 0; i < tabs.length; i++) {
          tabs[i].classList.remove("active");
        }
        
        var targetTab = document.querySelector('[onclick="switchTab(\'' + tabName + '\')"]');
        if (targetTab) targetTab.classList.add("active");

        var contents = document.querySelectorAll(".tab-content");
        for (var i = 0; i < contents.length; i++) {
          contents[i].classList.remove("active");
        }
        
        var targetContent = document.getElementById(tabName + "-tab");
        if (targetContent) targetContent.classList.add("active");

        if (tabName === "bookings") {
          renderBookingsOverview();
        }
      }

      function generateTimeSlots() {
        var date = document.getElementById("eventDate").value;
        var startTime = document.getElementById("startTime").value;
        var endTime = document.getElementById("endTime").value;
        var duration = parseInt(document.getElementById("slotDuration").value);

        if (!date || !startTime || !endTime) {
          showStatus("eventStatus", "Vul alle velden in", "error");
          return;
        }

        localData.eventConfig.date = date;
        localData.eventConfig.startTime = startTime;
        localData.eventConfig.endTime = endTime;
        localData.eventConfig.slotDuration = duration;

        var slots = [];
        var start = new Date(date + "T" + startTime);
        var end = new Date(date + "T" + endTime);
        var current = new Date(start);
        var slotIndex = 0;

        while (current < end) {
          var slotEnd = new Date(current.getTime() + duration * 60000);
          if (slotEnd <= end) {
            slots.push({
              index: slotIndex++,
              start: current.toTimeString().slice(0, 5),
              end: slotEnd.toTimeString().slice(0, 5)
            });
          }
          current = new Date(slotEnd);
        }

        localData.eventConfig.timeSlots = slots;
        saveEventConfigToFirestore();
        showStatus("eventStatus", slots.length + " tijdslots gegenereerd", "success");
      }

      function addTable() {
        var name = document.getElementById("tableName").value.trim();
        var speaker1 = document.getElementById("speaker1").value.trim();
        var speaker2 = document.getElementById("speaker2").value.trim();

        if (!name || !speaker1 || !speaker2) {
          alert("Vul alle velden in");
          return;
        }

        var table = {
          name: name,
          speaker1: speaker1,
          speaker2: speaker2,
          order: localData.tables.length
        };

        if (db) {
          saveTableToFirestore(table).then(function(tableId) {
            table.id = tableId;
            clearTableForm();
          });
        } else {
          table.id = "table_" + Date.now();
          localData.tables.push(table);
          renderTables();
          saveDataToLocalStorage();
          clearTableForm();
        }
      }

      function clearTableForm() {
        document.getElementById("tableName").value = "";
        document.getElementById("speaker1").value = "";
        document.getElementById("speaker2").value = "";
      }

      function renderTables() {
        var grid = document.getElementById("tablesGrid");
        
        if (localData.tables.length === 0) {
          grid.innerHTML = '<p style="text-align: center; padding: 20px;">Nog geen tafels.</p>';
          return;
        }
        
        var html = '';
        for (var i = 0; i < localData.tables.length; i++) {
          var table = localData.tables[i];
          html += '<div class="table-card">';
          html += '<h4>Tafel ' + (i + 1) + ': ' + table.name + '</h4>';
          html += '<p><strong>Sprekers:</strong> ' + table.speaker1 + ' & ' + table.speaker2 + '</p>';
          html += '<button onclick="removeTable(\'' + table.id + '\')" class="btn-danger">Verwijderen</button>';
          html += '</div>';
        }
        grid.innerHTML = html;
      }

      function removeTable(tableId) {
        if (confirm("Weet u zeker dat u deze tafel wilt verwijderen?")) {
          localData.tables = localData.tables.filter(function(t) { return t.id !== tableId; });
          renderTables();
          
          if (db) {
            removeTableFromFirestore(tableId);
          } else {
            saveDataToLocalStorage();
          }
        }
      }

      function renderClientInterface() {
        var eventInfo = document.getElementById("eventInfo");
        if (localData.eventConfig.date && localData.eventConfig.timeSlots.length > 0) {
          var eventDate = new Date(localData.eventConfig.date).toLocaleDateString("nl-NL");
          eventInfo.innerHTML = '<strong>' + eventDate + '</strong><br>' + 
                               localData.eventConfig.startTime + ' - ' + localData.eventConfig.endTime + 
                               '<br><small>Max ' + MAX_BOOKINGS_PER_EMAIL + ' boekingen per e-mail</small>';
        } else {
          eventInfo.innerHTML = "Evenement nog niet geconfigureerd";
        }

        var container = document.getElementById("clientBookingGrid");
        
        if (localData.tables.length === 0) {
          container.innerHTML = "<p>Geen tafels beschikbaar.</p>";
          return;
        }

        var html = '';
        for (var i = 0; i < localData.tables.length; i++) {
          var table = localData.tables[i];
          html += '<div class="client-table-card">';
          html += '<div class="table-header">';
          html += '<div class="table-title">Tafel ' + (i + 1) + ': ' + table.name + '</div>';
          html += '<div class="speakers">met ' + table.speaker1 + ' & ' + table.speaker2 + '</div>';
          html += '</div>';
          html += '<div class="time-slots-container">';
          
          for (var j = 0; j < localData.eventConfig.timeSlots.length; j++) {
            var slot = localData.eventConfig.timeSlots[j];
            var bookingKey = table.id + "-" + slot.index;
            var isBooked = localData.bookings[bookingKey];
            
            html += '<div class="time-slot-item ' + (isBooked ? 'booked' : 'available') + '">';
            html += '<div class="time-info">' + slot.start + ' - ' + slot.end + '</div>';
            if (isBooked) {
              html += '<button class="slot-btn booked" disabled>Geboekt</button>';
            } else {
              html += '<button class="slot-btn available" onclick="openBookingForm(\'' + table.id + '\', ' + slot.index + ')">Boeken</button>';
            }
            html += '</div>';
          }
          
          html += '</div></div>';
        }
        container.innerHTML = html;
      }

      function openBookingForm(tableId, slotIndex) {
        var table = localData.tables.find(function(t) { return t.id === tableId; });
        var slot = localData.eventConfig.timeSlots.find(function(s) { return s.index === slotIndex; });

        if (!table || !slot) {
          alert("Fout: Tafel of tijdslot niet gevonden");
          return;
        }

        currentBookingSelection = { tableId: tableId, slotIndex: slotIndex };

        var eventDate = new Date(localData.eventConfig.date).toLocaleDateString("nl-NL");
        document.getElementById("selectedSlotInfo").innerHTML = 
          '<strong>' + table.name + '</strong><br>' +
          eventDate + '<br>' + 
          slot.start + ' - ' + slot.end + '<br>' +
          'Sprekers: ' + table.speaker1 + ' & ' + table.speaker2;

        document.getElementById("overlay").style.display = "block";
        document.getElementById("bookingForm").style.display = "block";
        document.getElementById("userName").value = "";
        document.getElementById("userEmail").value = "";
        document.getElementById("userArtistName").value = "";
        
        var confirmBtn = document.getElementById('confirmBookingBtn');
        confirmBtn.disabled = false;
        confirmBtn.textContent = 'Boeking Bevestigen';
      }

      function closeBookingForm() {
        document.getElementById("overlay").style.display = "none";
        document.getElementById("bookingForm").style.display = "none";
        currentBookingSelection = null;
      }

      function confirmBooking() {
        var name = document.getElementById("userName").value.trim();
        var email = document.getElementById("userEmail").value.trim();
        var artistName = document.getElementById("userArtistName").value.trim();

        if (!name || !email || !artistName) {
          showStatus("bookingStatus", "Vul alle velden in", "error");
          return;
        }

        var emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(email)) {
          showStatus("bookingStatus", "Ongeldig e-mailadres", "error");
          return;
        }

        if (countBookingsByEmail(email) >= MAX_BOOKINGS_PER_EMAIL) {
          showStatus("bookingStatus", "Maximum boekingen bereikt", "error");
          return;
        }

        if (!currentBookingSelection) {
          showStatus("bookingStatus", "Geen tijdslot geselecteerd", "error");
          return;
        }

        var tableId = currentBookingSelection.tableId;
        var slotIndex = currentBookingSelection.slotIndex;
        var bookingKey = tableId + "-" + slotIndex;

        if (localData.bookings[bookingKey]) {
          showStatus("bookingStatus", "Tijdslot al geboekt", "error");
          return;
        }

        var table = localData.tables.find(function(t) { return t.id === tableId; });
        var slot = localData.eventConfig.timeSlots.find(function(s) { return s.index === slotIndex; });

        var booking = {
          name: name,
          email: email,
          artistName: artistName,
          tableId: tableId,
          slotIndex: slotIndex,
          tableName: table.name,
          speaker1: table.speaker1,
          speaker2: table.speaker2,
          timeSlot: slot.start + " - " + slot.end,
          date: localData.eventConfig.date,
          timestamp: new Date().toISOString()
        };

        showStatus("bookingStatus", "Boeking wordt verwerkt...", "success");

        saveBookingToFirestore(bookingKey, booking).then(function() {
          localData.bookings[bookingKey] = booking;
          currentBookingConfirmation = booking;

          if (typeof emailjs !== 'undefined') {
            var emailParams = {
              user_name: booking.name,
              user_email: booking.email,
              artist_name: booking.artistName,
              table_name: booking.tableName,
              speakers: booking.speaker1 + ' & ' + booking.speaker2,
              event_date: new Date(booking.date).toLocaleDateString("nl-NL"),
              time_slot: booking.timeSlot,
              to_email: booking.email
            };

            emailjs.send(EMAILJS_CONFIG.serviceId, EMAILJS_CONFIG.templateId, emailParams, EMAILJS_CONFIG.publicKey);
          }

          closeBookingForm();
          showConfirmationModal();
        });
      }

      function showConfirmationModal() {
        var booking = currentBookingConfirmation;
        var eventDate = new Date(booking.date).toLocaleDateString("nl-NL");

        document.getElementById("confirmationDetails").innerHTML = 
          '<div class="confirmation-details">' +
          '<strong>Boekingsdetails:</strong><br>' +
          '<strong>Naam:</strong> ' + booking.name + '<br>' +
          '<strong>E-mail:</strong> ' + booking.email + '<br>' +
          '<strong>Artiest/Band:</strong> ' + booking.artistName + '<br>' +
          '<strong>Tafel:</strong> ' + booking.tableName + '<br>' +
          '<strong>Sprekers:</strong> ' + booking.speaker1 + ' & ' + booking.speaker2 + '<br>' +
          '<strong>Datum:</strong> ' + eventDate + '<br>' +
          '<strong>Tijd:</strong> ' + booking.timeSlot +
          '</div>';

        document.getElementById("overlay").style.display = "block";
        document.getElementById("confirmationModal").style.display = "block";
      }

      function closeConfirmationModal() {
        document.getElementById("overlay").style.display = "none";
        document.getElementById("confirmationModal").style.display = "none";
      }

      function addToCalendar() {
        var booking = currentBookingConfirmation;
        var eventDate = new Date(booking.date);
        var timeParts = booking.timeSlot.split(" - ");
        var startParts = timeParts[0].split(":");
        var endParts = timeParts[1].split(":");

        var startTime = new Date(eventDate);
        startTime.setHours(parseInt(startParts[0]), parseInt(startParts[1]));

        var endTime = new Date(eventDate);
        endTime.setHours(parseInt(endParts[0]), parseInt(endParts[1]));

        var icsContent = 'BEGIN:VCALENDAR\nVERSION:2.0\nBEGIN:VEVENT\n';
        icsContent += 'DTSTART:' + startTime.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z\n';
        icsContent += 'DTEND:' + endTime.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z\n';
        icsContent += 'SUMMARY:Gesprekstafel: ' + booking.tableName + '\n';
        icsContent += 'DESCRIPTION:Gesprek met ' + booking.speaker1 + ' & ' + booking.speaker2 + '\n';
        icsContent += 'END:VEVENT\nEND:VCALENDAR';

        var blob = new Blob([icsContent], { type: 'text/calendar' });
        var url = URL.createObjectURL(blob);
        var a = document.createElement('a');
        a.href = url;
        a.download = 'gesprekstafel-boeking.ics';
        a.click();
        URL.revokeObjectURL(url);
      }

      function renderBookingsOverview() {
        var container = document.getElementById("bookingsOverview");
        var bookingsList = Object.values(localData.bookings);

        if (bookingsList.length === 0) {
          container.innerHTML = "<p>Nog geen boekingen.</p>";
          return;
        }

        var html = '<div style="background: #f8f9fa; padding: 15px; border-radius: 4px; margin-bottom: 20px;">';
        html += '<h4>Totale Boekingen: ' + bookingsList.length + '</h4></div>';
        
        html += '<table class="bookings-table">';
        html += '<thead><tr><th>Naam</th><th>E-mail</th><th>Artiest</th><th>Tafel</th><th>Tijd</th><th>Acties</th></tr></thead>';
        html += '<tbody>';
        
        for (var i = 0; i < bookingsList.length; i++) {
          var booking = bookingsList[i];
          var bookingKey = booking.tableId + "-" + booking.slotIndex;
          html += '<tr>';
          html += '<td>' + booking.name + '</td>';
          html += '<td>' + booking.email + '</td>';
          html += '<td>' + (booking.artistName || 'N/A') + '</td>';
          html += '<td>' + booking.tableName + '</td>';
          html += '<td>' + booking.timeSlot + '</td>';
          html += '<td><button onclick="cancelBooking(\'' + bookingKey + '\')" class="btn-danger">Annuleren</button></td>';
          html += '</tr>';
        }
        
        html += '</tbody></table>';
        container.innerHTML = html;
      }

      function cancelBooking(bookingKey) {
        if (confirm("Weet u zeker dat u deze boeking wilt annuleren?")) {
          delete localData.bookings[bookingKey];
          renderBookingsOverview();
          renderClientInterface();
          
          if (db) {
            removeBookingFromFirestore(bookingKey);
          } else {
            saveDataToLocalStorage();
          }
        }
      }

      function exportToCSV() {
        var bookingsList = Object.values(localData.bookings);
        if (bookingsList.length === 0) {
          showStatus("exportStatus", "Geen boekingen om te exporteren", "error");
          return;
        }

        var csv = 'Naam,E-mail,Artiest,Tafel,Datum,Tijd\n';
        for (var i = 0; i < bookingsList.length; i++) {
          var b = bookingsList[i];
          csv += '"' + b.name + '","' + b.email + '","' + (b.artistName || '') + '","' + b.tableName + '","' + b.date + '","' + b.timeSlot + '"\n';
        }

        downloadFile(csv, "gesprekstafel-boekingen.csv", "text/csv");
        showStatus("exportStatus", "CSV ge√´xporteerd", "success");
      }

      function exportToExcel() {
        exportToCSV();
      }

      function downloadFile(content, filename, mimeType) {
        var blob = new Blob([content], { type: mimeType });
        var url = URL.createObjectURL(blob);
        var a = document.createElement('a');
        a.href = url;
        a.download = filename;
        a.click();
        URL.revokeObjectURL(url);
      }

      function showStatus(elementId, message, type) {
        var element = document.getElementById(elementId);
        element.textContent = message;
        element.className = 'status-message ' + type;
        element.style.display = 'block';
        setTimeout(function() {
          element.style.display = 'none';
        }, 3000);
      }

      if (typeof emailjs !== 'undefined' && EMAILJS_CONFIG.publicKey) {
        emailjs.init(EMAILJS_CONFIG.publicKey);
      }

      window.addEventListener("load", function() {
        document.getElementById("eventDate").value = new Date().toISOString().split("T")[0];
        initializeFirebase();
        document.getElementById('loadingOverlay').style.display = 'none';
        
        if (localData.eventConfig.timeSlots.length === 0) {
          generateTimeSlots();
        }

        document.getElementById("overlay").addEventListener("click", function(e) {
          if (e.target === this) {
            closeBookingForm();
            closeLoginModal();
            closeConfirmationModal();
          }
        });
      });

      window.addEventListener('beforeunload', function() {
        if (display4KWindow) {
          display4KWindow.close();
        }
      });
    </script>
  </body>
</html>
