<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Conversation Table Booking</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        background: #f8f9fa;
        min-height: 100vh;
        padding: 20px;
        color: #333;
        line-height: 1.5;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        border-radius: 8px;
        padding: 40px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      h1 {
        text-align: center;
        margin-bottom: 40px;
        color: #2c3e50;
        font-size: 1.8rem;
        font-weight: 500;
      }

      h2 {
        margin-bottom: 20px;
        color: #34495e;
        font-size: 1.3rem;
        font-weight: 500;
        border-bottom: 1px solid #ecf0f1;
        padding-bottom: 10px;
      }

      h3 {
        margin-bottom: 15px;
        color: #2c3e50;
        font-size: 1.1rem;
        font-weight: 500;
      }

      .section {
        margin-bottom: 30px;
        padding: 20px;
        background: #fafbfc;
        border-radius: 6px;
        border: 1px solid #e1e8ed;
      }

      .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
      }

      .form-group {
        display: flex;
        flex-direction: column;
      }

      label {
        margin-bottom: 5px;
        font-weight: 500;
        color: #555;
        font-size: 0.9rem;
      }

      input,
      select,
      button {
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 0.9rem;
        transition: border-color 0.2s ease;
      }

      input:focus,
      select:focus {
        outline: none;
        border-color: #3498db;
      }

      input:invalid {
        border-color: #e74c3c;
      }

      button {
        background: #3498db;
        color: white;
        border: none;
        cursor: pointer;
        font-weight: 500;
        transition: background-color 0.2s ease;
      }

      button:hover {
        background: #2980b9;
      }

      button:disabled {
        background: #bdc3c7;
        cursor: not-allowed;
      }

      .btn-secondary {
        background: #95a5a6;
      }

      .btn-secondary:hover {
        background: #7f8c8d;
      }

      .btn-danger {
        background: #e74c3c;
      }

      .btn-danger:hover {
        background: #c0392b;
      }

      .btn-success {
        background: #27ae60;
      }

      .btn-success:hover {
        background: #229954;
      }

      .admin-access-btn {
        position: fixed;
        bottom: 20px;
        right: 20px;
        width: 40px;
        height: 40px;
        background: #95a5a6;
        border: none;
        border-radius: 50%;
        cursor: pointer;
        font-size: 14px;
        color: white;
        transition: background-color 0.2s ease;
        z-index: 100;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
      }

      .admin-access-btn:hover {
        background: #7f8c8d;
      }

      .client-booking-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
        gap: 20px;
        margin-top: 20px;
      }

      .client-table-card {
        background: white;
        border-radius: 6px;
        padding: 20px;
        border: 1px solid #e1e8ed;
        transition: box-shadow 0.2s ease;
      }

      .client-table-card:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }

      .table-header {
        text-align: center;
        margin-bottom: 15px;
        padding-bottom: 15px;
        border-bottom: 1px solid #ecf0f1;
      }

      .table-title {
        font-size: 1.1rem;
        font-weight: 500;
        color: #2c3e50;
        margin-bottom: 5px;
      }

      .speakers {
        font-size: 0.9rem;
        color: #7f8c8d;
      }

      .time-slots-container {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .time-slot-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 10px 12px;
        border-radius: 4px;
        border: 1px solid #ddd;
        transition: all 0.2s ease;
      }

      .time-slot-item.available {
        background: #f8fff9;
        border-color: #27ae60;
      }

      .time-slot-item.available:hover {
        background: #e8f5e8;
      }

      .time-slot-item.booked {
        background: #fdf2f2;
        border-color: #e74c3c;
      }

      .time-info {
        font-weight: 500;
        color: #2c3e50;
        font-size: 0.9rem;
      }

      .slot-btn {
        padding: 6px 12px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-weight: 500;
        font-size: 0.8rem;
        transition: background-color 0.2s ease;
      }

      .slot-btn.available {
        background: #27ae60;
        color: white;
      }

      .slot-btn.available:hover {
        background: #229954;
      }

      .slot-btn.booked {
        background: #bdc3c7;
        color: #7f8c8d;
        cursor: not-allowed;
      }

      .modal {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        padding: 25px;
        border-radius: 6px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        z-index: 1000;
        min-width: 350px;
        max-width: 90vw;
        max-height: 90vh;
        overflow-y: auto;
      }

      .overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 999;
      }

      .close-btn {
        position: absolute;
        top: 10px;
        right: 10px;
        background: none;
        border: none;
        font-size: 18px;
        cursor: pointer;
        color: #7f8c8d;
      }

      .status-message {
        padding: 10px;
        border-radius: 4px;
        margin-top: 10px;
        text-align: center;
        font-size: 0.9rem;
      }

      .success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }

      .error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }

      .warning {
        background: #fff3cd;
        color: #856404;
        border: 1px solid #ffeaa7;
      }

      .nav-tabs {
        display: flex;
        margin-bottom: 20px;
        border-bottom: 1px solid #dee2e6;
      }

      .nav-tab {
        padding: 10px 20px;
        background: none;
        border: none;
        border-bottom: 2px solid transparent;
        cursor: pointer;
        font-weight: 500;
        color: #6c757d;
        transition: all 0.2s ease;
      }

      .nav-tab.active {
        color: #3498db;
        border-bottom-color: #3498db;
      }

      .nav-tab:hover {
        color: #3498db;
      }

      .tab-content {
        display: none;
      }

      .tab-content.active {
        display: block;
      }

      .admin-interface {
        display: none;
      }

      .client-interface {
        display: block;
      }

      .tables-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 15px;
        margin-top: 20px;
      }

      .table-card {
        padding: 15px;
        border: 1px solid #e1e8ed;
        border-radius: 6px;
        background: white;
      }

      .bookings-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
        font-size: 0.9rem;
      }

      .bookings-table th,
      .bookings-table td {
        padding: 10px;
        border: 1px solid #dee2e6;
        text-align: left;
      }

      .bookings-table th {
        background: #f8f9fa;
        font-weight: 500;
        position: sticky;
        top: 0;
      }

      .bookings-table tr:nth-child(even) {
        background: #f8f9fa;
      }

      .event-info {
        text-align: center;
        margin-bottom: 20px;
        color: #6c757d;
        font-size: 0.95rem;
        background: #f8f9fa;
        padding: 15px;
        border-radius: 6px;
        border: 1px solid #e9ecef;
      }

      .booking-actions {
        display: flex;
        gap: 10px;
        margin-top: 15px;
        flex-wrap: wrap;
      }

      .confirmation-details {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 4px;
        margin: 15px 0;
        border: 1px solid #e9ecef;
      }

      .email-preview {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 4px;
        margin-top: 15px;
        border: 1px solid #e9ecef;
      }

      .hidden {
        display: none;
      }

      .admin-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        flex-wrap: wrap;
        gap: 10px;
      }

      .password-change-section {
        background: #fff3cd;
        border: 1px solid #ffeaa7;
        padding: 15px;
        border-radius: 4px;
        margin-bottom: 20px;
      }

      .password-change-section h3 {
        color: #856404;
        margin-bottom: 10px;
      }

      .password-form {
        display: flex;
        gap: 10px;
        align-items: end;
        flex-wrap: wrap;
      }

      .password-form .form-group {
        flex: 1;
        min-width: 150px;
      }

      .no-event-message {
        text-align: center;
        padding: 40px;
        color: #6c757d;
        background: #f8f9fa;
        border-radius: 6px;
        border: 1px solid #e9ecef;
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
      }

      .stat-card {
        background: white;
        padding: 20px;
        border-radius: 6px;
        border: 1px solid #e1e8ed;
        text-align: center;
      }

      .stat-number {
        font-size: 1.5rem;
        font-weight: bold;
        color: #3498db;
      }

      .stat-label {
        font-size: 0.9rem;
        color: #6c757d;
        margin-top: 5px;
      }

      /* Mobile responsiveness */
      @media (max-width: 768px) {
        .container {
          padding: 20px;
        }

        .form-grid {
          grid-template-columns: 1fr;
        }

        .client-booking-grid {
          grid-template-columns: 1fr;
        }

        .password-form {
          flex-direction: column;
        }

        .password-form .form-group {
          min-width: unset;
        }

        .admin-header {
          flex-direction: column;
          align-items: stretch;
        }

        .booking-actions {
          flex-direction: column;
        }

        .nav-tabs {
          flex-wrap: wrap;
        }

        .nav-tab {
          flex: 1;
          min-width: 100px;
        }
      }

      /* Loading state */
      .loading {
        opacity: 0.6;
        pointer-events: none;
      }

      .loading::after {
        content: "";
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 20px;
        height: 20px;
        border: 2px solid #3498db;
        border-top: 2px solid transparent;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: translate(-50%, -50%) rotate(0deg);
        }
        100% {
          transform: translate(-50%, -50%) rotate(360deg);
        }
      }

      /* Code styling */
      code {
        background: #f8f9fa;
        padding: 2px 4px;
        border-radius: 3px;
        font-family: "Courier New", monospace;
        font-size: 0.9em;
        color: #e74c3c;
        border: 1px solid #e9ecef;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- CLIENT INTERFACE -->
      <div id="client-interface" class="client-interface">
        <h1>Conversation Table Booking</h1>
        <div class="event-info" id="eventInfo">
          <div class="no-event-message">
            Event configuration not available yet. Please contact the
            administrator.
          </div>
        </div>
        <div class="client-booking-grid" id="clientBookingGrid"></div>
      </div>

      <!-- ADMIN ACCESS BUTTON -->
      <button
        class="admin-access-btn"
        onclick="showPasswordModal()"
        title="Admin Access"
      >
        ⚙
      </button>

      <!-- ADMIN INTERFACE -->
      <div id="admin-interface" class="admin-interface">
        <div class="admin-header">
          <h1>Admin Dashboard</h1>
          <button onclick="switchToClient()" class="btn-secondary">
            Back to Booking
          </button>
        </div>

        <!-- PASSWORD CHANGE SECTION -->
        <div class="password-change-section">
          <h3>Change Admin Password</h3>
          <div class="password-form">
            <div class="form-group">
              <label for="currentPassword">Current Password:</label>
              <input
                type="password"
                id="currentPassword"
                placeholder="Enter current password"
                autocomplete="current-password"
              />
            </div>
            <div class="form-group">
              <label for="newPassword">New Password:</label>
              <input
                type="password"
                id="newPassword"
                placeholder="Enter new password"
                autocomplete="new-password"
              />
            </div>
            <div class="form-group">
              <label for="confirmPassword">Confirm Password:</label>
              <input
                type="password"
                id="confirmPassword"
                placeholder="Confirm new password"
                autocomplete="new-password"
              />
            </div>
            <button onclick="changePassword()" class="btn-success">
              Change Password
            </button>
          </div>
          <div
            id="passwordChangeStatus"
            class="status-message"
            style="display: none"
          ></div>
        </div>

        <!-- Statistics -->
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-number" id="totalBookings">0</div>
            <div class="stat-label">Total Bookings</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="totalTables">0</div>
            <div class="stat-label">Active Tables</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="availableSlots">0</div>
            <div class="stat-label">Available Slots</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="bookedSlots">0</div>
            <div class="stat-label">Booked Slots</div>
          </div>
        </div>

        <div class="nav-tabs">
          <button class="nav-tab active" onclick="switchTab('setup')">
            Event Setup
          </button>
          <button class="nav-tab" onclick="switchTab('bookings')">
            Manage Bookings
          </button>
          <button class="nav-tab" onclick="switchTab('export')">
            Email & Export
          </button>
        </div>

        <div id="setup-tab" class="tab-content active">
          <div class="section">
            <h2>Event Configuration</h2>
            <div class="form-grid">
              <div class="form-group">
                <label for="eventDate">Event Date:</label>
                <input type="date" id="eventDate" required />
              </div>
              <div class="form-group">
                <label for="startTime">Start Time:</label>
                <input type="time" id="startTime" value="09:00" required />
              </div>
              <div class="form-group">
                <label for="endTime">End Time:</label>
                <input type="time" id="endTime" value="17:00" required />
              </div>
              <div class="form-group">
                <label for="slotDuration">Slot Duration (minutes):</label>
                <input
                  type="number"
                  id="slotDuration"
                  value="10"
                  min="5"
                  max="60"
                  required
                />
              </div>
            </div>
            <button onclick="generateTimeSlots()">Generate Time Slots</button>
            <div
              id="eventStatus"
              class="status-message"
              style="display: none"
            ></div>
          </div>

          <div class="section">
            <h2>Table Configuration</h2>
            <div class="form-grid">
              <div class="form-group">
                <label for="tableName">Table Name:</label>
                <input
                  type="text"
                  id="tableName"
                  placeholder="e.g., AI & Technology"
                  required
                />
              </div>
              <div class="form-group">
                <label for="speaker1">Speaker 1:</label>
                <input
                  type="text"
                  id="speaker1"
                  placeholder="Speaker name"
                  required
                />
              </div>
              <div class="form-group">
                <label for="speaker2">Speaker 2:</label>
                <input
                  type="text"
                  id="speaker2"
                  placeholder="Speaker name"
                  required
                />
              </div>
            </div>
            <button onclick="addTable()">Add Table</button>

            <div class="tables-grid" id="tablesGrid"></div>
          </div>
        </div>

        <div id="bookings-tab" class="tab-content">
          <div class="section">
            <h2>Current Bookings</h2>
            <div id="bookingsOverview"></div>
          </div>
        </div>

        <div id="export-tab" class="tab-content">
          <div class="section">
            <h2>Email Configuration</h2>
            <div class="form-grid">
              <div class="form-group">
                <label for="emailServiceId">EmailJS Service ID:</label>
                <input
                  type="text"
                  id="emailServiceId"
                  placeholder="service_xxxxxxx"
                />
              </div>
              <div class="form-group">
                <label for="emailTemplateId">EmailJS Template ID:</label>
                <input
                  type="text"
                  id="emailTemplateId"
                  placeholder="template_xxxxxxx"
                />
              </div>
              <div class="form-group">
                <label for="emailPublicKey">EmailJS Public Key:</label>
                <input
                  type="text"
                  id="emailPublicKey"
                  placeholder="Your public key"
                />
              </div>
              <div class="form-group">
                <label for="testEmail">Test Email:</label>
                <input
                  type="email"
                  id="testEmail"
                  placeholder="test@example.com"
                />
              </div>
            </div>
            <div class="booking-actions">
              <button onclick="saveEmailConfig()">Save Email Config</button>
              <button onclick="testEmailConfig()" class="btn-secondary">
                Test Email
              </button>
              <button onclick="checkEmailStatus()" class="btn-secondary">
                Check Status
              </button>
            </div>
            <div
              id="emailConfigStatus"
              class="status-message"
              style="display: none"
            ></div>

            <div class="section" style="margin-top: 20px">
              <h3>EmailJS Setup Instructions</h3>
              <ol style="margin-left: 20px; line-height: 1.8">
                <li>
                  <strong>Create EmailJS Account:</strong> Go to
                  <a href="https://www.emailjs.com" target="_blank"
                    >EmailJS.com</a
                  >
                  and sign up
                </li>
                <li>
                  <strong>Add Email Service:</strong>
                  <ul style="margin: 5px 0; margin-left: 20px">
                    <li>Go to "Email Services" and click "Add New Service"</li>
                    <li>Choose your email provider (Gmail, Outlook, etc.)</li>
                    <li>Follow the setup instructions for your provider</li>
                    <li>
                      Note your <strong>Service ID</strong> (starts with
                      "service_")
                    </li>
                  </ul>
                </li>
                <li>
                  <strong>Create Email Template:</strong>
                  <ul style="margin: 5px 0; margin-left: 20px">
                    <li>
                      Go to "Email Templates" and click "Create New Template"
                    </li>
                    <li>Use these variables in your template:</li>
                    <li style="margin-left: 20px">
                      <code>{{user_name}}</code> - Customer name
                    </li>
                    <li style="margin-left: 20px">
                      <code>{{user_email}}</code> - Customer email
                    </li>
                    <li style="margin-left: 20px">
                      <code>{{table_name}}</code> - Table name
                    </li>
                    <li style="margin-left: 20px">
                      <code>{{speakers}}</code> - Speaker names
                    </li>
                    <li style="margin-left: 20px">
                      <code>{{event_date}}</code> - Event date
                    </li>
                    <li style="margin-left: 20px">
                      <code>{{time_slot}}</code> - Time slot
                    </li>
                    <li style="margin-left: 20px">
                      <code>{{to_email}}</code> - Recipient email
                    </li>
                    <li>
                      Note your <strong>Template ID</strong> (starts with
                      "template_")
                    </li>
                  </ul>
                </li>
                <li>
                  <strong>Get Public Key:</strong> Go to "Account" → "General"
                  and copy your <strong>Public Key</strong>
                </li>
                <li>
                  <strong>Configure Above:</strong> Paste all three IDs into the
                  fields above and click "Save"
                </li>
                <li>
                  <strong>Test Configuration:</strong> Enter a test email and
                  click "Test Email"
                </li>
              </ol>

              <div
                style="
                  background: #f8f9fa;
                  padding: 15px;
                  border-radius: 4px;
                  margin-top: 15px;
                  border: 1px solid #e9ecef;
                "
              >
                <h4>Sample Email Template:</h4>
                <pre
                  style="
                    background: white;
                    padding: 10px;
                    border-radius: 4px;
                    overflow-x: auto;
                    font-size: 0.9em;
                  "
                >
Subject: Booking Confirmed - {{table_name}}

Dear {{user_name}},

Your conversation table booking has been confirmed!

📅 Date: {{event_date}}
⏰ Time: {{time_slot}}
📋 Table: {{table_name}}
🎤 Speakers: {{speakers}}

Please arrive 5 minutes early.

Best regards,
Event Team</pre
                >
              </div>

              <div
                style="
                  background: #fff3cd;
                  padding: 15px;
                  border-radius: 4px;
                  margin-top: 15px;
                  border: 1px solid #ffeaa7;
                "
              >
                <h4>Troubleshooting:</h4>
                <ul style="margin-left: 20px; line-height: 1.6">
                  <li>Make sure your Service ID starts with "service_"</li>
                  <li>Make sure your Template ID starts with "template_"</li>
                  <li>
                    Check that your email service is properly configured in
                    EmailJS
                  </li>
                  <li>
                    Verify that your template variables match exactly
                    (case-sensitive)
                  </li>
                  <li>Check the browser console for detailed error messages</li>
                  <li>Make sure your EmailJS account has enough quota</li>
                </ul>
              </div>
            </div>
          </div>

          <div class="section">
            <h2>Export & Reports</h2>
            <div class="booking-actions">
              <button class="btn-success" onclick="exportToCSV()">
                Export to CSV
              </button>
              <button class="btn-success" onclick="exportToExcel()">
                Export to Excel
              </button>
              <button class="btn-secondary" onclick="clearAllData()">
                Clear All Data
              </button>
            </div>
            <div
              id="exportStatus"
              class="status-message"
              style="display: none"
            ></div>
          </div>
        </div>
      </div>

      <!-- MODALS -->
      <div class="overlay" id="overlay"></div>

      <!-- PASSWORD MODAL -->
      <div class="modal" id="passwordModal">
        <h3>Admin Access</h3>
        <p>Enter admin password:</p>
        <input
          type="password"
          class="password-input"
          id="adminPassword"
          placeholder="Password"
          onkeypress="if(event.key==='Enter') checkPassword()"
          style="width: 100%; margin: 15px 0"
          autocomplete="current-password"
        />
        <div style="text-align: center">
          <button onclick="checkPassword()" style="margin-right: 10px">
            Access
          </button>
          <button onclick="closePasswordModal()" class="btn-secondary">
            Cancel
          </button>
        </div>
        <div
          id="passwordError"
          class="status-message error"
          style="display: none"
        ></div>
      </div>

      <!-- BOOKING FORM -->
      <div class="modal" id="bookingForm">
        <button class="close-btn" onclick="closeBookingForm()">&times;</button>
        <h3>Book Your Conversation</h3>
        <div class="form-group">
          <label for="userName">Your Name:</label>
          <input type="text" id="userName" required autocomplete="name" />
        </div>
        <div class="form-group">
          <label for="userEmail">Email:</label>
          <input type="email" id="userEmail" required autocomplete="email" />
        </div>
        <div class="form-group">
          <label for="userPhone">Phone (optional):</label>
          <input type="tel" id="userPhone" autocomplete="tel" />
        </div>
        <div class="form-group">
          <label>Selected Slot:</label>
          <div id="selectedSlotInfo" class="confirmation-details"></div>
        </div>
        <div class="booking-actions">
          <button onclick="confirmBooking()" id="confirmBookingBtn">
            Confirm Booking
          </button>
          <button onclick="closeBookingForm()" class="btn-secondary">
            Cancel
          </button>
        </div>
        <div
          id="bookingStatus"
          class="status-message"
          style="display: none"
        ></div>
      </div>

      <!-- CONFIRMATION MODAL -->
      <div class="modal" id="confirmationModal">
        <button class="close-btn" onclick="closeConfirmationModal()">
          &times;
        </button>
        <h3>Booking Confirmed</h3>
        <div id="confirmationDetails"></div>
        <div class="booking-actions">
          <button onclick="addToCalendar()">Add to Calendar</button>
          <button onclick="showEmailPreview()" class="btn-secondary">
            View Email Confirmation
          </button>
        </div>
        <div id="emailPreview" class="email-preview hidden"></div>
      </div>
    </div>

    <!-- EmailJS SDK -->
    <script
      type="text/javascript"
      src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"
    ></script>

    <script>
      // EmailJS Configuration
      let EMAILJS_CONFIG = {
        serviceId: "",
        templateId: "",
        publicKey: "",
        enabled: false,
      };

      // Initialize EmailJS when needed
      function initializeEmailJS() {
        if (
          typeof emailjs !== "undefined" &&
          EMAILJS_CONFIG.enabled &&
          EMAILJS_CONFIG.publicKey
        ) {
          try {
            emailjs.init(EMAILJS_CONFIG.publicKey);
            console.log("EmailJS initialized successfully");
            return true;
          } catch (error) {
            console.error("EmailJS initialization failed:", error);
            return false;
          }
        }
        return false;
      }

      // Storage keys
      const STORAGE_KEYS = {
        EVENT_CONFIG: "conversation_booking_event_config",
        TABLES: "conversation_booking_tables",
        BOOKINGS: "conversation_booking_bookings",
        ADMIN_PASSWORD: "conversation_booking_admin_password",
        EMAIL_CONFIG: "conversation_booking_email_config",
      };

      // Global data storage
      let eventConfig = {
        date: "",
        startTime: "09:00",
        endTime: "17:00",
        slotDuration: 10,
        timeSlots: [],
      };

      let tables = [];
      let bookings = {}; // Format: "tableId-slotIndex": {name, email, phone, time, table, slot}
      let currentBookingSelection = null;
      let currentBookingConfirmation = null;
      let isAdminMode = false;
      let adminPassword = "admin123"; // Default password

      // Load data from localStorage
      function loadData() {
        try {
          const savedEventConfig = localStorage.getItem(
            STORAGE_KEYS.EVENT_CONFIG
          );
          if (savedEventConfig) {
            eventConfig = JSON.parse(savedEventConfig);
          }

          const savedTables = localStorage.getItem(STORAGE_KEYS.TABLES);
          if (savedTables) {
            tables = JSON.parse(savedTables);
          }

          const savedBookings = localStorage.getItem(STORAGE_KEYS.BOOKINGS);
          if (savedBookings) {
            bookings = JSON.parse(savedBookings);
          }

          const savedPassword = localStorage.getItem(
            STORAGE_KEYS.ADMIN_PASSWORD
          );
          if (savedPassword) {
            adminPassword = savedPassword;
          }

          const savedEmailConfig = localStorage.getItem(
            STORAGE_KEYS.EMAIL_CONFIG
          );
          if (savedEmailConfig) {
            const emailConfig = JSON.parse(savedEmailConfig);
            Object.assign(EMAILJS_CONFIG, emailConfig);
            loadEmailConfigForm();
          }
        } catch (error) {
          console.error("Error loading data from localStorage:", error);
        }
      }

      // Save data to localStorage
      function saveData() {
        try {
          localStorage.setItem(
            STORAGE_KEYS.EVENT_CONFIG,
            JSON.stringify(eventConfig)
          );
          localStorage.setItem(STORAGE_KEYS.TABLES, JSON.stringify(tables));
          localStorage.setItem(STORAGE_KEYS.BOOKINGS, JSON.stringify(bookings));
          localStorage.setItem(STORAGE_KEYS.ADMIN_PASSWORD, adminPassword);
          localStorage.setItem(
            STORAGE_KEYS.EMAIL_CONFIG,
            JSON.stringify(EMAILJS_CONFIG)
          );
        } catch (error) {
          console.error("Error saving data to localStorage:", error);
        }
      }

      // Load email configuration into form
      function loadEmailConfigForm() {
        document.getElementById("emailServiceId").value =
          EMAILJS_CONFIG.serviceId || "";
        document.getElementById("emailTemplateId").value =
          EMAILJS_CONFIG.templateId || "";
        document.getElementById("emailPublicKey").value =
          EMAILJS_CONFIG.publicKey || "";
      }

      // Save email configuration
      function saveEmailConfig() {
        const serviceId = document
          .getElementById("emailServiceId")
          .value.trim();
        const templateId = document
          .getElementById("emailTemplateId")
          .value.trim();
        const publicKey = document
          .getElementById("emailPublicKey")
          .value.trim();

        if (!serviceId || !templateId || !publicKey) {
          showStatus(
            "emailConfigStatus",
            "Please fill in all email configuration fields",
            "error"
          );
          return;
        }

        // Basic validation
        if (!serviceId.startsWith("service_")) {
          showStatus(
            "emailConfigStatus",
            'Service ID should start with "service_"',
            "error"
          );
          return;
        }

        if (!templateId.startsWith("template_")) {
          showStatus(
            "emailConfigStatus",
            'Template ID should start with "template_"',
            "error"
          );
          return;
        }

        // Update configuration
        EMAILJS_CONFIG.serviceId = serviceId;
        EMAILJS_CONFIG.templateId = templateId;
        EMAILJS_CONFIG.publicKey = publicKey;
        EMAILJS_CONFIG.enabled = true;

        // Test EmailJS availability
        if (typeof emailjs === "undefined") {
          showStatus(
            "emailConfigStatus",
            "EmailJS library not loaded. Please refresh the page.",
            "error"
          );
          return;
        }

        // Initialize EmailJS
        const initialized = initializeEmailJS();
        if (!initialized) {
          showStatus(
            "emailConfigStatus",
            "Failed to initialize EmailJS. Please check your credentials.",
            "error"
          );
          return;
        }

        // Save to localStorage
        saveData();
        showStatus(
          "emailConfigStatus",
          "Email configuration saved successfully! You can now test it.",
          "success"
        );
      }

      // Check email status for debugging
      function checkEmailStatus() {
        let statusMessage = "<strong>Email Configuration Status:</strong><br>";

        // Check EmailJS library
        if (typeof emailjs === "undefined") {
          statusMessage += "❌ EmailJS library: Not loaded<br>";
        } else {
          statusMessage += "✅ EmailJS library: Loaded<br>";
        }

        // Check configuration
        statusMessage += `📧 Service ID: ${
          EMAILJS_CONFIG.serviceId || "Not set"
        }<br>`;
        statusMessage += `📋 Template ID: ${
          EMAILJS_CONFIG.templateId || "Not set"
        }<br>`;
        statusMessage += `🔑 Public Key: ${
          EMAILJS_CONFIG.publicKey ? "Set" : "Not set"
        }<br>`;
        statusMessage += `⚙️ Enabled: ${
          EMAILJS_CONFIG.enabled ? "Yes" : "No"
        }<br>`;

        // Check initialization
        const initialized = initializeEmailJS();
        statusMessage += `🚀 Initialized: ${initialized ? "Yes" : "No"}<br>`;

        // Display in status area
        const statusElement = document.getElementById("emailConfigStatus");
        statusElement.innerHTML = statusMessage;
        statusElement.className = "status-message success";
        statusElement.style.display = "block";

        // Also log to console for debugging
        console.log("Email Configuration Debug:", {
          emailjsLoaded: typeof emailjs !== "undefined",
          config: EMAILJS_CONFIG,
          initialized: initialized,
        });
      }

      // Test email configuration
      function testEmailConfig() {
        const testEmail = document.getElementById("testEmail").value.trim();

        if (!testEmail) {
          showStatus(
            "emailConfigStatus",
            "Please enter a test email address",
            "error"
          );
          return;
        }

        // Validate email format
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(testEmail)) {
          showStatus(
            "emailConfigStatus",
            "Please enter a valid email address",
            "error"
          );
          return;
        }

        if (!EMAILJS_CONFIG.enabled) {
          showStatus(
            "emailConfigStatus",
            "Please save email configuration first",
            "error"
          );
          return;
        }

        if (typeof emailjs === "undefined") {
          showStatus(
            "emailConfigStatus",
            "EmailJS library not loaded. Please refresh the page.",
            "error"
          );
          return;
        }

        // Re-initialize EmailJS to ensure it's working
        const initialized = initializeEmailJS();
        if (!initialized) {
          showStatus(
            "emailConfigStatus",
            "Failed to initialize EmailJS. Please check your configuration.",
            "error"
          );
          return;
        }

        const testParams = {
          user_name: "Test User",
          user_email: testEmail,
          table_name: "Test Table",
          speakers: "Speaker 1 & Speaker 2",
          event_date: "Monday, January 1, 2024",
          time_slot: "10:00 - 10:10",
          to_email: testEmail,
          // Additional common template variables
          to_name: "Test User",
          from_name: "Event Team",
          message: "This is a test email to verify your EmailJS configuration.",
        };

        showStatus(
          "emailConfigStatus",
          "Sending test email... Please wait.",
          "success"
        );

        console.log("Sending test email with params:", testParams);
        console.log("Using EmailJS config:", {
          serviceId: EMAILJS_CONFIG.serviceId,
          templateId: EMAILJS_CONFIG.templateId,
          publicKey: EMAILJS_CONFIG.publicKey ? "SET" : "NOT SET",
        });

        emailjs
          .send(
            EMAILJS_CONFIG.serviceId,
            EMAILJS_CONFIG.templateId,
            testParams,
            EMAILJS_CONFIG.publicKey
          )
          .then(
            (response) => {
              console.log("Test email sent successfully:", response);
              showStatus(
                "emailConfigStatus",
                "Test email sent successfully! Check your inbox (and spam folder).",
                "success"
              );
            },
            (error) => {
              console.error("Test email failed:", error);
              let errorMessage = "Test email failed: ";

              if (error.text) {
                errorMessage += error.text;
              } else if (error.message) {
                errorMessage += error.message;
              } else {
                errorMessage += "Unknown error occurred";
              }

              // Common error messages
              if (error.text && error.text.includes("template")) {
                errorMessage +=
                  " (Check your template ID and template variables)";
              } else if (error.text && error.text.includes("service")) {
                errorMessage +=
                  " (Check your service ID and service configuration)";
              } else if (error.text && error.text.includes("public")) {
                errorMessage += " (Check your public key)";
              }

              showStatus("emailConfigStatus", errorMessage, "error");
            }
          );
      }

      // Clear all data
      function clearAllData() {
        if (
          confirm(
            "Are you sure you want to clear all data? This action cannot be undone."
          )
        ) {
          localStorage.removeItem(STORAGE_KEYS.EVENT_CONFIG);
          localStorage.removeItem(STORAGE_KEYS.TABLES);
          localStorage.removeItem(STORAGE_KEYS.BOOKINGS);
          localStorage.removeItem(STORAGE_KEYS.ADMIN_PASSWORD);
          localStorage.removeItem(STORAGE_KEYS.EMAIL_CONFIG);

          // Reset to defaults
          eventConfig = {
            date: "",
            startTime: "09:00",
            endTime: "17:00",
            slotDuration: 10,
            timeSlots: [],
          };
          tables = [];
          bookings = {};
          adminPassword = "admin123";

          // Reset email config
          EMAILJS_CONFIG.serviceId = "";
          EMAILJS_CONFIG.templateId = "";
          EMAILJS_CONFIG.publicKey = "";
          EMAILJS_CONFIG.enabled = false;

          // Update UI
          loadFormData();
          loadEmailConfigForm();
          renderTables();
          renderBookingsOverview();
          renderClientInterface();
          updateStatistics();

          showStatus(
            "exportStatus",
            "All data cleared successfully",
            "success"
          );
        }
      }

      // Load form data from stored config
      function loadFormData() {
        if (eventConfig.date) {
          document.getElementById("eventDate").value = eventConfig.date;
        } else {
          // Set default date to today
          document.getElementById("eventDate").value = new Date()
            .toISOString()
            .split("T")[0];
        }

        document.getElementById("startTime").value = eventConfig.startTime;
        document.getElementById("endTime").value = eventConfig.endTime;
        document.getElementById("slotDuration").value =
          eventConfig.slotDuration;
      }

      // Update statistics
      function updateStatistics() {
        const totalBookings = Object.keys(bookings).length;
        const totalTables = tables.length;
        const totalSlots = totalTables * eventConfig.timeSlots.length;
        const bookedSlots = totalBookings;
        const availableSlots = totalSlots - bookedSlots;

        document.getElementById("totalBookings").textContent = totalBookings;
        document.getElementById("totalTables").textContent = totalTables;
        document.getElementById("availableSlots").textContent = Math.max(
          0,
          availableSlots
        );
        document.getElementById("bookedSlots").textContent = bookedSlots;
      }

      function showPasswordModal() {
        document.getElementById("overlay").style.display = "block";
        document.getElementById("passwordModal").style.display = "block";
        document.getElementById("adminPassword").value = "";
        document.getElementById("passwordError").style.display = "none";
        document.getElementById("adminPassword").focus();
      }

      function closePasswordModal() {
        document.getElementById("overlay").style.display = "none";
        document.getElementById("passwordModal").style.display = "none";
      }

      function checkPassword() {
        const enteredPassword = document.getElementById("adminPassword").value;

        if (enteredPassword === adminPassword) {
          isAdminMode = true;
          closePasswordModal();
          switchToAdmin();
        } else {
          document.getElementById("passwordError").textContent =
            "Incorrect password";
          document.getElementById("passwordError").style.display = "block";
          document.getElementById("adminPassword").value = "";
        }
      }

      function changePassword() {
        const currentPwd = document.getElementById("currentPassword").value;
        const newPwd = document.getElementById("newPassword").value;
        const confirmPwd = document.getElementById("confirmPassword").value;

        if (!currentPwd || !newPwd || !confirmPwd) {
          showPasswordChangeStatus("Please fill in all fields", "error");
          return;
        }

        if (currentPwd !== adminPassword) {
          showPasswordChangeStatus("Current password is incorrect", "error");
          return;
        }

        if (newPwd !== confirmPwd) {
          showPasswordChangeStatus("New passwords do not match", "error");
          return;
        }

        if (newPwd.length < 6) {
          showPasswordChangeStatus(
            "Password must be at least 6 characters",
            "error"
          );
          return;
        }

        adminPassword = newPwd;
        saveData();
        showPasswordChangeStatus("Password changed successfully", "success");

        // Clear form
        document.getElementById("currentPassword").value = "";
        document.getElementById("newPassword").value = "";
        document.getElementById("confirmPassword").value = "";
      }

      function showPasswordChangeStatus(message, type) {
        const element = document.getElementById("passwordChangeStatus");
        element.textContent = message;
        element.className = `status-message ${type}`;
        element.style.display = "block";

        setTimeout(() => {
          element.style.display = "none";
        }, 5000);
      }

      function switchToAdmin() {
        document.getElementById("client-interface").style.display = "none";
        document.getElementById("admin-interface").style.display = "block";
        loadFormData();
        loadEmailConfigForm();
        renderTables();
        renderBookingsOverview();
        updateStatistics();
      }

      function switchToClient() {
        isAdminMode = false;
        document.getElementById("client-interface").style.display = "block";
        document.getElementById("admin-interface").style.display = "none";
        renderClientInterface();
      }

      function switchTab(tabName) {
        // Update nav tabs
        document
          .querySelectorAll(".nav-tab")
          .forEach((tab) => tab.classList.remove("active"));
        document
          .querySelector(`[onclick="switchTab('${tabName}')"]`)
          .classList.add("active");

        // Update tab content
        document
          .querySelectorAll(".tab-content")
          .forEach((content) => content.classList.remove("active"));
        document.getElementById(`${tabName}-tab`).classList.add("active");

        if (tabName === "bookings") {
          renderBookingsOverview();
        }
      }

      function validateTimeSlots() {
        const date = document.getElementById("eventDate").value;
        const startTime = document.getElementById("startTime").value;
        const endTime = document.getElementById("endTime").value;
        const duration = parseInt(
          document.getElementById("slotDuration").value
        );

        if (!date || !startTime || !endTime || !duration) {
          return { valid: false, message: "Please fill in all fields" };
        }

        const start = new Date(`${date}T${startTime}`);
        const end = new Date(`${date}T${endTime}`);

        if (start >= end) {
          return { valid: false, message: "End time must be after start time" };
        }

        const durationMs = end - start;
        const slotDurationMs = duration * 60000;

        if (durationMs < slotDurationMs) {
          return {
            valid: false,
            message: "Time range too short for slot duration",
          };
        }

        return { valid: true };
      }

      function generateTimeSlots() {
        const validation = validateTimeSlots();
        if (!validation.valid) {
          showStatus("eventStatus", validation.message, "error");
          return;
        }

        const date = document.getElementById("eventDate").value;
        const startTime = document.getElementById("startTime").value;
        const endTime = document.getElementById("endTime").value;
        const duration = parseInt(
          document.getElementById("slotDuration").value
        );

        eventConfig.date = date;
        eventConfig.startTime = startTime;
        eventConfig.endTime = endTime;
        eventConfig.slotDuration = duration;

        // Generate time slots
        const slots = [];
        const start = new Date(`${date}T${startTime}`);
        const end = new Date(`${date}T${endTime}`);

        let current = new Date(start);
        let slotIndex = 0;

        while (current < end) {
          const slotEnd = new Date(current.getTime() + duration * 60000);
          if (slotEnd <= end) {
            slots.push({
              index: slotIndex++,
              start: current.toTimeString().slice(0, 5),
              end: slotEnd.toTimeString().slice(0, 5),
              startTime: new Date(current),
              endTime: new Date(slotEnd),
            });
          }
          current = new Date(slotEnd);
        }

        eventConfig.timeSlots = slots;
        saveData();
        updateStatistics();
        showStatus(
          "eventStatus",
          `Generated ${slots.length} time slots from ${startTime} to ${endTime}`,
          "success"
        );

        // Update client interface
        renderClientInterface();
      }

      function validateTableInput() {
        const name = document.getElementById("tableName").value.trim();
        const speaker1 = document.getElementById("speaker1").value.trim();
        const speaker2 = document.getElementById("speaker2").value.trim();

        if (!name || !speaker1 || !speaker2) {
          return { valid: false, message: "Please fill in all table fields" };
        }

        if (
          tables.some(
            (table) => table.name.toLowerCase() === name.toLowerCase()
          )
        ) {
          return { valid: false, message: "Table name already exists" };
        }

        if (tables.length >= 20) {
          return { valid: false, message: "Maximum of 20 tables allowed" };
        }

        return { valid: true };
      }

      function addTable() {
        const validation = validateTableInput();
        if (!validation.valid) {
          alert(validation.message);
          return;
        }

        const name = document.getElementById("tableName").value.trim();
        const speaker1 = document.getElementById("speaker1").value.trim();
        const speaker2 = document.getElementById("speaker2").value.trim();

        const table = {
          id: Date.now(), // Use timestamp for unique ID
          name: name,
          speaker1: speaker1,
          speaker2: speaker2,
        };

        tables.push(table);
        saveData();
        renderTables();
        updateStatistics();
        renderClientInterface();

        // Clear form
        document.getElementById("tableName").value = "";
        document.getElementById("speaker1").value = "";
        document.getElementById("speaker2").value = "";
      }

      function renderTables() {
        const grid = document.getElementById("tablesGrid");
        grid.innerHTML = tables
          .map(
            (table, index) => `
          <div class="table-card">
            <h4>Table ${index + 1}: ${table.name}</h4>
            <p><strong>Speakers:</strong> ${table.speaker1} & ${
              table.speaker2
            }</p>
            <button onclick="removeTable(${
              table.id
            })" class="btn-danger" style="margin-top: 10px;">Remove</button>
          </div>
        `
          )
          .join("");
      }

      function removeTable(tableId) {
        if (
          confirm(
            "Are you sure you want to remove this table? All bookings for this table will be lost."
          )
        ) {
          tables = tables.filter((table) => table.id !== tableId);

          // Remove related bookings
          Object.keys(bookings).forEach((key) => {
            if (key.startsWith(`${tableId}-`)) {
              delete bookings[key];
            }
          });

          saveData();
          renderTables();
          updateStatistics();
          renderClientInterface();
        }
      }

      function renderClientInterface() {
        // Update event info
        const eventInfo = document.getElementById("eventInfo");
        if (eventConfig.date && eventConfig.timeSlots.length > 0) {
          const eventDate = new Date(eventConfig.date).toLocaleDateString(
            "en-US",
            {
              weekday: "long",
              year: "numeric",
              month: "long",
              day: "numeric",
            }
          );
          eventInfo.innerHTML = `
            <strong>${eventDate}</strong><br>
            ${eventConfig.startTime} - ${eventConfig.endTime} | ${eventConfig.slotDuration} minutes per session
          `;
        } else {
          eventInfo.innerHTML = `
            <div class="no-event-message">
              Event configuration not available yet. Please contact the administrator.
            </div>
          `;
        }

        const container = document.getElementById("clientBookingGrid");

        if (tables.length === 0 || eventConfig.timeSlots.length === 0) {
          container.innerHTML = `
            <div class="no-event-message">
              No tables available for booking at this time.
            </div>
          `;
          return;
        }

        container.innerHTML = tables
          .map(
            (table) => `
          <div class="client-table-card">
            <div class="table-header">
              <div class="table-title">${table.name}</div>
              <div class="speakers">with ${table.speaker1} & ${
              table.speaker2
            }</div>
            </div>
            <div class="time-slots-container">
              ${eventConfig.timeSlots
                .map((slot) => {
                  const bookingKey = `${table.id}-${slot.index}`;
                  const isBooked = bookings[bookingKey];
                  return `
                  <div class="time-slot-item ${
                    isBooked ? "booked" : "available"
                  }">
                    <div class="time-info">${slot.start} - ${slot.end}</div>
                    <button class="slot-btn ${
                      isBooked ? "booked" : "available"
                    }" 
                            ${
                              !isBooked
                                ? `onclick="openBookingForm(${table.id}, ${slot.index})"`
                                : ""
                            }
                            ${isBooked ? "disabled" : ""}>
                      ${isBooked ? "Booked" : "Book"}
                    </button>
                  </div>
                `;
                })
                .join("")}
            </div>
          </div>
        `
          )
          .join("");
      }

      function openBookingForm(tableId, slotIndex) {
        const table = tables.find((t) => t.id === tableId);
        const slot = eventConfig.timeSlots.find((s) => s.index === slotIndex);

        if (!table || !slot) {
          alert("Error: Table or time slot not found");
          return;
        }

        currentBookingSelection = { tableId, slotIndex };

        const eventDate = new Date(eventConfig.date).toLocaleDateString(
          "en-US",
          {
            weekday: "long",
            year: "numeric",
            month: "long",
            day: "numeric",
          }
        );

        document.getElementById("selectedSlotInfo").innerHTML = `
          <strong>${table.name}</strong><br>
          ${eventDate}<br>
          ${slot.start} - ${slot.end}<br>
          Speakers: ${table.speaker1} & ${table.speaker2}
        `;

        document.getElementById("overlay").style.display = "block";
        document.getElementById("bookingForm").style.display = "block";
        document.getElementById("userName").value = "";
        document.getElementById("userEmail").value = "";
        document.getElementById("userPhone").value = "";
        document.getElementById("bookingStatus").style.display = "none";
        document.getElementById("userName").focus();
      }

      function closeBookingForm() {
        document.getElementById("overlay").style.display = "none";
        document.getElementById("bookingForm").style.display = "none";
        currentBookingSelection = null;
      }

      function validateBookingForm() {
        const name = document.getElementById("userName").value.trim();
        const email = document.getElementById("userEmail").value.trim();

        if (!name || !email) {
          return { valid: false, message: "Please fill in name and email" };
        }

        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(email)) {
          return {
            valid: false,
            message: "Please enter a valid email address",
          };
        }

        if (!currentBookingSelection) {
          return { valid: false, message: "No slot selected" };
        }

        const { tableId, slotIndex } = currentBookingSelection;
        const bookingKey = `${tableId}-${slotIndex}`;

        if (bookings[bookingKey]) {
          return { valid: false, message: "This slot is already booked" };
        }

        return { valid: true };
      }

      function confirmBooking() {
        const validation = validateBookingForm();
        if (!validation.valid) {
          showStatus("bookingStatus", validation.message, "error");
          return;
        }

        const name = document.getElementById("userName").value.trim();
        const email = document.getElementById("userEmail").value.trim();
        const phone = document.getElementById("userPhone").value.trim();

        const { tableId, slotIndex } = currentBookingSelection;
        const bookingKey = `${tableId}-${slotIndex}`;

        const table = tables.find((t) => t.id === tableId);
        const slot = eventConfig.timeSlots.find((s) => s.index === slotIndex);

        const booking = {
          name: name,
          email: email,
          phone: phone,
          tableId: tableId,
          slotIndex: slotIndex,
          tableName: table.name,
          speaker1: table.speaker1,
          speaker2: table.speaker2,
          timeSlot: `${slot.start} - ${slot.end}`,
          date: eventConfig.date,
          timestamp: new Date().toISOString(),
        };

        // Disable the confirm button to prevent double-booking
        const confirmBtn = document.getElementById("confirmBookingBtn");
        confirmBtn.disabled = true;
        confirmBtn.textContent = "Processing...";

        // Check if email is configured and working
        if (!EMAILJS_CONFIG.enabled || typeof emailjs === "undefined") {
          showStatus(
            "bookingStatus",
            "Email not configured. Booking will be saved without email confirmation.",
            "warning"
          );
          setTimeout(() => completeBooking(booking, bookingKey, false), 1500);
          return;
        }

        // Re-initialize EmailJS to ensure it's working
        const initialized = initializeEmailJS();
        if (!initialized) {
          showStatus(
            "bookingStatus",
            "Email service not available. Booking will be saved without email confirmation.",
            "warning"
          );
          setTimeout(() => completeBooking(booking, bookingKey, false), 1500);
          return;
        }

        // Show loading state
        showStatus("bookingStatus", "Sending confirmation email...", "success");

        // Send email using EmailJS
        const eventDate = new Date(booking.date).toLocaleDateString("en-US", {
          weekday: "long",
          year: "numeric",
          month: "long",
          day: "numeric",
        });

        const emailParams = {
          user_name: booking.name,
          user_email: booking.email,
          table_name: booking.tableName,
          speakers: `${booking.speaker1} & ${booking.speaker2}`,
          event_date: eventDate,
          time_slot: booking.timeSlot,
          to_email: booking.email,
          // Additional common template variables
          to_name: booking.name,
          from_name: "Event Team",
          message: `Your booking for ${booking.tableName} on ${eventDate} at ${booking.timeSlot} has been confirmed.`,
        };

        console.log(
          "Sending booking confirmation email with params:",
          emailParams
        );
        console.log("Using EmailJS config:", {
          serviceId: EMAILJS_CONFIG.serviceId,
          templateId: EMAILJS_CONFIG.templateId,
          publicKey: EMAILJS_CONFIG.publicKey ? "SET" : "NOT SET",
        });

        emailjs
          .send(
            EMAILJS_CONFIG.serviceId,
            EMAILJS_CONFIG.templateId,
            emailParams,
            EMAILJS_CONFIG.publicKey
          )
          .then(
            (response) => {
              console.log(
                "Booking confirmation email sent successfully:",
                response
              );
              completeBooking(booking, bookingKey, true);
            },
            (error) => {
              console.error("Booking confirmation email failed:", error);

              let errorMessage =
                "Booking saved, but email confirmation failed to send";
              if (error.text) {
                errorMessage += `: ${error.text}`;
              }
              errorMessage += ". Please check admin email configuration.";

              showStatus("bookingStatus", errorMessage, "warning");
              setTimeout(
                () => completeBooking(booking, bookingKey, false),
                2000
              );
            }
          );
      }

      function completeBooking(booking, bookingKey, emailSent = false) {
        // Save booking
        bookings[bookingKey] = booking;
        bookings[bookingKey].emailSent = emailSent;
        currentBookingConfirmation = booking;
        saveData();

        // Reset form
        const confirmBtn = document.getElementById("confirmBookingBtn");
        confirmBtn.disabled = false;
        confirmBtn.textContent = "Confirm Booking";

        closeBookingForm();
        showConfirmationModal(emailSent);
        renderClientInterface();
        updateStatistics();
      }

      function showConfirmationModal(emailSent = false) {
        const booking = currentBookingConfirmation;
        const eventDate = new Date(booking.date).toLocaleDateString("en-US", {
          weekday: "long",
          year: "numeric",
          month: "long",
          day: "numeric",
        });

        const emailStatus = emailSent
          ? '<div style="color: #27ae60; margin-bottom: 10px;"><strong>✓ Confirmation email sent successfully!</strong></div>'
          : '<div style="color: #f39c12; margin-bottom: 10px;"><strong>⚠ Email not sent (check admin configuration)</strong></div>';

        document.getElementById("confirmationDetails").innerHTML = `
          ${emailStatus}
          <div class="confirmation-details">
            <strong>Booking Details:</strong><br>
            <strong>Name:</strong> ${booking.name}<br>
            <strong>Email:</strong> ${booking.email}<br>
            ${
              booking.phone
                ? `<strong>Phone:</strong> ${booking.phone}<br>`
                : ""
            }
            <strong>Table:</strong> ${booking.tableName}<br>
            <strong>Speakers:</strong> ${booking.speaker1} & ${
          booking.speaker2
        }<br>
            <strong>Date:</strong> ${eventDate}<br>
            <strong>Time:</strong> ${booking.timeSlot}
          </div>
        `;

        document.getElementById("overlay").style.display = "block";
        document.getElementById("confirmationModal").style.display = "block";
      }

      function closeConfirmationModal() {
        document.getElementById("overlay").style.display = "none";
        document.getElementById("confirmationModal").style.display = "none";
        document.getElementById("emailPreview").classList.add("hidden");
      }

      function addToCalendar() {
        const booking = currentBookingConfirmation;
        const eventDate = new Date(booking.date);
        const [startHour, startMinute] = booking.timeSlot
          .split(" - ")[0]
          .split(":");
        const [endHour, endMinute] = booking.timeSlot
          .split(" - ")[1]
          .split(":");

        const startTime = new Date(eventDate);
        startTime.setHours(parseInt(startHour), parseInt(startMinute));

        const endTime = new Date(eventDate);
        endTime.setHours(parseInt(endHour), parseInt(endMinute));

        const event = {
          title: `Conversation Table: ${booking.tableName}`,
          start: startTime,
          end: endTime,
          description: `Conversation with ${booking.speaker1} & ${booking.speaker2}`,
          location: "Event Venue",
        };

        const formatDate = (date) =>
          date.toISOString().replace(/[-:]/g, "").split(".")[0] + "Z";

        const icsContent = `BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//Your Company//Event//EN
BEGIN:VEVENT
UID:${Date.now()}@yourcompany.com
DTSTAMP:${formatDate(new Date())}
DTSTART:${formatDate(startTime)}
DTEND:${formatDate(endTime)}
SUMMARY:${event.title}
DESCRIPTION:${event.description}
LOCATION:${event.location}
END:VEVENT
END:VCALENDAR`;

        const blob = new Blob([icsContent], { type: "text/calendar" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "conversation-booking.ics";
        a.click();
        URL.revokeObjectURL(url);
      }

      function showEmailPreview() {
        const booking = currentBookingConfirmation;
        const eventDate = new Date(booking.date).toLocaleDateString("en-US", {
          weekday: "long",
          year: "numeric",
          month: "long",
          day: "numeric",
        });

        const emailContent = `
          <h4>Email Confirmation Preview</h4>
          <div style="border: 1px solid #ddd; padding: 15px; background: white; margin-top: 10px;">
            <strong>Subject:</strong> Conversation Table Booking Confirmed<br><br>
            <strong>Dear ${booking.name},</strong><br><br>
            
            Your booking has been confirmed.<br><br>
            
            <strong>Event Details:</strong><br>
            Date: ${eventDate}<br>
            Time: ${booking.timeSlot}<br>
            Table: ${booking.tableName}<br>
            Speakers: ${booking.speaker1} & ${booking.speaker2}<br><br>
            
            Please arrive 5 minutes before your scheduled time.<br><br>
            
            Best regards,<br>
            Event Team
          </div>
          <p style="font-size: 0.9rem; color: #666; margin-top: 10px;">
            <em>Note: This email would be sent automatically to ${booking.email}</em>
          </p>
        `;

        document.getElementById("emailPreview").innerHTML = emailContent;
        document.getElementById("emailPreview").classList.remove("hidden");
      }

      function renderBookingsOverview() {
        const container = document.getElementById("bookingsOverview");
        const bookingsList = Object.values(bookings);

        if (bookingsList.length === 0) {
          container.innerHTML = "<p>No bookings yet.</p>";
          return;
        }

        // Sort bookings by date and time
        bookingsList.sort((a, b) => {
          const dateA = new Date(`${a.date}T${a.timeSlot.split(" - ")[0]}`);
          const dateB = new Date(`${b.date}T${b.timeSlot.split(" - ")[0]}`);
          return dateA - dateB;
        });

        const tableHTML = `
          <table class="bookings-table">
            <thead>
              <tr>
                <th>Name</th>
                <th>Email</th>
                <th>Phone</th>
                <th>Table</th>
                <th>Date</th>
                <th>Time</th>
                <th>Speakers</th>
                <th>Email Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              ${bookingsList
                .map(
                  (booking) => `
                <tr>
                  <td>${booking.name}</td>
                  <td>${booking.email}</td>
                  <td>${booking.phone || "N/A"}</td>
                  <td>${booking.tableName}</td>
                  <td>${new Date(booking.date).toLocaleDateString()}</td>
                  <td>${booking.timeSlot}</td>
                  <td>${booking.speaker1} & ${booking.speaker2}</td>
                  <td>${
                    booking.emailSent
                      ? '<span style="color: #27ae60;">✓ Sent</span>'
                      : '<span style="color: #f39c12;">⚠ Not sent</span>'
                  }</td>
                  <td>
                    <button onclick="cancelBooking('${booking.tableId}-${
                    booking.slotIndex
                  }')" 
                            class="btn-danger" style="padding: 5px 10px; font-size: 12px;">
                      Cancel
                    </button>
                  </td>
                </tr>
              `
                )
                .join("")}
            </tbody>
          </table>
        `;

        container.innerHTML = tableHTML;
      }

      function cancelBooking(bookingKey) {
        if (confirm("Are you sure you want to cancel this booking?")) {
          delete bookings[bookingKey];
          saveData();
          renderBookingsOverview();
          renderClientInterface();
          updateStatistics();
        }
      }

      function exportToCSV() {
        const bookingsList = Object.values(bookings);
        if (bookingsList.length === 0) {
          showStatus("exportStatus", "No bookings to export", "error");
          return;
        }

        const headers = [
          "Name",
          "Email",
          "Phone",
          "Table",
          "Date",
          "Time",
          "Speaker 1",
          "Speaker 2",
          "Booking Time",
        ];

        const csvContent = [
          headers.join(","),
          ...bookingsList.map((booking) =>
            [
              booking.name,
              booking.email,
              booking.phone || "",
              booking.tableName,
              booking.date,
              booking.timeSlot,
              booking.speaker1,
              booking.speaker2,
              new Date(booking.timestamp).toLocaleString(),
            ]
              .map((field) => `"${field}"`)
              .join(",")
          ),
        ].join("\n");

        downloadFile(csvContent, "conversation-bookings.csv", "text/csv");
        showStatus("exportStatus", "CSV exported successfully", "success");
      }

      function exportToExcel() {
        const bookingsList = Object.values(bookings);
        if (bookingsList.length === 0) {
          showStatus("exportStatus", "No bookings to export", "error");
          return;
        }

        const excelContent = [
          "Conversation Table Booking Report",
          `Generated on: ${new Date().toLocaleString()}`,
          `Total Bookings: ${bookingsList.length}`,
          "",
          "Name,Email,Phone,Table,Date,Time,Speaker 1,Speaker 2,Booking Time",
          ...bookingsList.map((booking) =>
            [
              booking.name,
              booking.email,
              booking.phone || "",
              booking.tableName,
              booking.date,
              booking.timeSlot,
              booking.speaker1,
              booking.speaker2,
              new Date(booking.timestamp).toLocaleString(),
            ]
              .map((field) => `"${field}"`)
              .join(",")
          ),
        ].join("\n");

        downloadFile(
          excelContent,
          "conversation-bookings-report.csv",
          "text/csv"
        );
        showStatus(
          "exportStatus",
          "Excel report exported successfully",
          "success"
        );
      }

      function downloadFile(content, filename, mimeType) {
        const blob = new Blob([content], { type: mimeType });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = filename;
        a.click();
        URL.revokeObjectURL(url);
      }

      function showStatus(elementId, message, type) {
        const element = document.getElementById(elementId);
        element.textContent = message;
        element.className = `status-message ${type}`;
        element.style.display = "block";

        setTimeout(() => {
          element.style.display = "none";
        }, 5000);
      }

      // Initialize application
      window.addEventListener("load", function () {
        loadData();
        loadFormData();
        renderClientInterface();
        updateStatistics();

        // Close modals when clicking overlay
        document
          .getElementById("overlay")
          .addEventListener("click", function (e) {
            if (e.target === this) {
              closeBookingForm();
              closePasswordModal();
              closeConfirmationModal();
            }
          });

        // Auto-save on form changes
        ["eventDate", "startTime", "endTime", "slotDuration"].forEach((id) => {
          document.getElementById(id).addEventListener("change", () => {
            setTimeout(saveData, 100);
          });
        });
      });

      // Auto-save periodically
      setInterval(saveData, 30000); // Save every 30 seconds

      // Save data before page unload
      window.addEventListener("beforeunload", saveData);
    </script>
  </body>
</html>
