<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Conversation Table Booking</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        background: #f8f9fa;
        min-height: 100vh;
        padding: 20px;
        color: #333;
        line-height: 1.5;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        border-radius: 8px;
        padding: 40px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      h1 {
        text-align: center;
        margin-bottom: 40px;
        color: #2c3e50;
        font-size: 1.8rem;
        font-weight: 500;
      }

      h2 {
        margin-bottom: 20px;
        color: #34495e;
        font-size: 1.3rem;
        font-weight: 500;
        border-bottom: 1px solid #ecf0f1;
        padding-bottom: 10px;
      }

      h3 {
        margin-bottom: 15px;
        color: #2c3e50;
        font-size: 1.1rem;
        font-weight: 500;
      }

      .section {
        margin-bottom: 30px;
        padding: 20px;
        background: #fafbfc;
        border-radius: 6px;
        border: 1px solid #e1e8ed;
      }

      .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
      }

      .form-group {
        display: flex;
        flex-direction: column;
      }

      label {
        margin-bottom: 5px;
        font-weight: 500;
        color: #555;
        font-size: 0.9rem;
      }

      input,
      select,
      button {
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 0.9rem;
        transition: border-color 0.2s ease;
      }

      input:focus,
      select:focus {
        outline: none;
        border-color: #3498db;
      }

      button {
        background: #3498db;
        color: white;
        border: none;
        cursor: pointer;
        font-weight: 500;
        transition: background-color 0.2s ease;
      }

      button:hover {
        background: #2980b9;
      }

      button:disabled {
        background: #bdc3c7;
        cursor: not-allowed;
      }

      .btn-secondary {
        background: #95a5a6;
      }

      .btn-secondary:hover {
        background: #7f8c8d;
      }

      .btn-danger {
        background: #e74c3c;
      }

      .btn-danger:hover {
        background: #c0392b;
      }

      .btn-success {
        background: #27ae60;
      }

      .btn-success:hover {
        background: #229954;
      }

      .admin-access-btn {
        position: fixed;
        bottom: 20px;
        right: 20px;
        width: 40px;
        height: 40px;
        background: #95a5a6;
        border: none;
        border-radius: 50%;
        cursor: pointer;
        font-size: 14px;
        color: white;
        transition: background-color 0.2s ease;
        z-index: 100;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
      }

      .admin-access-btn:hover {
        background: #7f8c8d;
      }

      .client-booking-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
        gap: 20px;
        margin-top: 20px;
      }

      .client-table-card {
        background: white;
        border-radius: 6px;
        padding: 20px;
        border: 1px solid #e1e8ed;
        transition: box-shadow 0.2s ease;
      }

      .client-table-card:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }

      .table-header {
        text-align: center;
        margin-bottom: 15px;
        padding-bottom: 15px;
        border-bottom: 1px solid #ecf0f1;
      }

      .table-title {
        font-size: 1.1rem;
        font-weight: 500;
        color: #2c3e50;
        margin-bottom: 5px;
      }

      .speakers {
        font-size: 0.9rem;
        color: #7f8c8d;
      }

      .time-slots-container {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .time-slot-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 10px 12px;
        border-radius: 4px;
        border: 1px solid #ddd;
        transition: all 0.2s ease;
      }

      .time-slot-item.available {
        background: #f8fff9;
        border-color: #27ae60;
      }

      .time-slot-item.available:hover {
        background: #e8f5e8;
      }

      .time-slot-item.booked {
        background: #fdf2f2;
        border-color: #e74c3c;
      }

      .time-info {
        font-weight: 500;
        color: #2c3e50;
        font-size: 0.9rem;
      }

      .slot-btn {
        padding: 6px 12px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-weight: 500;
        font-size: 0.8rem;
        transition: background-color 0.2s ease;
      }

      .slot-btn.available {
        background: #27ae60;
        color: white;
      }

      .slot-btn.available:hover {
        background: #229954;
      }

      .slot-btn.booked {
        background: #bdc3c7;
        color: #7f8c8d;
        cursor: not-allowed;
      }

      .modal {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        padding: 25px;
        border-radius: 6px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        z-index: 1000;
        min-width: 350px;
      }

      .overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 999;
      }

      .close-btn {
        position: absolute;
        top: 10px;
        right: 10px;
        background: none;
        border: none;
        font-size: 18px;
        cursor: pointer;
        color: #7f8c8d;
      }

      .status-message {
        padding: 10px;
        border-radius: 4px;
        margin-top: 10px;
        text-align: center;
        font-size: 0.9rem;
      }

      .success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }

      .error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }

      .warning {
        background: #fff3cd;
        color: #856404;
        border: 1px solid #ffeaa7;
      }

      .nav-tabs {
        display: flex;
        margin-bottom: 20px;
        border-bottom: 1px solid #dee2e6;
      }

      .nav-tab {
        padding: 10px 20px;
        background: none;
        border: none;
        border-bottom: 2px solid transparent;
        cursor: pointer;
        font-weight: 500;
        color: #6c757d;
        transition: all 0.2s ease;
      }

      .nav-tab.active {
        color: #3498db;
        border-bottom-color: #3498db;
      }

      .nav-tab:hover {
        color: #3498db;
      }

      .tab-content {
        display: none;
      }

      .tab-content.active {
        display: block;
      }

      .admin-interface {
        display: none;
      }

      .client-interface {
        display: block;
      }

      .tables-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 15px;
        margin-top: 20px;
      }

      .table-card {
        padding: 15px;
        border: 1px solid #e1e8ed;
        border-radius: 6px;
        background: white;
      }

      .bookings-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
        font-size: 0.9rem;
      }

      .bookings-table th,
      .bookings-table td {
        padding: 10px;
        border: 1px solid #dee2e6;
        text-align: left;
      }

      .bookings-table th {
        background: #f8f9fa;
        font-weight: 500;
      }

      .bookings-table tr:nth-child(even) {
        background: #f8f9fa;
      }

      .event-info {
        text-align: center;
        margin-bottom: 20px;
        color: #6c757d;
        font-size: 0.95rem;
      }

      .booking-actions {
        display: flex;
        gap: 10px;
        margin-top: 15px;
      }

      .confirmation-details {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 4px;
        margin: 15px 0;
        border: 1px solid #e9ecef;
      }

      .email-preview {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 4px;
        margin-top: 15px;
        border: 1px solid #e9ecef;
      }

      .hidden {
        display: none;
      }

      .admin-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }

      .password-change-section {
        background: #fff3cd;
        border: 1px solid #ffeaa7;
        padding: 15px;
        border-radius: 4px;
        margin-bottom: 20px;
      }

      .password-change-section h3 {
        color: #856404;
        margin-bottom: 10px;
      }

      .password-form {
        display: flex;
        gap: 10px;
        align-items: end;
      }

      .password-form .form-group {
        flex: 1;
      }

      .connection-status {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 8px 15px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 500;
        z-index: 200;
        transition: all 0.3s ease;
      }

      .connection-status.connected {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }

      .connection-status.disconnected {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }

      .sync-indicator {
        display: inline-block;
        width: 8px;
        height: 8px;
        border-radius: 50%;
        margin-right: 8px;
        animation: pulse 2s infinite;
      }

      .sync-indicator.syncing {
        background: #ffc107;
      }

      .sync-indicator.synced {
        background: #28a745;
      }

      @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.5; }
        100% { opacity: 1; }
      }

      .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.9);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 2000;
        font-size: 1.2rem;
        color: #666;
      }

      .firebase-config-section {
        background: #e7f3ff;
        border: 1px solid #b3d4fc;
        padding: 15px;
        border-radius: 4px;
        margin-bottom: 20px;
      }

      .firebase-config-section h3 {
        color: #0c5aa6;
        margin-bottom: 10px;
      }

      .config-form {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        margin-bottom: 15px;
      }

      .config-form input {
        font-size: 0.8rem;
        padding: 8px;
      }

      .config-actions {
        display: flex;
        gap: 10px;
      }
    </style>
  </head>
  <body>
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
      <div>
        <div class="sync-indicator syncing"></div>
        Initializing Firebase...
      </div>
    </div>

    <!-- Connection Status -->
    <div id="connectionStatus" class="connection-status disconnected">
      <span class="sync-indicator syncing"></span>
      Connecting...
    </div>

    <div class="container">
      <!-- CLIENT INTERFACE -->
      <div id="client-interface" class="client-interface">
        <h1>Conversation Table Booking</h1>
        <div class="event-info" id="eventInfo">Loading event information...</div>
        <div class="client-booking-grid" id="clientBookingGrid">
          Loading booking slots...
        </div>
      </div>

      <!-- ADMIN ACCESS BUTTON -->
      <button
        class="admin-access-btn"
        onclick="showPasswordModal()"
        title="Admin Access"
      >
        ⚙
      </button>

      <!-- ADMIN INTERFACE -->
      <div id="admin-interface" class="admin-interface">
        <div class="admin-header">
          <h1>Admin Dashboard</h1>
          <button onclick="switchToClient()" class="btn-secondary">
            Back to Booking
          </button>
        </div>

        <!-- FIREBASE CONFIGURATION SECTION -->
        <div class="firebase-config-section">
          <h3>Firebase Configuration</h3>
          <p style="margin-bottom: 15px; font-size: 0.9rem; color: #0c5aa6;">
            Configure your Firebase project settings. Leave blank to use demo mode.
          </p>
          <div class="config-form">
            <input type="text" id="firebaseApiKey" placeholder="Firebase API Key" />
            <input type="text" id="firebaseAuthDomain" placeholder="Auth Domain (project-id.firebaseapp.com)" />
            <input type="text" id="firebaseProjectId" placeholder="Project ID" />
            <input type="text" id="firebaseStorageBucket" placeholder="Storage Bucket" />
            <input type="text" id="firebaseMessagingSenderId" placeholder="Messaging Sender ID" />
            <input type="text" id="firebaseAppId" placeholder="App ID" />
          </div>
          <div class="config-actions">
            <button onclick="updateFirebaseConfig()" class="btn-success">Update Configuration</button>
            <button onclick="testFirebaseConnection()" class="btn-secondary">Test Connection</button>
            <button onclick="resetToDemo()" class="btn-secondary">Use Demo Mode</button>
          </div>
          <div id="firebaseConfigStatus" class="status-message" style="display: none"></div>
        </div>

        <!-- PASSWORD CHANGE SECTION -->
        <div class="password-change-section">
          <h3>Change Admin Password</h3>
          <div class="password-form">
            <div class="form-group">
              <label for="currentPassword">Current Password:</label>
              <input
                type="password"
                id="currentPassword"
                placeholder="Enter current password"
              />
            </div>
            <div class="form-group">
              <label for="newPassword">New Password:</label>
              <input
                type="password"
                id="newPassword"
                placeholder="Enter new password"
              />
            </div>
            <div class="form-group">
              <label for="confirmPassword">Confirm Password:</label>
              <input
                type="password"
                id="confirmPassword"
                placeholder="Confirm new password"
              />
            </div>
            <button onclick="changePassword()" class="btn-success">
              Change Password
            </button>
          </div>
          <div
            id="passwordChangeStatus"
            class="status-message"
            style="display: none"
          ></div>
        </div>

        <div class="nav-tabs">
          <button class="nav-tab active" onclick="switchTab('setup')">
            Event Setup
          </button>
          <button class="nav-tab" onclick="switchTab('bookings')">
            Manage Bookings
          </button>
          <button class="nav-tab" onclick="switchTab('export')">
            Export & Reports
          </button>
        </div>

        <div id="setup-tab" class="tab-content active">
          <div class="section">
            <h2>Event Configuration</h2>
            <div class="form-grid">
              <div class="form-group">
                <label for="eventDate">Event Date:</label>
                <input type="date" id="eventDate" />
              </div>
              <div class="form-group">
                <label for="startTime">Start Time:</label>
                <input type="time" id="startTime" value="09:00" />
              </div>
              <div class="form-group">
                <label for="endTime">End Time:</label>
                <input type="time" id="endTime" value="17:00" />
              </div>
              <div class="form-group">
                <label for="slotDuration">Slot Duration (minutes):</label>
                <input
                  type="number"
                  id="slotDuration"
                  value="10"
                  min="5"
                  max="30"
                />
              </div>
            </div>
            <button onclick="generateTimeSlots()">Generate Time Slots</button>
            <div
              id="eventStatus"
              class="status-message"
              style="display: none"
            ></div>
          </div>

          <div class="section">
            <h2>Table Configuration</h2>
            <div class="form-grid">
              <div class="form-group">
                <label for="tableName">Table Name:</label>
                <input
                  type="text"
                  id="tableName"
                  placeholder="e.g., AI & Technology"
                />
              </div>
              <div class="form-group">
                <label for="speaker1">Speaker 1:</label>
                <input type="text" id="speaker1" placeholder="Speaker name" />
              </div>
              <div class="form-group">
                <label for="speaker2">Speaker 2:</label>
                <input type="text" id="speaker2" placeholder="Speaker name" />
              </div>
            </div>
            <button onclick="addTable()">Add Table</button>

            <div class="tables-grid" id="tablesGrid"></div>
          </div>
        </div>

        <div id="bookings-tab" class="tab-content">
          <div class="section">
            <h2>Current Bookings</h2>
            <div id="bookingsOverview">Loading bookings...</div>
          </div>
        </div>

        <div id="export-tab" class="tab-content">
          <div class="section">
            <h2>Export & Reports</h2>
            <button class="btn-success" onclick="exportToCSV()">
              Export to CSV
            </button>
            <button
              class="btn-success"
              onclick="exportToExcel()"
              style="margin-left: 10px"
            >
              Export to Excel
            </button>
            <div
              id="exportStatus"
              class="status-message"
              style="display: none"
            ></div>
          </div>
        </div>
      </div>

      <!-- MODALS -->
      <div class="overlay" id="overlay"></div>

      <!-- PASSWORD MODAL -->
      <div class="modal" id="passwordModal">
        <h3>Admin Access</h3>
        <p>Enter admin password:</p>
        <input
          type="password"
          class="password-input"
          id="adminPassword"
          placeholder="Password"
          onkeypress="if(event.key==='Enter') checkPassword()"
          style="width: 100%; margin: 15px 0"
        />
        <div style="text-align: center">
          <button onclick="checkPassword()" style="margin-right: 10px">
            Access
          </button>
          <button onclick="closePasswordModal()" class="btn-secondary">
            Cancel
          </button>
        </div>
        <div
          id="passwordError"
          class="status-message error"
          style="display: none"
        ></div>
      </div>

      <!-- BOOKING FORM -->
      <div class="modal" id="bookingForm">
        <button class="close-btn" onclick="closeBookingForm()">&times;</button>
        <h3>Book Your Conversation</h3>
        <div class="form-group">
          <label for="userName">Your Name:</label>
          <input type="text" id="userName" required />
        </div>
        <div class="form-group">
          <label for="userEmail">Email:</label>
          <input type="email" id="userEmail" required />
        </div>
        <div class="form-group">
          <label for="userPhone">Phone (optional):</label>
          <input type="tel" id="userPhone" />
        </div>
        <div class="form-group">
          <label>Selected Slot:</label>
          <div id="selectedSlotInfo" class="confirmation-details"></div>
        </div>
        <div class="booking-actions">
          <button onclick="confirmBooking()" id="confirmBookingBtn">Confirm Booking</button>
        </div>
        <div
          id="bookingStatus"
          class="status-message"
          style="display: none"
        ></div>
      </div>

      <!-- CONFIRMATION MODAL -->
      <div class="modal" id="confirmationModal">
        <button class="close-btn" onclick="closeConfirmationModal()">
          &times;
        </button>
        <h3>Booking Confirmed</h3>
        <div id="confirmationDetails"></div>
        <div class="booking-actions">
          <button onclick="addToCalendar()">Add to Calendar</button>
          <button onclick="showEmailPreview()" class="btn-secondary">
            View Email Confirmation
          </button>
        </div>
        <div id="emailPreview" class="email-preview hidden"></div>
      </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <!-- EmailJS SDK -->
    <script
      type="text/javascript"
      src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"
    ></script>

    <script>
      // Firebase and Database Configuration
      let db = null;
      let isFirebaseInitialized = false;
      let isOnline = false;
      let unsubscribeListeners = [];

      // Demo Firebase configuration (you should replace with your own)
      const DEFAULT_FIREBASE_CONFIG = {
        apiKey: "demo-api-key",
        authDomain: "demo-project.firebaseapp.com",
        projectId: "demo-project",
        storageBucket: "demo-project.appspot.com",
        messagingSenderId: "123456789",
        appId: "1:123456789:web:abcdef123456789"
      };

      // EmailJS Configuration
      const EMAILJS_CONFIG = {
        serviceId: "service_0m2owju", // Replace with your EmailJS service ID
        templateId: "template_7xq3pho", // Replace with your EmailJS template ID
        publicKey: "VehBeO9qQGs5TbvvnY", // Replace with your EmailJS public key
      };

      // Global data storage (fallback for offline mode)
      let localData = {
        eventConfig: {
          date: "",
          startTime: "09:00",
          endTime: "17:00",
          slotDuration: 10,
          timeSlots: [],
        },
        tables: [],
        bookings: {},
        adminPassword: "admin123"
      };

      let currentBookingSelection = null;
      let currentBookingConfirmation = null;
      let isAdminMode = false;

      // Initialize Firebase
      async function initializeFirebase(config = null) {
        try {
          updateConnectionStatus('connecting');
          
          const firebaseConfig = config || getStoredFirebaseConfig() || DEFAULT_FIREBASE_CONFIG;
          
          // Initialize Firebase
          if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
          }
          
          db = firebase.firestore();
          
          // Test connection
          await testFirebaseConnection();
          
          isFirebaseInitialized = true;
          isOnline = true;
          updateConnectionStatus('connected');
          
          // Set up real-time listeners
          setupRealtimeListeners();
          
          // Load initial data
          await loadDataFromFirestore();
          
          console.log('Firebase initialized successfully');
          
        } catch (error) {
          console.error('Firebase initialization failed:', error);
          isFirebaseInitialized = false;
          isOnline = false;
          updateConnectionStatus('disconnected');
          
          // Use local storage fallback
          loadDataFromLocalStorage();
          showFirebaseConfigStatus('Firebase connection failed. Using offline mode.', 'warning');
        }
      }

      function getStoredFirebaseConfig() {
        const stored = localStorage.getItem('firebaseConfig');
        return stored ? JSON.parse(stored) : null;
      }

      function storeFirebaseConfig(config) {
        localStorage.setItem('firebaseConfig', JSON.stringify(config));
      }

      async function testFirebaseConnection() {
        if (!db) throw new Error('Firestore not initialized');
        
        // Try to read a document to test connectivity
        await db.collection('system').doc('test').get();
      }

      function updateConnectionStatus(status) {
        const statusElement = document.getElementById('connectionStatus');
        const indicator = statusElement.querySelector('.sync-indicator');
        
        switch (status) {
          case 'connected':
            statusElement.className = 'connection-status connected';
            statusElement.innerHTML = '<span class="sync-indicator synced"></span>Connected';
            break;
          case 'connecting':
            statusElement.className = 'connection-status disconnected';
            statusElement.innerHTML = '<span class="sync-indicator syncing"></span>Connecting...';
            break;
          case 'disconnected':
            statusElement.className = 'connection-status disconnected';
            statusElement.innerHTML = '<span class="sync-indicator"></span>Offline Mode';
            break;
          case 'syncing':
            if (statusElement.className.includes('connected')) {
              indicator.className = 'sync-indicator syncing';
            }
            break;
          case 'synced':
            if (statusElement.className.includes('connected')) {
              indicator.className = 'sync-indicator synced';
            }
            break;
        }
      }

      function setupRealtimeListeners() {
        if (!db) return;

        // Listen to event configuration changes
        const eventConfigRef = db.collection('system').doc('eventConfig');
        const unsubscribeEventConfig = eventConfigRef.onSnapshot((doc) => {
          if (doc.exists) {
            localData.eventConfig = doc.data();
            updateEventUI();
            renderClientInterface();
          }
        }, (error) => {
          console.error('Error listening to event config:', error);
        });

        // Listen to tables changes
        const tablesRef = db.collection('tables');
        const unsubscribeTables = tablesRef.onSnapshot((snapshot) => {
          localData.tables = [];
          snapshot.forEach((doc) => {
            localData.tables.push({ id: doc.id, ...doc.data() });
          });
          localData.tables.sort((a, b) => a.order - b.order);
          renderTables();
          renderClientInterface();
        }, (error) => {
          console.error('Error listening to tables:', error);
        });

        // Listen to bookings changes
        const bookingsRef = db.collection('bookings');
        const unsubscribeBookings = bookingsRef.onSnapshot((snapshot) => {
          localData.bookings = {};
          snapshot.forEach((doc) => {
            localData.bookings[doc.id] = doc.data();
          });
          renderBookingsOverview();
          renderClientInterface();
        }, (error) => {
          console.error('Error listening to bookings:', error);
        });

        // Listen to admin settings
        const adminRef = db.collection('system').doc('admin');
        const unsubscribeAdmin = adminRef.onSnapshot((doc) => {
          if (doc.exists) {
            const adminData = doc.data();
            if (adminData.password) {
              localData.adminPassword = adminData.password;
            }
          }
        }, (error) => {
          console.error('Error listening to admin settings:', error);
        });

        unsubscribeListeners = [unsubscribeEventConfig, unsubscribeTables, unsubscribeBookings, unsubscribeAdmin];
      }

      // Firestore data operations
      async function saveEventConfigToFirestore() {
        if (!db) {
          saveDataToLocalStorage();
          return;
        }

        try {
          updateConnectionStatus('syncing');
          await db.collection('system').doc('eventConfig').set(localData.eventConfig);
          updateConnectionStatus('synced');
        } catch (error) {
          console.error('Error saving event config:', error);
          saveDataToLocalStorage();
        }
      }

      async function saveTableToFirestore(table) {
        if (!db) {
          saveDataToLocalStorage();
          return table.id;
        }

        try {
          updateConnectionStatus('syncing');
          const docRef = await db.collection('tables').add({
            ...table,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
          });
          updateConnectionStatus('synced');
          return docRef.id;
        } catch (error) {
          console.error('Error saving table:', error);
          saveDataToLocalStorage();
          return table.id;
        }
      }

      async function removeTableFromFirestore(tableId) {
        if (!db) {
          saveDataToLocalStorage();
          return;
        }

        try {
          updateConnectionStatus('syncing');
          await db.collection('tables').doc(tableId).delete();
          
          // Remove related bookings
          const bookingsSnapshot = await db.collection('bookings')
            .where('tableId', '==', tableId)
            .get();
          
          const batch = db.batch();
          bookingsSnapshot.forEach((doc) => {
            batch.delete(doc.ref);
          });
          await batch.commit();
          
          updateConnectionStatus('synced');
        } catch (error) {
          console.error('Error removing table:', error);
          saveDataToLocalStorage();
        }
      }

      async function saveBookingToFirestore(bookingKey, booking) {
        if (!db) {
          saveDataToLocalStorage();
          return;
        }

        try {
          updateConnectionStatus('syncing');
          await db.collection('bookings').doc(bookingKey).set({
            ...booking,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
          });
          updateConnectionStatus('synced');
        } catch (error) {
          console.error('Error saving booking:', error);
          saveDataToLocalStorage();
          throw error;
        }
      }

      async function removeBookingFromFirestore(bookingKey) {
        if (!db) {
          saveDataToLocalStorage();
          return;
        }

        try {
          updateConnectionStatus('syncing');
          await db.collection('bookings').doc(bookingKey).delete();
          updateConnectionStatus('synced');
        } catch (error) {
          console.error('Error removing booking:', error);
          saveDataToLocalStorage();
        }
      }

      async function saveAdminPasswordToFirestore(password) {
        if (!db) {
          saveDataToLocalStorage();
          return;
        }

        try {
          updateConnectionStatus('syncing');
          await db.collection('system').doc('admin').set({ password });
          updateConnectionStatus('synced');
        } catch (error) {
          console.error('Error saving admin password:', error);
          saveDataToLocalStorage();
        }
      }

      async function loadDataFromFirestore() {
        if (!db) return;

        try {
          // Load event configuration
          const eventConfigDoc = await db.collection('system').doc('eventConfig').get();
          if (eventConfigDoc.exists) {
            localData.eventConfig = eventConfigDoc.data();
          }

          // Load tables
          const tablesSnapshot = await db.collection('tables').orderBy('order').get();
          localData.tables = [];
          tablesSnapshot.forEach((doc) => {
            localData.tables.push({ id: doc.id, ...doc.data() });
          });

          // Load bookings
          const bookingsSnapshot = await db.collection('bookings').get();
          localData.bookings = {};
          bookingsSnapshot.forEach((doc) => {
            localData.bookings[doc.id] = doc.data();
          });

          // Load admin settings
          const adminDoc = await db.collection('system').doc('admin').get();
          if (adminDoc.exists) {
            const adminData = adminDoc.data();
            if (adminData.password) {
              localData.adminPassword = adminData.password;
            }
          }

          updateUI();
        } catch (error) {
          console.error('Error loading data from Firestore:', error);
          loadDataFromLocalStorage();
        }
      }

      // Local storage fallback
      function saveDataToLocalStorage() {
        localStorage.setItem('bookingSystemData', JSON.stringify(localData));
      }

      function loadDataFromLocalStorage() {
        const stored = localStorage.getItem('bookingSystemData');
        if (stored) {
          localData = { ...localData, ...JSON.parse(stored) };
        }
        updateUI();
      }

      function updateUI() {
        updateEventUI();
        renderTables();
        renderBookingsOverview();
        renderClientInterface();
      }

      function updateEventUI() {
        if (localData.eventConfig.date) {
          document.getElementById('eventDate').value = localData.eventConfig.date;
        }
        document.getElementById('startTime').value = localData.eventConfig.startTime;
        document.getElementById('endTime').value = localData.eventConfig.endTime;
        document.getElementById('slotDuration').value = localData.eventConfig.slotDuration;
      }

      // Firebase configuration management
      function updateFirebaseConfig() {
        const config = {
          apiKey: document.getElementById('firebaseApiKey').value.trim(),
          authDomain: document.getElementById('firebaseAuthDomain').value.trim(),
          projectId: document.getElementById('firebaseProjectId').value.trim(),
          storageBucket: document.getElementById('firebaseStorageBucket').value.trim(),
          messagingSenderId: document.getElementById('firebaseMessagingSenderId').value.trim(),
          appId: document.getElementById('firebaseAppId').value.trim()
        };

        // Validate required fields
        if (!config.projectId || !config.apiKey) {
          showFirebaseConfigStatus('Project ID and API Key are required', 'error');
          return;
        }

        storeFirebaseConfig(config);
        showFirebaseConfigStatus('Configuration saved. Reconnecting...', 'success');

        // Cleanup existing listeners
        unsubscribeListeners.forEach(unsubscribe => unsubscribe());
        unsubscribeListeners = [];

        // Reinitialize Firebase
        setTimeout(() => {
          initializeFirebase(config);
        }, 1000);
      }

      function resetToDemo() {
        localStorage.removeItem('firebaseConfig');
        showFirebaseConfigStatus('Reset to demo mode. Reconnecting...', 'success');
        
        // Clear form
        document.getElementById('firebaseApiKey').value = '';
        document.getElementById('firebaseAuthDomain').value = '';
        document.getElementById('firebaseProjectId').value = '';
        document.getElementById('firebaseStorageBucket').value = '';
        document.getElementById('firebaseMessagingSenderId').value = '';
        document.getElementById('firebaseAppId').value = '';

        // Cleanup existing listeners
        unsubscribeListeners.forEach(unsubscribe => unsubscribe());
        unsubscribeListeners = [];

        // Reinitialize Firebase
        setTimeout(() => {
          initializeFirebase(DEFAULT_FIREBASE_CONFIG);
        }, 1000);
      }

      function showFirebaseConfigStatus(message, type) {
        const element = document.getElementById('firebaseConfigStatus');
        element.textContent = message;
        element.className = `status-message ${type}`;
        element.style.display = 'block';

        setTimeout(() => {
          element.style.display = 'none';
        }, 5000);
      }

      // Original functions with Firestore integration
      function showPasswordModal() {
        document.getElementById("overlay").style.display = "block";
        document.getElementById("passwordModal").style.display = "block";
        document.getElementById("adminPassword").value = "";
        document.getElementById("passwordError").style.display = "none";
        document.getElementById("adminPassword").focus();
      }

      function closePasswordModal() {
        document.getElementById("overlay").style.display = "none";
        document.getElementById("passwordModal").style.display = "none";
      }

      function checkPassword() {
        const enteredPassword = document.getElementById("adminPassword").value;

        if (enteredPassword === localData.adminPassword) {
          isAdminMode = true;
          closePasswordModal();
          switchToAdmin();
        } else {
          document.getElementById("passwordError").textContent = "Incorrect password";
          document.getElementById("passwordError").style.display = "block";
          document.getElementById("adminPassword").value = "";
        }
      }

      async function changePassword() {
        const currentPwd = document.getElementById("currentPassword").value;
        const newPwd = document.getElementById("newPassword").value;
        const confirmPwd = document.getElementById("confirmPassword").value;

        if (!currentPwd || !newPwd || !confirmPwd) {
          showPasswordChangeStatus("Please fill in all fields", "error");
          return;
        }

        if (currentPwd !== localData.adminPassword) {
          showPasswordChangeStatus("Current password is incorrect", "error");
          return;
        }

        if (newPwd !== confirmPwd) {
          showPasswordChangeStatus("New passwords do not match", "error");
          return;
        }

        if (newPwd.length < 6) {
          showPasswordChangeStatus("Password must be at least 6 characters", "error");
          return;
        }

        localData.adminPassword = newPwd;
        await saveAdminPasswordToFirestore(newPwd);
        showPasswordChangeStatus("Password changed successfully", "success");

        // Clear form
        document.getElementById("currentPassword").value = "";
        document.getElementById("newPassword").value = "";
        document.getElementById("confirmPassword").value = "";
      }

      function showPasswordChangeStatus(message, type) {
        const element = document.getElementById("passwordChangeStatus");
        element.textContent = message;
        element.className = `status-message ${type}`;
        element.style.display = "block";

        setTimeout(() => {
          element.style.display = "none";
        }, 5000);
      }

      function switchToAdmin() {
        document.getElementById("client-interface").style.display = "none";
        document.getElementById("admin-interface").style.display = "block";
        
        // Load current Firebase config into form
        const config = getStoredFirebaseConfig();
        if (config) {
          document.getElementById('firebaseApiKey').value = config.apiKey || '';
          document.getElementById('firebaseAuthDomain').value = config.authDomain || '';
          document.getElementById('firebaseProjectId').value = config.projectId || '';
          document.getElementById('firebaseStorageBucket').value = config.storageBucket || '';
          document.getElementById('firebaseMessagingSenderId').value = config.messagingSenderId || '';
          document.getElementById('firebaseAppId').value = config.appId || '';
        }
        
        renderBookingsOverview();
      }

      function switchToClient() {
        isAdminMode = false;
        document.getElementById("client-interface").style.display = "block";
        document.getElementById("admin-interface").style.display = "none";
        renderClientInterface();
      }

      function switchTab(tabName) {
        // Update nav tabs
        document.querySelectorAll(".nav-tab").forEach((tab) => tab.classList.remove("active"));
        document.querySelector(`[onclick="switchTab('${tabName}')"]`).classList.add("active");

        // Update tab content
        document.querySelectorAll(".tab-content").forEach((content) => content.classList.remove("active"));
        document.getElementById(`${tabName}-tab`).classList.add("active");

        if (tabName === "bookings") {
          renderBookingsOverview();
        }
      }

      async function generateTimeSlots() {
        const date = document.getElementById("eventDate").value;
        const startTime = document.getElementById("startTime").value;
        const endTime = document.getElementById("endTime").value;
        const duration = parseInt(document.getElementById("slotDuration").value);

        if (!date || !startTime || !endTime) {
          showStatus("eventStatus", "Please fill in all fields", "error");
          return;
        }

        localData.eventConfig.date = date;
        localData.eventConfig.startTime = startTime;
        localData.eventConfig.endTime = endTime;
        localData.eventConfig.slotDuration = duration;

        // Generate time slots
        const slots = [];
        const start = new Date(`${date}T${startTime}`);
        const end = new Date(`${date}T${endTime}`);

        let current = new Date(start);
        let slotIndex = 0;

        while (current < end) {
          const slotEnd = new Date(current.getTime() + duration * 60000);
          if (slotEnd <= end) {
            slots.push({
              index: slotIndex++,
              start: current.toTimeString().slice(0, 5),
              end: slotEnd.toTimeString().slice(0, 5),
              startTime: current.toISOString(),
              endTime: slotEnd.toISOString(),
            });
          }
          current = new Date(slotEnd);
        }

        localData.eventConfig.timeSlots = slots;
        await saveEventConfigToFirestore();
        
        showStatus("eventStatus", `Generated ${slots.length} time slots from ${startTime} to ${endTime}`, "success");
      }

      async function addTable() {
        const name = document.getElementById("tableName").value.trim();
        const speaker1 = document.getElementById("speaker1").value.trim();
        const speaker2 = document.getElementById("speaker2").value.trim();

        if (!name || !speaker1 || !speaker2) {
          alert("Please fill in all table fields");
          return;
        }

        if (localData.tables.length >= 20) {
          alert("Maximum of 20 tables allowed");
          return;
        }

        const table = {
          name: name,
          speaker1: speaker1,
          speaker2: speaker2,
          order: localData.tables.length
        };

        const tableId = await saveTableToFirestore(table);
        
        if (!db) {
          // Fallback for offline mode
          table.id = `table_${Date.now()}`;
          localData.tables.push(table);
          renderTables();
        }

        // Clear form
        document.getElementById("tableName").value = "";
        document.getElementById("speaker1").value = "";
        document.getElementById("speaker2").value = "";
      }

      function renderTables() {
        const grid = document.getElementById("tablesGrid");
        grid.innerHTML = localData.tables.map((table, index) => `
          <div class="table-card">
            <h4>Table ${index + 1}: ${table.name}</h4>
            <p><strong>Speakers:</strong> ${table.speaker1} & ${table.speaker2}</p>
            <button onclick="removeTable('${table.id}')" class="btn-danger" style="margin-top: 10px;">Remove</button>
          </div>
        `).join("");
      }

      async function removeTable(tableId) {
        if (confirm("Are you sure you want to remove this table and all its bookings?")) {
          await removeTableFromFirestore(tableId);
          
          if (!db) {
            // Fallback for offline mode
            localData.tables = localData.tables.filter((table) => table.id !== tableId);
            // Remove related bookings
            Object.keys(localData.bookings).forEach((key) => {
              if (localData.bookings[key].tableId === tableId) {
                delete localData.bookings[key];
              }
            });
            renderTables();
            saveDataToLocalStorage();
          }
        }
      }

      function renderClientInterface() {
        // Update event info
        const eventInfo = document.getElementById("eventInfo");
        if (localData.eventConfig.date && localData.eventConfig.timeSlots.length > 0) {
          const eventDate = new Date(localData.eventConfig.date).toLocaleDateString("en-US", {
            weekday: "long",
            year: "numeric",
            month: "long",
            day: "numeric",
          });
          eventInfo.innerHTML = `
            <strong>${eventDate}</strong><br>
            ${localData.eventConfig.startTime} - ${localData.eventConfig.endTime} | ${localData.eventConfig.slotDuration} minutes per session
          `;
        } else {
          eventInfo.innerHTML = "Event not configured yet";
        }

        const container = document.getElementById("clientBookingGrid");

        if (localData.tables.length === 0 || localData.eventConfig.timeSlots.length === 0) {
          container.innerHTML = "<p>No tables available for booking at this time.</p>";
          return;
        }

        container.innerHTML = localData.tables.map((table, tableIndex) => `
          <div class="client-table-card">
            <div class="table-header">
              <div class="table-title">${table.name}</div>
              <div class="speakers">with ${table.speaker1} & ${table.speaker2}</div>
            </div>
            <div class="time-slots-container">
              ${localData.eventConfig.timeSlots.map((slot) => {
                const bookingKey = `${table.id}-${slot.index}`;
                const isBooked = localData.bookings[bookingKey];
                return `
                  <div class="time-slot-item ${isBooked ? "booked" : "available"}">
                    <div class="time-info">${slot.start} - ${slot.end}</div>
                    <button class="slot-btn ${isBooked ? "booked" : "available"}" 
                            ${!isBooked ? `onclick="openBookingForm('${table.id}', ${slot.index})"` : ""}
                            ${isBooked ? "disabled" : ""}>
                      ${isBooked ? "Booked" : "Book"}
                    </button>
                  </div>
                `;
              }).join("")}
            </div>
          </div>
        `).join("");
      }

      function openBookingForm(tableId, slotIndex) {
        const table = localData.tables.find((t) => t.id === tableId);
        const slot = localData.eventConfig.timeSlots.find((s) => s.index === slotIndex);

        if (!table || !slot) {
          alert("Error: Table or slot not found");
          return;
        }

        currentBookingSelection = { tableId, slotIndex };

        const eventDate = new Date(localData.eventConfig.date).toLocaleDateString("en-US", {
          weekday: "long",
          year: "numeric",
          month: "long",
          day: "numeric",
        });

        document.getElementById("selectedSlotInfo").innerHTML = `
          <strong>${table.name}</strong><br>
          ${eventDate}<br>
          ${slot.start} - ${slot.end}<br>
          Speakers: ${table.speaker1} & ${table.speaker2}
        `;

        document.getElementById("overlay").style.display = "block";
        document.getElementById("bookingForm").style.display = "block";
        document.getElementById("userName").value = "";
        document.getElementById("userEmail").value = "";
        document.getElementById("userPhone").value = "";
        document.getElementById("bookingStatus").style.display = "none";
      }

      function closeBookingForm() {
        document.getElementById("overlay").style.display = "none";
        document.getElementById("bookingForm").style.display = "none";
        currentBookingSelection = null;
      }

      async function confirmBooking() {
        const name = document.getElementById("userName").value.trim();
        const email = document.getElementById("userEmail").value.trim();
        const phone = document.getElementById("userPhone").value.trim();

        if (!name || !email) {
          showStatus("bookingStatus", "Please fill in name and email", "error");
          return;
        }

        if (!currentBookingSelection) {
          showStatus("bookingStatus", "No slot selected", "error");
          return;
        }

        const { tableId, slotIndex } = currentBookingSelection;
        const bookingKey = `${tableId}-${slotIndex}`;

        if (localData.bookings[bookingKey]) {
          showStatus("bookingStatus", "This slot is already booked", "error");
          return;
        }

        const table = localData.tables.find((t) => t.id === tableId);
        const slot = localData.eventConfig.timeSlots.find((s) => s.index === slotIndex);

        const booking = {
          name: name,
          email: email,
          phone: phone,
          tableId: tableId,
          slotIndex: slotIndex,
          tableName: table.name,
          speaker1: table.speaker1,
          speaker2: table.speaker2,
          timeSlot: `${slot.start} - ${slot.end}`,
          date: localData.eventConfig.date,
          timestamp: new Date().toISOString(),
        };

        // Disable the confirm button to prevent double booking
        const confirmBtn = document.getElementById('confirmBookingBtn');
        confirmBtn.disabled = true;
        confirmBtn.textContent = 'Processing...';

        try {
          // Show loading state
          showStatus("bookingStatus", "Saving booking...", "success");

          // Save to Firestore first
          await saveBookingToFirestore(bookingKey, booking);
          
          // Update local data for immediate UI update
          localData.bookings[bookingKey] = booking;
          currentBookingConfirmation = booking;

          // Send email using EmailJS
          const eventDate = new Date(booking.date).toLocaleDateString("en-US", {
            weekday: "long",
            year: "numeric",
            month: "long",
            day: "numeric",
          });

          showStatus("bookingStatus", "Sending confirmation email...", "success");

          const emailParams = {
            user_name: booking.name,
            user_email: booking.email,
            table_name: booking.tableName,
            speakers: `${booking.speaker1} & ${booking.speaker2}`,
            event_date: eventDate,
            time_slot: booking.timeSlot,
            to_email: booking.email,
          };

          try {
            await emailjs.send(
              EMAILJS_CONFIG.serviceId,
              EMAILJS_CONFIG.templateId,
              emailParams,
              EMAILJS_CONFIG.publicKey
            );
            console.log("Email sent successfully");
          } catch (emailError) {
            console.log("Email sending failed:", emailError);
            showStatus("bookingStatus", "Booking saved, but email confirmation failed to send", "warning");
          }

          closeBookingForm();
          showConfirmationModal();
          
        } catch (error) {
          console.error('Booking failed:', error);
          showStatus("bookingStatus", "Booking failed. Please try again.", "error");
        } finally {
          // Re-enable the confirm button
          confirmBtn.disabled = false;
          confirmBtn.textContent = 'Confirm Booking';
        }
      }

      function showConfirmationModal() {
        const booking = currentBookingConfirmation;
        const eventDate = new Date(booking.date).toLocaleDateString("en-US", {
          weekday: "long",
          year: "numeric",
          month: "long",
          day: "numeric",
        });

        document.getElementById("confirmationDetails").innerHTML = `
          <div class="confirmation-details">
            <strong>Booking Details:</strong><br>
            <strong>Name:</strong> ${booking.name}<br>
            <strong>Email:</strong> ${booking.email}<br>
            ${booking.phone ? `<strong>Phone:</strong> ${booking.phone}<br>` : ""}
            <strong>Table:</strong> ${booking.tableName}<br>
            <strong>Speakers:</strong> ${booking.speaker1} & ${booking.speaker2}<br>
            <strong>Date:</strong> ${eventDate}<br>
            <strong>Time:</strong> ${booking.timeSlot}
          </div>
        `;

        document.getElementById("overlay").style.display = "block";
        document.getElementById("confirmationModal").style.display = "block";
      }

      function closeConfirmationModal() {
        document.getElementById("overlay").style.display = "none";
        document.getElementById("confirmationModal").style.display = "none";
        document.getElementById("emailPreview").classList.add("hidden");
      }

      function addToCalendar() {
        const booking = currentBookingConfirmation;
        const eventDate = new Date(booking.date);
        const [startHour, startMinute] = booking.timeSlot.split(" - ")[0].split(":");
        const [endHour, endMinute] = booking.timeSlot.split(" - ")[1].split(":");

        const startTime = new Date(eventDate);
        startTime.setHours(parseInt(startHour), parseInt(startMinute));

        const endTime = new Date(eventDate);
        endTime.setHours(parseInt(endHour), parseInt(endMinute));

        const event = {
          title: `Conversation Table: ${booking.tableName}`,
          start: startTime,
          end: endTime,
          description: `Conversation with ${booking.speaker1} & ${booking.speaker2}`,
          location: "Event Venue",
        };

        const icsContent = `BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//Your Company//Event//EN
BEGIN:VEVENT
UID:${Date.now()}@yourcompany.com
DTSTAMP:${new Date().toISOString().replace(/[-:]/g, "").split(".")[0]}Z
DTSTART:${startTime.toISOString().replace(/[-:]/g, "").split(".")[0]}Z
DTEND:${endTime.toISOString().replace(/[-:]/g, "").split(".")[0]}Z
SUMMARY:${event.title}
DESCRIPTION:${event.description}
LOCATION:${event.location}
END:VEVENT
END:VCALENDAR`;

        const blob = new Blob([icsContent], { type: "text/calendar" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "conversation-booking.ics";
        a.click();
        URL.revokeObjectURL(url);
      }

      function showEmailPreview() {
        const booking = currentBookingConfirmation;
        const eventDate = new Date(booking.date).toLocaleDateString("en-US", {
          weekday: "long",
          year: "numeric",
          month: "long",
          day: "numeric",
        });

        const emailContent = `
          <h4>Email Confirmation Preview</h4>
          <div style="border: 1px solid #ddd; padding: 15px; background: white; margin-top: 10px;">
            <strong>Subject:</strong> Conversation Table Booking Confirmed<br><br>
            <strong>Dear ${booking.name},</strong><br><br>
            
            Your booking has been confirmed.<br><br>
            
            <strong>Event Details:</strong><br>
            Date: ${eventDate}<br>
            Time: ${booking.timeSlot}<br>
            Table: ${booking.tableName}<br>
            Speakers: ${booking.speaker1} & ${booking.speaker2}<br><br>
            
            Please arrive 5 minutes before your scheduled time.<br><br>
            
            Best regards,<br>
            Event Team
          </div>
          <p style="font-size: 0.9rem; color: #666; margin-top: 10px;">
            <em>Note: This is a preview. The actual email was sent to ${booking.email}</em>
          </p>
        `;

        document.getElementById("emailPreview").innerHTML = emailContent;
        document.getElementById("emailPreview").classList.remove("hidden");
      }

      function renderBookingsOverview() {
        const container = document.getElementById("bookingsOverview");
        const bookingsList = Object.values(localData.bookings);

        if (bookingsList.length === 0) {
          container.innerHTML = "<p>No bookings yet.</p>";
          return;
        }

        const tableHTML = `
          <table class="bookings-table">
            <thead>
              <tr>
                <th>Name</th>
                <th>Email</th>
                <th>Phone</th>
                <th>Table</th>
                <th>Date</th>
                <th>Time</th>
                <th>Speakers</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              ${bookingsList.map((booking) => {
                const bookingKey = `${booking.tableId}-${booking.slotIndex}`;
                return `
                  <tr>
                    <td>${booking.name}</td>
                    <td>${booking.email}</td>
                    <td>${booking.phone || "N/A"}</td>
                    <td>${booking.tableName}</td>
                    <td>${new Date(booking.date).toLocaleDateString()}</td>
                    <td>${booking.timeSlot}</td>
                    <td>${booking.speaker1} & ${booking.speaker2}</td>
                    <td>
                      <button onclick="cancelBooking('${bookingKey}')" 
                              class="btn-danger" style="padding: 5px 10px; font-size: 12px;">
                        Cancel
                      </button>
                    </td>
                  </tr>
                `;
              }).join("")}
            </tbody>
          </table>
        `;

        container.innerHTML = tableHTML;
      }

      async function cancelBooking(bookingKey) {
        if (confirm("Are you sure you want to cancel this booking?")) {
          await removeBookingFromFirestore(bookingKey);
          
          if (!db) {
            // Fallback for offline mode
            delete localData.bookings[bookingKey];
            renderBookingsOverview();
            renderClientInterface();
            saveDataToLocalStorage();
          }
        }
      }

      function exportToCSV() {
        const bookingsList = Object.values(localData.bookings);
        if (bookingsList.length === 0) {
          showStatus("exportStatus", "No bookings to export", "error");
          return;
        }

        const headers = [
          "Name", "Email", "Phone", "Table", "Date", "Time", 
          "Speaker 1", "Speaker 2", "Booking Time"
        ];
        
        const csvContent = [
          headers.join(","),
          ...bookingsList.map((booking) =>
            [
              booking.name,
              booking.email,
              booking.phone || "",
              booking.tableName,
              booking.date,
              booking.timeSlot,
              booking.speaker1,
              booking.speaker2,
              new Date(booking.timestamp).toLocaleString(),
            ].map((field) => `"${field}"`).join(",")
          ),
        ].join("\n");

        downloadFile(csvContent, "conversation-bookings.csv", "text/csv");
        showStatus("exportStatus", "CSV exported successfully", "success");
      }

      function exportToExcel() {
        const bookingsList = Object.values(localData.bookings);
        if (bookingsList.length === 0) {
          showStatus("exportStatus", "No bookings to export", "error");
          return;
        }

        const excelContent = [
          "Conversation Table Booking Report",
          `Generated on: ${new Date().toLocaleString()}`,
          `Total Bookings: ${bookingsList.length}`,
          `Connection Status: ${isOnline ? 'Online' : 'Offline'}`,
          "",
          "Name,Email,Phone,Table,Date,Time,Speaker 1,Speaker 2,Booking Time",
          ...bookingsList.map((booking) =>
            [
              booking.name,
              booking.email,
              booking.phone || "",
              booking.tableName,
              booking.date,
              booking.timeSlot,
              booking.speaker1,
              booking.speaker2,
              new Date(booking.timestamp).toLocaleString(),
            ].map((field) => `"${field}"`).join(",")
          ),
        ].join("\n");

        downloadFile(excelContent, "conversation-bookings-report.csv", "text/csv");
        showStatus("exportStatus", "Excel report exported successfully", "success");
      }

      function downloadFile(content, filename, mimeType) {
        const blob = new Blob([content], { type: mimeType });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = filename;
        a.click();
        URL.revokeObjectURL(url);
      }

      function showStatus(elementId, message, type) {
        const element = document.getElementById(elementId);
        element.textContent = message;
        element.className = `status-message ${type}`;
        element.style.display = "block";

        setTimeout(() => {
          element.style.display = "none";
        }, 5000);
      }

      // Initialize EmailJS
      (function() {
        if (typeof emailjs !== 'undefined') {
          emailjs.init(EMAILJS_CONFIG.publicKey);
        }
      })();

      // Initialize application
      window.addEventListener("load", async function () {
        // Set default date to today
        document.getElementById("eventDate").value = new Date().toISOString().split("T")[0];

        // Initialize Firebase
        await initializeFirebase();
        
        // Hide loading overlay
        document.getElementById('loadingOverlay').style.display = 'none';

        // Generate default time slots if none exist
        if (localData.eventConfig.timeSlots.length === 0) {
          await generateTimeSlots();
        }

        // Close modals when clicking overlay
        document.getElementById("overlay").addEventListener("click", function () {
          closeBookingForm();
          closePasswordModal();
          closeConfirmationModal();
        });

        // Handle online/offline events
        window.addEventListener('online', () => {
          if (isFirebaseInitialized) {
            updateConnectionStatus('connected');
            isOnline = true;
          }
        });

        window.addEventListener('offline', () => {
          updateConnectionStatus('disconnected');
          isOnline = false;
        });
      });

      // Cleanup listeners before page unload
      window.addEventListener('beforeunload', () => {
        unsubscribeListeners.forEach(unsubscribe => unsubscribe());
      });
    </script>
  </body>
</html>
